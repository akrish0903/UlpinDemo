<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tilangpur Kotla Village - Interactive Map</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script>
      let createBuildingFeatures = null;

      fetch("data/createBuilding.geojson")
        .then((res) => res.json())
        .then((data) => {
          createBuildingFeatures = data.features; // <-- IMPORTANT
          console.log(
            "Building Features Loaded:",
            createBuildingFeatures.length
          );
        })
        .catch((err) => console.error("Error loading building geojson:", err));
    </script>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        overflow-x: hidden;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }
      .control-group {
        margin-bottom: 10px;
        padding-right: 10px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      select,
      input {
        width: 100%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
      }
      .info-panel {
        position: absolute;
        top: 10px;
        right: 40px;
        background: white;
        padding: 15px;
        padding-bottom: 2px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        max-width: 300px;
      }
      .info-panel h3 {
        margin-top: 0;
        color: #333;
        font-size: 15px;
      }
      .info-item {
        margin-bottom: 6px;
      }
      .info-label {
        font-weight: bold;
        color: #666;
        font-size: 12.5px;
      }
      .info-value {
        color: #333;
        font-size: 12.5px;
      }

      /* Ownership Document Modal Styles */
      .ownership-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .ownership-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-height: 80vh;
        overflow-y: auto;
      }
      .ownership-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .ownership-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }
      .close-ownership {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
      }
      .close-ownership:hover {
        color: #000;
      }
      .ownership-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }
      .ownership-section h3 {
        margin: 0 0 10px 0;
        color: #007bff;
        font-size: 18px;
      }
      .ownership-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .ownership-item {
        display: flex;
        flex-direction: column;
      }
      .ownership-label {
        font-weight: bold;
        color: #555;
        margin-bottom: 5px;
        font-size: 14px;
      }
      .ownership-value {
        color: #333;
        font-size: 16px;
        padding: 8px;
        background: white;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .ownership-document {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
      }
      .ownership-document h4 {
        color: #856404;
        margin: 0 0 10px 0;
      }
      .document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #ffeaa7;
      }
      .document-item:last-child {
        border-bottom: none;
      }
      .document-name {
        font-weight: 500;
        color: #856404;
      }
      .document-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }
      .status-verified {
        background: #d4edda;
        color: #155724;
      }
      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-expired {
        background: #f8d7da;
        color: #721c24;
      }
      .ownership-actions {
        margin-top: 20px;
        text-align: center;
      }
      .ownership-btn {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 0 10px;
        font-size: 14px;
      }
      .ownership-btn:hover {
        background: #0056b3;
      }
      .ownership-btn.secondary {
        background: #6c757d;
      }
      .ownership-btn.secondary:hover {
        background: #545b62;
      }
      /* Owner Entry Modal Styles */
      .owner-entry-modal {
        display: none;
        position: fixed;
        z-index: 2100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }
      .owner-entry-content {
        background: #fff;
        margin: 2% auto;
        padding: 16px;
        border-radius: 10px;
        width: 90%;
        max-width: 960px;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      .owner-entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #ddd;
        padding-bottom: 8px;
        margin-bottom: 12px;
      }
      .owner-entry-title {
        font-size: 22px;
        font-weight: bold;
      }
      .close-owner-entry {
        cursor: pointer;
        font-size: 26px;
        color: #888;
      }
      .close-owner-entry:hover {
        color: #000;
      }
      .entry-section {
        margin: 12px 0;
        padding: 12px;
        background: #f8f9fa;
        border-left: 4px solid #28a745;
        border-radius: 8px;
      }
      .entry-section h3 {
        margin: 0 0 8px 0;
        color: #28a745;
        font-size: 18px;
      }
      .entry-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 14px;
      }
      .entry-item {
        display: flex;
        flex-direction: column;
      }
      .entry-item label {
        font-weight: bold;
        color: #555;
        margin-bottom: 4px;
        font-size: 13px;
      }
      .entry-item input,
      .entry-item select,
      .entry-item textarea {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
      }
      .entry-actions {
        text-align: center;
        margin-top: 14px;
      }
      .entry-btn {
        background: #28a745;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 10px 16px;
        margin: 0 6px;
        cursor: pointer;
      }
      .entry-btn.secondary {
        background: #6c757d;
      }
      .entry-inline-btn {
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        background: #007bff;
        color: #fff;
      }
      .entry-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .entry-card {
        border: 1px solid #ddd;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
        background: #fff;
      }
      .entry-note {
        font-size: 12px;
        color: #666;
      }
      .thumb {
        border: 1px solid #ccc;
        border-radius: 6px;
        width: 160px;
        height: 120px;
        object-fit: cover;
        background: #eee;
      }
      #signature-pad {
        border: 1px solid #ccc;
        border-radius: 6px;
        width: 100%;
        max-width: 420px;
        height: 160px;
        display: block;
        touch-action: none;
      }
      /* Floor layout UI */
      .floor-layout {
        margin-top: 15px;
        border-top: 1px solid #ddd;
        padding-top: 15px;
        display: none;
      }
      .floor-selector {
        margin-bottom: 10px;
      }
      .floor-selector select {
        width: 100%;
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      .floor-plan {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        position: relative;
        height: 200px;
        overflow: hidden;
      }
      .floor-plan-canvas {
        width: 100%;
        height: 100%;
        border: 1px solid #ccc;
        background: white;
      }
      .room-info {
        margin-top: 10px;
        font-size: 12px;
      }
      .room-type {
        display: inline-block;
        margin: 2px;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        color: white;
      }
      .room-office {
        background: #4a90e2;
      }
      .room-meeting {
        background: #e74c3c;
      }
      .room-lobby {
        background: #27ae60;
      }
      .room-elevator {
        background: #f39c12;
      }
      .room-stairs {
        background: #9b59b6;
      }
      .room-bathroom {
        background: #34495e;
      }
      .room-kitchen {
        background: #e67e22;
      }
      .room-reception {
        background: #16a085;
      }
      .room-waiting {
        background: #95a5a6;
      }
      .room-security {
        background: #c0392b;
      }
      .room-storage {
        background: #7f8c8d;
      }
      .room-breakroom {
        background: #f1c40f;
      }
      .room-utility {
        background: #8e44ad;
      }
      .room-pantry {
        background: #d35400;
      }
      .room-gym {
        background: #e91e63;
      }
      .room-lounge {
        background: #00bcd4;
      }
      .room-shower {
        background: #607d8b;
      }
      .room-executive {
        background: #9c27b0;
      }
      .room-boardroom {
        background: #ff5722;
      }
      .room-penthouse {
        background: #ff9800;
      }
      .room-bedroom {
        background: #795548;
      }
      .room-dining {
        background: #4caf50;
      }
      .room-terrace {
        background: #8bc34a;
      }
      .floor-indicator {
        position: absolute;
        top: 50%;
        right: 20px;
        /* transform: translateY(-50%); */
        /* background: rgba(255, 255, 255, 0.9); */
        background-color: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        /* z-index: 2; */
        text-align: center;
        display: none;
      }
      .floor-number {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }
      .floor-label {
        font-size: 12px;
        color: #666;
      }
      .floor-legend {
        margin-top: 15px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 5px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .floor-legend h5 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #333;
        text-align: center;
      }
      .section-disabled {
        opacity: 0.5;
      }
      /* Floor Layout Designer Modal Styles */
      .floor-designer-modal {
        display: none;
        position: fixed;
        z-index: 6000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
      }
      .floor-designer-content {
        background: #fff;
        margin: 2% auto;
        padding: 0;
        border-radius: 12px;
        width: 95%;
        max-width: 1400px;
        height: 90vh;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
      }
      .floor-designer-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .floor-designer-title {
        font-size: 20px;
        font-weight: bold;
      }
      .close-floor-designer {
        cursor: pointer;
        font-size: 28px;
        color: white;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
      }
      .close-floor-designer:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      .floor-designer-body {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      .floor-designer-toolbar {
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        padding: 16px;
        width: 280px;
        overflow-y: auto;
      }
      .toolbar-section {
        margin-bottom: 20px;
      }
      .toolbar-section h4 {
        margin: 0 0 12px 0;
        color: #495057;
        font-size: 14px;
        font-weight: bold;
      }
      .grid-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }
      .grid-controls input {
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 12px;
      }
      .toolbar-btn {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        margin: 2px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
      }
      .toolbar-btn:hover {
        background: #0056b3;
      }
      .toolbar-btn.secondary {
        background: #6c757d;
      }
      .toolbar-btn.secondary:hover {
        background: #545b62;
      }
      .toolbar-btn.danger {
        background: #dc3545;
      }
      .toolbar-btn.danger:hover {
        background: #c82333;
      }
      .room-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-bottom: 12px;
      }
      .room-type-btn {
        padding: 8px 6px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 11px;
        text-align: center;
        transition: all 0.3s;
        color: #495057;
      }
      .room-type-btn:hover {
        background: #e9ecef;
        border-color: #adb5bd;
      }
      .room-type-btn.selected {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }
      .room-type-btn.office {
        border-left: 4px solid #4a90e2;
      }
      .room-type-btn.meeting {
        border-left: 4px solid #e74c3c;
      }
      .room-type-btn.lobby {
        border-left: 4px solid #27ae60;
      }
      .room-type-btn.reception {
        border-left: 4px solid #16a085;
      }
      .room-type-btn.elevator {
        border-left: 4px solid #f39c12;
      }
      .room-type-btn.stairs {
        border-left: 4px solid #9b59b6;
      }
      .room-type-btn.bathroom {
        border-left: 4px solid #34495e;
      }
      .room-type-btn.kitchen {
        border-left: 4px solid #e67e22;
      }
      .room-type-btn.waiting {
        border-left: 4px solid #95a5a6;
      }
      .room-type-btn.security {
        border-left: 4px solid #c0392b;
      }
      .room-type-btn.storage {
        border-left: 4px solid #7f8c8d;
      }
      .room-type-btn.breakroom {
        border-left: 4px solid #f1c40f;
      }
      .room-type-btn.utility {
        border-left: 4px solid #8e44ad;
      }
      .room-type-btn.pantry {
        border-left: 4px solid #d35400;
      }
      .room-type-btn.gym {
        border-left: 4px solid #e91e63;
      }
      .room-type-btn.lounge {
        border-left: 4px solid #00bcd4;
      }
      .room-type-btn.shower {
        border-left: 4px solid #607d8b;
      }
      .room-type-btn.executive {
        border-left: 4px solid #9c27b0;
      }
      .room-type-btn.boardroom {
        border-left: 4px solid #ff5722;
      }
      .room-type-btn.penthouse {
        border-left: 4px solid #ff9800;
      }
      .room-type-btn.bedroom {
        border-left: 4px solid #795548;
      }
      .room-type-btn.dining {
        border-left: 4px solid #4caf50;
      }
      .room-type-btn.terrace {
        border-left: 4px solid #8bc34a;
      }
      .room-type-btn.custom {
        border-left: 4px solid #6c757d;
      }
      .room-properties {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
      }
      .room-properties input,
      .room-properties textarea {
        width: 100%;
        padding: 6px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 12px;
        margin-bottom: 8px;
      }
      .room-properties label {
        font-size: 11px;
        color: #6c757d;
        margin-bottom: 4px;
        display: block;
      }
      .floor-designer-canvas-container {
        flex: 1;
        background: #f8f9fa;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      .canvas-toolbar {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 16px;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .canvas-toolbar button {
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
      }
      .canvas-toolbar button:hover {
        background: #e9ecef;
      }
      .canvas-toolbar button.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }
      .floor-designer-canvas {
        flex: 1;
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }
      .floor-designer-footer {
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .floor-designer-footer button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
      }
      .floor-designer-footer .save-btn {
        background: #28a745;
        color: white;
      }
      .floor-designer-footer .save-btn:hover {
        background: #218838;
      }
      .floor-designer-footer .cancel-btn {
        background: #6c757d;
        color: white;
      }
      .floor-designer-footer .cancel-btn:hover {
        background: #545b62;
      }
      .floor-designer-footer .clear-btn {
        background: #dc3545;
        color: white;
      }
      .floor-designer-footer .clear-btn:hover {
        background: #c82333;
      }
      .grid-cell {
        position: absolute;
        border: 1px solid #e9ecef;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.2s;
      }
      .grid-cell:hover {
        background: #e9ecef;
        border-color: #adb5bd;
      }
      .grid-cell.selected {
        background: #007bff;
        border-color: #007bff;
        color: white;
      }
      .room-block {
        position: absolute;
        border: 2px solid #495057;
        border-radius: 4px;
        cursor: move;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        text-align: center;
        word-wrap: break-word;
        padding: 2px;
      }
      .room-block:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .room-block.selected {
        border-color: #007bff;
        border-width: 3px;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
      }
      .room-block.office {
        background: #4a90e2;
      }
      .room-block.meeting {
        background: #e74c3c;
      }
      .room-block.lobby {
        background: #27ae60;
      }
      .room-block.reception {
        background: #16a085;
      }
      .room-block.elevator {
        background: #f39c12;
      }
      .room-block.stairs {
        background: #9b59b6;
      }
      .room-block.bathroom {
        background: #34495e;
      }
      .room-block.kitchen {
        background: #e67e22;
      }
      .room-block.waiting {
        background: #95a5a6;
      }
      .room-block.security {
        background: #c0392b;
      }
      .room-block.storage {
        background: #7f8c8d;
      }
      .room-block.breakroom {
        background: #f1c40f;
      }
      .room-block.utility {
        background: #8e44ad;
      }
      .room-block.pantry {
        background: #d35400;
      }
      .room-block.gym {
        background: #e91e63;
      }
      .room-block.lounge {
        background: #00bcd4;
      }
      .room-block.shower {
        background: #607d8b;
      }
      .room-block.executive {
        background: #9c27b0;
      }
      .room-block.boardroom {
        background: #ff5722;
      }
      .room-block.penthouse {
        background: #ff9800;
      }
      .room-block.bedroom {
        background: #795548;
      }
      .room-block.dining {
        background: #4caf50;
      }
      .room-block.terrace {
        background: #8bc34a;
      }
      .room-block.custom {
        background: #6c757d;
      }
      #commonFloorCanvas {
        position: relative;
      }
      #commonFloorCanvas svg {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      .common-room {
        position: absolute;
        border: 2px solid #111827;
        border-radius: 4px;
        cursor: move;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.4);
        -webkit-user-select: none;
        user-select: none;
      }
      .ulpin-marker {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #dc2626;
        border-radius: 50%;
        border: 2px solid #ffffff;
        transform: translate(-50%, -50%);
        pointer-events: none;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.35);
      }
      .ulpin-label {
        position: absolute;
        font-size: 10px;
        color: #111827;
        background: rgba(255, 255, 255, 0.92);
        padding: 2px 4px;
        border-radius: 3px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        transform: translate(-50%, -110%);
        pointer-events: none;
        white-space: nowrap;
      }
      /* .info-panel.overlay-visible {
        z-index: 5000;
      } */
      .info-action-btn {
        background: #0d6efd;
        color: #fff;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        margin: 2px;
      }
      .info-action-btn.secondary {
        background: #6f42c1;
      }
      .ownership-modal,
      .owner-entry-modal,
      .floor-designer-modal {
        position: fixed;
        z-index: 2147483647 !important; /* max possible z-index */
        /*transform: translateZ(0);*/
        transform: (0, 0);
        /* opacity: 0.999; works too */
      }
      .collapsible-ulpin {
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      #room-ulpin-header {
        padding: 8px 10px;
        background: #f3f4f6;
        cursor: pointer;
        /* font-weight: bold; */
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      #room-ulpin-arrow {
        font-size: 11px;
      }

      .top-strip {
        background-color: #faeddb;
        padding: 4px 16px;
        font-size: 14px;
        font-weight: bold;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 20px;
        background-color: #fff;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .header-left img {
        width: 50px;
        height: auto;
      }
      .header-text {
        display: flex;
        flex-direction: column;
        line-height: 1.3;
      }
      .header-text h3 {
        margin: 0;
        font-size: 16px;
        /* color: #800000; */
      }
      .header-text span {
        font-size: 13px;
        color: #000;
      }
      .header-center {
        flex-grow: 1;
        text-align: center;
      }
      .header-center h1 {
        margin: 0;
        font-size: 42px;
        color: black;
        /* color: #800000; */
      }
      .smoky-text {
        font-size: 64px;
        font-weight: bold;
        color: transparent;
        background: url("https://i.imgur.com/4AIKvd3.jpg") no-repeat center
          center;
        background-size: cover;
        -webkit-background-clip: text;
        background-clip: text;
        text-transform: uppercase;
      }

      .header-right img {
        width: auto;
        height: 40px;
      }

      /* .room-ulpin-info {
        padding: 6px 12px;
        border-top: 1px solid #eee;
      } */

      /* Main Controls Container */
      .map-controls {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        flex-direction: column;
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: rgb(255, 255, 255);
        padding: 10px;
        border-radius: 6px;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }

      /* Hidden/Minimized State */
      .map-controls.hidden {
        transform: translateX(-110%);
        opacity: 0;
        pointer-events: none;
      }

      .toggle-map-controls-btn {
        position: absolute;
        bottom: 10px;
        left: 10px;
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 4px;
        background: #ffffff;
        color: rgb(0, 0, 0);
        cursor: pointer;
        border: none;
        z-index: 2000; /* ensure always clickable */
        white-space: nowrap;
        width: auto;
      }

      /* When hidden ‚Üí button moves slightly */
      .map-controls.hidden + .toggle-map-controls-btn {
        left: 10px;
      }
      .toggle-map-controls-btn:hover {
        opacity: 0.9;
      }

      .info-panel.hidden {
        transform: translateX(120%);
        opacity: 0;
        pointer-events: none;
      }
      .toggle-info-infocontrols-btn {
        position: absolute;
        bottom: 10px;
        right: 10px;
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 4px;
        background: #fafafa;
        color: rgb(0, 0, 0);
        cursor: pointer;
        border: none;
        z-index: 2000;
        white-space: nowrap;
        width: auto;
      }
      .toggle-info-infocontrols-btn:hover {
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <!-- Top Strip -->
    <!-- <div class="top-strip" style="z-index: 2000">
      ‡§≠‡§æ‡§∞‡§§ ‡§∏‡§∞‡§ï‡§æ‡§∞ | Government of India
    </div> -->
    <!-- Header -->
    <div class="header" style="z-index: 2000">
      <!-- <div class="header-left" style="z-index: 2000">
        <img
          src="https://dolr.gov.in/wp-content/themes/sdo-theme/images/emblem.svg"
          alt="Government Logo"
          class="emblem"
        />
        <div class="header-text" style="z-index: 2000">
          <span lang="hi">‡§≠‡•Ç‡§Æ‡§ø ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§® ‡§µ‡§ø‡§≠‡§æ‡§ó</span>
          <h3>DEPARTMENT OF LAND RESOURCES</h3>
          <span>MINISTRY OF RURAL DEVELOPMENT</span>
        </div>
      </div> -->

      <div class="header-center" style="z-index: 2000">
        <h1
          style="
            text-shadow: -1px -1px 0 red, 1px -1px 0 red, -1px 1px 0 red,
              1px 1px 0 red;
            font-weight: bold;
          "
        >
          BhuAdhaar Demo
        </h1>
      </div>
    </div>
    <div id="map"></div>

    <!-- <div
      class="map-controls"
      style="
        display: flex;
        gap: 10px;
        align-items: flex-start;
        flex-direction: column;
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
      "
    > -->
    <button id="toggleMapControlsBtn" class="toggle-map-controls-btn">
      ‚Æú Minimize
    </button>

    <div class="map-controls" id="mapControls">
      <div class="control-group" style="min-width: 160px; margin-bottom: 0%">
        <label for="pitchControl"
          >Pitch (tilt): <span id="pitchValue">60¬∞</span></label
        >
        <input
          type="range"
          id="pitchControl"
          min="0"
          max="85"
          step="1"
          value="60"
        />
      </div>
      <div class="control-group">
        <label for="bearingControl"
          >Bearing (rotation): <span id="bearingValue">0¬∞</span></label
        >
        <input
          type="range"
          id="bearingControl"
          min="0"
          max="360"
          step="1"
          value="0"
        />
      </div>
      <div
        class="floor-layout"
        id="floorLayout"
        style="min-width: 320px; padding-top: 0%"
      >
        <h4>üè† Floor Layout</h4>
        <div class="floor-selector">
          <label>Select Floor:</label>
        </div>
        <select id="floor-selector"></select>
        <div
          class="floor-selector"
          id="apartmentSelectorContainer"
          style="display: none; margin-top: 6px"
        >
          <label>Select Apartment:</label>
          <select id="apartment-selector"></select>
        </div>
        <div class="floor-plan">
          <canvas id="floor-plan-canvas" class="floor-plan-canvas"></canvas>
        </div>
        <div class="room-info" id="room-info">
          <div>
            <span class="room-type room-office">Office</span>
            <span class="room-type room-meeting">Meeting</span>
            <span class="room-type room-lobby">Lobby</span>
            <span class="room-type room-reception">Reception</span>
          </div>
          <div>
            <span class="room-type room-elevator">Elevator</span>
            <span class="room-type room-stairs">Stairs</span>
            <span class="room-type room-bathroom">Bathroom</span>
            <span class="room-type room-kitchen">Kitchen</span>
          </div>
          <div>
            <span class="room-type room-executive">Executive</span>
            <span class="room-type room-boardroom">Boardroom</span>
            <span class="room-type room-penthouse">Penthouse</span>
            <span class="room-type room-bedroom">Bedroom</span>
          </div>
          <div>
            <span class="room-type room-gym">Gym</span>
            <span class="room-type room-lounge">Lounge</span>
            <span class="room-type room-dining">Dining</span>
            <span class="room-type room-terrace">Terrace</span>
          </div>
        </div>
        <div style="margin-top: 10px; text-align: center">
          <button
            id="floor-layout-btn"
            onclick="openFloorLayoutDesigner()"
            style="
              background: #6f42c1;
              color: white;
              padding: 8px 16px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
            "
          >
            üé® Create Floor Layout
          </button>
        </div>
      </div>

      <div id="commonFloorDesignerModal" class="floor-designer-modal">
        <div class="floor-designer-content">
          <div class="floor-designer-header">
            <div class="floor-designer-title">
              Building Common Floor Layout Designer
            </div>
            <div
              class="close-floor-designer"
              onclick="closeCommonFloorDesigner()"
            >
              √ó
            </div>
          </div>

          <div class="floor-designer-body">
            <div class="floor-designer-canvas-container">
              <div class="canvas-toolbar">
                <button
                  onclick="setCommonCanvasMode('drawPolygon')"
                  id="commonDrawPolygonBtn"
                >
                  Draw Polygon
                </button>
                <button
                  onclick="setCommonCanvasMode('draw')"
                  id="commonDrawBtn"
                >
                  Draw
                </button>
                <button
                  onclick="setCommonCanvasMode('edit')"
                  id="commonEditBtn"
                >
                  Edit
                </button>
                <button
                  onclick="setCommonCanvasMode('move')"
                  id="commonMoveBtn"
                >
                  Move
                </button>
                <button
                  onclick="setCommonCanvasMode('ulpin')"
                  id="commonPniuBtn"
                >
                  Place ULPIN
                </button>
                <button
                  class="toolbar-btn danger"
                  onclick="clearCommonFloorPlan()"
                >
                  Clear All
                </button>
                <input type="file" id="commonShapefileUpload" accept=".zip" />
                <button class="save-btn" onclick="uploadCommonShapefile()">
                  Upload Shapefile
                </button>
              </div>

              <div id="commonFloorCanvas" class="floor-designer-canvas"></div>
            </div>
          </div>

          <div class="floor-designer-footer">
            <button
              id="commonDonePolygonBtn"
              class="save-btn"
              onclick="finalizePolygonDrawing()"
              style="display: none"
            >
              Done Polygon
            </button>

            <button class="save-btn" onclick="saveCommonFloorLayout()">
              Save Layout
            </button>
            <button class="cancel-btn" onclick="closeCommonFloorDesigner()">
              Cancel
            </button>
            <button class="clear-btn" onclick="clearCommonFloorPlan()">
              Clear
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Drawing Toolbar -->
    <div
      id="drawToolbar"
      style="
        position: absolute;
        top: 120px;
        left: 10px;
        display: none;
        background: #ffffff;
        padding: 8px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 1100;
        gap: 6px;
        align-items: center;
      "
    >
      <button onclick="finishDrawing()" class="entry-inline-btn">Done</button>
      <button
        onclick="cancelDrawing()"
        class="entry-inline-btn"
        style="background: #6c757d"
      >
        Cancel
      </button>
      <span style="font-size: 12px; color: #555; margin-left: 6px"
        >Click on map to add points. Close polygon with Done.</span
      >
    </div>

    <!-- Toggle Button -->
    <button id="toggleInfoinfocontrolsBtn" class="toggle-info-infocontrols-btn">
      ‚Æû Minimize
    </button>

    <!-- Information Panel -->
    <div class="info-panel" id="infopanelinfocontrols">
      <h3>Plot Information</h3>
      <div id="buildingInfo">
        <p>Click on a plot to see details</p>
      </div>
    </div>
    <script>
      // Add polyfill for roundRect if not supported
      if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (
          x,
          y,
          width,
          height,
          radius
        ) {
          if (width < 2 * radius) radius = width / 2;
          if (height < 2 * radius) radius = height / 2;
          this.beginPath();
          this.moveTo(x + radius, y);
          this.arcTo(x + width, y, x + width, y + height, radius);
          this.arcTo(x + width, y + height, x, y + height, radius);
          this.arcTo(x, y + height, x, y, radius);
          this.arcTo(x, y, x + width, y, radius);
          this.closePath();
          return this;
        };
      }

      // Initialize the map
      const map = new maplibregl.Map({
        container: "map",
        preserveDrawingBuffer: true,
        style: {
          version: 8,
          glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
          sources: {
            osm: {
              type: "raster",
              tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
              tileSize: 256,
              attribution: "¬© OpenStreetMap contributors",
            },
          },
          layers: [
            {
              id: "osm-tiles",
              type: "raster",
              source: "osm",
              minzoom: 0,
              maxzoom: 22,
            },
          ],
        },
        center: [77.027, 28.651], // Tilangpur Kotla Village coordinates center: [77.027, 28.651] [77.027, 28.6487],
        zoom: 17, //15.3,
        pitch: 60,
        bearing: 0,
      });

      // Add navigation controls
      map.addControl(
        new maplibregl.NavigationControl({
          showCompass: true,
          showZoom: true,
          visualizePitch: true,
        })
      );
      map.dragRotate.enable();
      if (map.touchZoomRotate && map.touchZoomRotate.enableRotation) {
        map.touchZoomRotate.enableRotation();
      }

      // ===================== GLOBAL STATE & DRAW/CREATE HELPERS =====================
      let selectedParcelFeature = null;
      let selectedParcelId = null;
      let drawingMode = false;
      let drawCoords = [];
      let pendingBuildingGeometry = null;
      let nextBuildingId = 1000;
      let selectedBuildingId = null;
      let currentFloor = 1;
      let currentApartment = null;

      function normalizeFloorNumber(value) {
        const parsed = parseInt(value, 10);
        return Number.isFinite(parsed) && parsed > 0 ? parsed : 1;
      }

      function toDisplayFloorNumber(value) {
        const floor = normalizeFloorNumber(value);
        return Math.max(0, floor - 1);
      }

      function fromDisplayFloorNumber(value) {
        if (value === null || value === undefined || value === "") {
          return 1;
        }
        if (typeof value === "string" && value.trim().toUpperCase() === "G") {
          return 1;
        }
        const parsed = parseInt(value, 10);
        if (!Number.isFinite(parsed)) return 1;
        return Math.max(1, parsed + 1);
      }

      function formatFloorLabel(value) {
        const displayNumber = toDisplayFloorNumber(value);
        return displayNumber === 0 ? "G" : String(displayNumber);
      }

      function ulpinFloorIndex(value) {
        const floor = normalizeFloorNumber(value);
        return floor === 1 ? 0 : floor - 1;
      }

      function getBuildingFeatureById(bid) {
        return (userBuildings.features || []).find(
          (f) => f.properties && f.properties.BID == bid
        );
      }

      const toggleBtn = document.getElementById("toggleMapControlsBtn");
      const controls = document.getElementById("mapControls");

      toggleBtn.addEventListener("click", () => {
        controls.classList.toggle("hidden");
        toggleBtn.textContent = controls.classList.contains("hidden")
          ? "‚Æû Maximize"
          : "‚Æú Minimize";
      });
      const toggleInfoBtn = document.getElementById(
        "toggleInfoinfocontrolsBtn"
      );
      const infocontrols = document.getElementById("infopanelinfocontrols");

      toggleInfoBtn.addEventListener("click", () => {
        infocontrols.classList.toggle("hidden");
        toggleInfoBtn.textContent = infocontrols.classList.contains("hidden")
          ? "‚Æú Maximize"
          : "‚Æû Minimize";
      });
      function computeFloorPniuForBuilding(bid, floorNumber) {
        const layout = commonFloorLayoutsByBuilding[bid];
        if (layout && layout.bounds) {
          return computeFloorPniuFromLayout(layout, floorNumber);
        }
        const feat = getBuildingFeatureById(bid);
        if (!feat) return "N/A";
        const centroid = turf.centroid(feat).geometry.coordinates;
        return (
          ulpinGenerator(
            centroid[0],
            centroid[1],
            ulpinFloorIndex(normalizeFloorNumber(floorNumber))
          ) || "N/A"
        );
      }

      function updateFloorPniuDisplay(bid) {
        if (!bid) return;
        const labelEl = document.getElementById("floor-ulpin-label");
        const valueEl = document.getElementById("floor-ulpin-value");
        if (!labelEl || !valueEl) return;
        const floor = normalizeFloorNumber(currentFloor || 1);
        labelEl.textContent = `ULPIN (Floor ${formatFloorLabel(floor)}):`;
        valueEl.textContent = computeFloorPniuForBuilding(bid, floor);
      }

      function renderRoomULPINInfo(bid) {
        const container = document.getElementById("room-ulpin-block");
        if (!container) return;
        const layout =
          bid && commonFloorLayoutsByBuilding[bid]
            ? commonFloorLayoutsByBuilding[bid]
            : null;
        if (!layout || !Array.isArray(layout.rooms) || !layout.rooms.length) {
          container.innerHTML = "";
          return;
        }
        const floor = normalizeFloorNumber(currentFloor || 1);
        const buildingFeature = getBuildingFeatureById(bid);
        const buildingName =
          buildingFeature?.properties?.NAME || `Building ${bid}`;
        const rows = layout.rooms
          .map((room, idx) => {
            const title = room.name || `Room ${idx + 1}`;
            const ulpinValue = computeRoomPniuFromLayout(layout, room, floor);
            const roomId = room.id || `room-${idx}`;
            return `<div class="info-item room-ulpin-info">
              <span class="info-label">${title} ULPIN:</span>
              <span class="info-value"
                style="cursor: pointer; color: #60a5fa; text-decoration: underline;" 
                title="Download KML file for '${title}'"
                onclick="downloadRoomKML('${bid}', '${roomId}', '${title}', '${ulpinValue}', '${floor}')">
                ${ulpinValue}</span>
              <!--<button class="download-kml-btn" onclick="downloadRoomKML('${bid}', '${roomId}', '${title}', '${ulpinValue}', '${floor}')" style="margin-left: 8px; padding: 4px 8px; font-size: 11px; background: #60a5fa; color: white; border: none; border-radius: 4px; cursor: pointer;">Download</button>-->
            </div>`;
          })
          .join("");
        container.innerHTML = rows;
      }

      function toggleRoomPniuList() {
        const block = document.getElementById("room-ulpin-block");
        const arrow = document.getElementById("room-ulpin-arrow");

        if (!block) return;

        const isHidden = block.style.display === "none";
        block.style.display = isHidden ? "block" : "none";
        arrow.textContent = isHidden ? "‚ñº" : "‚ñ∂";
      }

      function downloadRoomKML(bid, roomId, roomName, ulpinValue, floorNumber) {
        const layout = commonFloorLayoutsByBuilding[bid];
        if (!layout) {
          alert("Room layout not found");
          return;
        }
        const room = layout.rooms.find((r) => r.id === roomId);
        if (!room) {
          alert("Room not found");
          return;
        }
        const buildingFeature = getBuildingFeatureById(bid);
        if (!buildingFeature) {
          alert("Building not found");
          return;
        }
        // Get floor elevation
        const floorComparable = getFloorComparable(floorNumber);
        const floorFeature = userFloorLayers.features.find(
          (f) =>
            f.properties.BID == bid &&
            getFloorComparable(f.properties.floor) === floorComparable
        );
        const floorAltitude = floorFeature
          ? floorFeature.properties.top || floorFeature.properties.base || 0
          : 0;

        const buildingName =
          buildingFeature.properties?.NAME || `Building ${bid}`;
        const kml = generateRoomKML(
          room,
          layout,
          buildingFeature,
          roomName,
          ulpinValue,
          floorNumber,
          buildingName,
          bid,
          floorAltitude
        );
        const blob = new Blob([kml], {
          type: "application/vnd.google-earth.kml+xml",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${buildingName}_${roomName}_${ulpinValue}.kml`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function generateRoomKML(
        room,
        layout,
        buildingFeature,
        roomName,
        ulpinValue,
        floorNumber,
        buildingName,
        bid,
        floorAltitude
      ) {
        const { minLon, minLat, maxLon, maxLat } = layout.bounds;
        const spanLon = maxLon - minLon || Number.EPSILON;
        const spanLat = maxLat - minLat || Number.EPSILON;

        // Calculate room coordinates with elevation
        let coordinates = [];
        if (room.polygon && room.polygon.length >= 3) {
          // Polygon room
          coordinates = room.polygon.map((pt) => {
            const lon = minLon + pt.x * spanLon;
            const lat = minLat + pt.y * spanLat;
            return `${lon},${lat},${floorAltitude}`;
          });
          // Close the polygon
          if (coordinates.length > 0) {
            coordinates.push(coordinates[0]);
          }
        } else if (room.bounds) {
          // Bounds-based room
          const { x, y, width, height } = room.bounds;
          const x1 = minLon + x * spanLon;
          const y1 = minLat + y * spanLat;
          const x2 = minLon + (x + width) * spanLon;
          const y2 = minLat + (y + height) * spanLat;
          coordinates = [
            `${x1},${y1},${floorAltitude}`,
            `${x2},${y1},${floorAltitude}`,
            `${x2},${y2},${floorAltitude}`,
            `${x1},${y2},${floorAltitude}`,
            `${x1},${y1},${floorAltitude}`,
          ];
        } else {
          // Fallback to building center
          const centroid = turf.centroid(buildingFeature).geometry.coordinates;
          coordinates = [`${centroid[0]},${centroid[1]},${floorAltitude}`];
        }

        // Get ULPIN location with elevation
        let ulpinLon, ulpinLat;
        if (room.ulpin) {
          ulpinLon = minLon + room.ulpin.x * spanLon;
          ulpinLat = minLat + room.ulpin.y * spanLat;
        } else {
          // Calculate center
          if (room.polygon && room.polygon.length >= 3) {
            let sumX = 0,
              sumY = 0;
            room.polygon.forEach((pt) => {
              sumX += pt.x;
              sumY += pt.y;
            });
            const centerX = sumX / room.polygon.length;
            const centerY = sumY / room.polygon.length;
            ulpinLon = minLon + centerX * spanLon;
            ulpinLat = minLat + centerY * spanLat;
          } else if (room.bounds) {
            ulpinLon =
              minLon + (room.bounds.x + room.bounds.width / 2) * spanLon;
            ulpinLat =
              minLat + (room.bounds.y + room.bounds.height / 2) * spanLat;
          } else {
            const centroid =
              turf.centroid(buildingFeature).geometry.coordinates;
            ulpinLon = centroid[0];
            ulpinLat = centroid[1];
          }
        }

        const coordinatesStr = coordinates.join(" ");
        const description = `
          <![CDATA[
            <table>
              <tr><td><b>Building:</b></td><td>${buildingName}</td></tr>
              <tr><td><b>Room Name:</b></td><td>${roomName}</td></tr>
              <tr><td><b>ULPIN:</b></td><td>${ulpinValue}</td></tr>
              <tr><td><b>Floor:</b></td><td>${floorNumber}</td></tr>
              <tr><td><b>Room Type:</b></td><td>${room.type || "N/A"}</td></tr>
              <tr><td><b>Building ID:</b></td><td>${bid}</td></tr>
              <tr><td><b>Room ID:</b></td><td>${room.id || "N/A"}</td></tr>
            </table>
          ]]>
        `.trim();

        return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2"
     xmlns:gx="http://www.google.com/kml/ext/2.2">
  <Document>
    <name>${buildingName} - ${roomName}</name>
    <description>${description}</description>
    <Style id="roomStyle">
      <PolyStyle>
        <color>7d60a5fa</color>
        <fill>1</fill>
        <outline>1</outline>
      </PolyStyle>
      <LineStyle>
        <color>ff1f2937</color>
        <width>2</width>
      </LineStyle>
    </Style>
      <Placemark>
      <name>${roomName}</name>
      <description>${description}</description>
      <styleUrl>#roomStyle</styleUrl>
      <Polygon>
        <extrude>0</extrude>
        <tessellate>0</tessellate>
        <altitudeMode>absolute</altitudeMode>
        <gx:altitudeMode>absolute</gx:altitudeMode>
        <outerBoundaryIs>
          <LinearRing>
            <coordinates>${coordinatesStr}</coordinates>
          </LinearRing>
        </outerBoundaryIs>
      </Polygon>
    </Placemark>
    <Placemark>
      <name>ULPIN: ${ulpinValue}</name>
      <description>
        <![CDATA[
          <table>
            <tr><td><b>ULPIN:</b></td><td>${ulpinValue}</td></tr>
            <tr><td><b>Room:</b></td><td>${roomName}</td></tr>
            <tr><td><b>Building:</b></td><td>${buildingName}</td></tr>
            <tr><td><b>Floor:</b></td><td>${floorNumber}</td></tr>
          </table>
        ]]>
      </description>
      <Point>
        <altitudeMode>absolute</altitudeMode>
        <gx:altitudeMode>absolute</gx:altitudeMode>
        <coordinates>${ulpinLon},${ulpinLat},${floorAltitude}</coordinates>
      </Point>
      <Style>
        <IconStyle>
          <Icon>
            <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
          </Icon>
          <scale>1.2</scale>
        </IconStyle>
        <LabelStyle>
          <scale>1.2</scale>
        </LabelStyle>
      </Style>
    </Placemark>
  </Document>
</kml>`;
      }

      function computeFloorPniuFromLayout(layout, floorNumber) {
        if (
          !layout ||
          !layout.bounds ||
          layout.bounds.minLat == null ||
          layout.bounds.minLon == null ||
          layout.bounds.maxLat == null ||
          layout.bounds.maxLon == null
        ) {
          return "N/A";
        }
        const { minLon, minLat, maxLon, maxLat } = layout.bounds;
        const centerLon = minLon + (maxLon - minLon) / 2;
        const centerLat = minLat + (maxLat - minLat) / 2;
        return (
          ulpinGenerator(
            centerLon,
            centerLat,
            ulpinFloorIndex(normalizeFloorNumber(floorNumber))
          ) || "N/A"
        );
      }

      let infoPanelOverlayDepth = 0;
      function setInfoPanelOverlay(active) {
        const panel = document.querySelector(".info-panel");
        if (!panel) return;
        infoPanelOverlayDepth = Math.max(
          0,
          infoPanelOverlayDepth + (active ? 1 : -1)
        );
        if (infoPanelOverlayDepth > 0) panel.classList.add("overlay-visible");
        else panel.classList.remove("overlay-visible");
      }

      let actualBuildingsIndex = {};
      const userBuildings = { type: "FeatureCollection", features: [] };
      const userFloorSeparators = { type: "FeatureCollection", features: [] };
      const userFloorLabels = { type: "FeatureCollection", features: [] };
      const userFloorLayers = { type: "FeatureCollection", features: [] };
      const API_BASE = "https://ulpindemo.onrender.com";
      let currentPropertyId = null;
      // Per-building stored layouts: { [BID]: { [floorNumber]: layout } }
      const floorLayoutsByBuilding = {};
      const commonFloorLayoutsByBuilding = {};

      function ensureActualBuildingsSourcesAndLayers() {
        if (!map.getSource("actual-buildings")) {
          map.addSource("actual-buildings", {
            type: "geojson",
            data: userBuildings,
          });
        }
        if (!map.getSource("actual-floor-separators")) {
          map.addSource("actual-floor-separators", {
            type: "geojson",
            data: userFloorSeparators,
          });
        }
        if (!map.getSource("actual-floor-labels")) {
          map.addSource("actual-floor-labels", {
            type: "geojson",
            data: userFloorLabels,
          });
        }
        if (!map.getLayer("actual-buildings-extrusion")) {
          map.addLayer({
            id: "actual-buildings-extrusion",
            type: "fill-extrusion",
            source: "actual-buildings",
            paint: {
              "fill-extrusion-height": ["get", "height"],
              "fill-extrusion-base": 0,
              "fill-extrusion-opacity": 0.0, // Completely transparent - only used for click detection
            },
          });
        }
        if (!map.getLayer("actual-floor-separators")) {
          map.addLayer({
            id: "actual-floor-separators",
            type: "fill-extrusion",
            source: "actual-floor-separators",
            paint: {
              "fill-extrusion-height": ["get", "top"],
              "fill-extrusion-base": ["get", "base"],
              "fill-extrusion-color": "#1f2937",
              "fill-extrusion-opacity": 1,
            },
          });
        }
        if (!map.getLayer("actual-floor-labels")) {
          map.addLayer({
            id: "actual-floor-labels",
            type: "symbol",
            source: "actual-floor-labels",
            layout: {
              "text-field": ["to-string", ["get", "floor"]],
              "text-size": 10,
              "text-offset": [0, 0],
              "text-anchor": "center",
              "text-allow-overlap": true,
            },
            paint: {
              "text-color": "#ffffff",
              "text-halo-color": "#000000",
              "text-halo-width": 1,
            },
          });
        }

        // Highlight layer for the currently selected floor (full fill, not just border)
        if (!map.getSource("actual-floor-layers")) {
          map.addSource("actual-floor-layers", {
            type: "geojson",
            data: userFloorLayers,
          });
        }
        if (!map.getLayer("actual-floor-layers")) {
          map.addLayer({
            id: "actual-floor-layers",
            type: "fill-extrusion",
            source: "actual-floor-layers",
            paint: {
              "fill-extrusion-base": ["get", "base"],
              "fill-extrusion-height": ["get", "top"],
              "fill-extrusion-color": "#d46a6a", // MAIN COLORING: Each floor gets this red color
              "fill-extrusion-opacity": 1,
            },
          });
        }

        if (!map.getSource("actual-floor-highlight")) {
          map.addSource("actual-floor-highlight", {
            type: "geojson",
            data: { type: "FeatureCollection", features: [] },
          });
        }
        if (!map.getLayer("actual-floor-highlight")) {
          map.addLayer({
            id: "actual-floor-highlight",
            type: "fill-extrusion",
            source: "actual-floor-highlight",
            paint: {
              "fill-extrusion-base": ["get", "base"],
              "fill-extrusion-height": ["get", "top"],
              "fill-extrusion-color": "#22c55e",
              "fill-extrusion-opacity": 0.5,
            },
          });
        }

        if (!ensureActualBuildingsSourcesAndLayers._handlersBound) {
          map.on(
            "mouseenter",
            "actual-buildings-extrusion",
            () => (map.getCanvas().style.cursor = "pointer")
          );
          map.on(
            "mouseleave",
            "actual-buildings-extrusion",
            () => (map.getCanvas().style.cursor = "")
          );
          map.on(
            "mouseenter",
            "actual-floor-separators",
            () => (map.getCanvas().style.cursor = "pointer")
          );
          map.on(
            "mouseleave",
            "actual-floor-separators",
            () => (map.getCanvas().style.cursor = "")
          );
          map.on(
            "mouseenter",
            "actual-floor-labels",
            () => (map.getCanvas().style.cursor = "pointer")
          );
          map.on(
            "mouseleave",
            "actual-floor-labels",
            () => (map.getCanvas().style.cursor = "")
          );

          // Add event handlers for floor layers
          map.on(
            "mouseenter",
            "actual-floor-layers",
            () => (map.getCanvas().style.cursor = "pointer")
          );
          map.on(
            "mouseleave",
            "actual-floor-layers",
            () => (map.getCanvas().style.cursor = "")
          );

          map.on("click", "actual-buildings-extrusion", (e) => {
            const p = e.features[0].properties;
            const feat = userBuildings.features.find(
              (f) => f.properties.BID == p.BID
            );

            // building centroid (always derive from the actual feature)
            const centroid = turf.centroid(feat).geometry.coordinates;
            const lon = centroid[0];
            const lat = centroid[1];

            const BID = p.BID;
            const infoDiv = document.getElementById("buildingInfo");
            const heading = document.querySelector(".info-panel h3");
            if (heading) heading.textContent = "Building Information";

            // Determine clicked floor by checking the floor highlight layer under the click.
            let clickedFloor = 1;
            const hitFloors = map.queryRenderedFeatures(e.point, {
              layers: ["actual-floor-layers"],
            });
            const matchedFloor = hitFloors.find(
              (f) => f.properties && f.properties.BID == BID
            );
            if (matchedFloor) {
              clickedFloor = normalizeFloorNumber(
                matchedFloor.properties.floor
              );
            } else if (typeof currentFloor === "number" && currentFloor >= 1) {
              clickedFloor = normalizeFloorNumber(currentFloor);
            }

            // Ensure UI floor selector reflects the chosen floor and building
            selectedBuildingId = BID;
            currentFloor = clickedFloor;
            populateFloorSelector(p.floors);
            // make sure the selector shows currentFloor
            const sel = document.getElementById("floor-selector");
            if (sel) sel.value = String(currentFloor);

            // Build info HTML using the computed floor label (G for 1)
            const ownerFloor = currentFloor || 1;
            const floorLabel = formatFloorLabel(ownerFloor);
            const floorPniu = computeFloorPniuForBuilding(BID, ownerFloor);
            const sanitize = (value) =>
              (value == null ? "" : String(value)).replace(/'/g, "\\'");
            const propertyId =
              p.original_id ||
              `B-${String(BID).padStart(3, "0")}` ||
              p.NAME ||
              "UNKNOWN";
            currentPropertyId = propertyId;
            const propertyJson = JSON.stringify(p).replace(/\"/g, "&quot;");
            const buildingNameSafe = sanitize(p.NAME || "Building");
            const villageSafe = sanitize(p.village || p.VILL_NM || "");
            const subdivisionSafe = sanitize(
              p.subdivision || p.SUBDIV_NM || ""
            );
            const districtSafe = sanitize(p.district || p.DIST_NM || "");

            infoDiv.innerHTML = `
                  <div class="info-item"><span class="info-label">Name:</span> <span class="info-value">${
                    p.NAME
                  }</span></div>
                  <div class="info-item"><span class="info-label">Building Type:</span> <span class="info-value">${
                    p.building_type
                  }</span></div>
                  <div class="info-item"><span class="info-label">Original ID:</span> <span class="info-value">${
                    p.original_id
                  }</span></div>
                  <div class="info-item"><span class="info-label">Height:</span> <span class="info-value">${p.height.toFixed(
                    1
                  )} m</span></div>

                  <div class="info-item">
                    <span id="floor-ulpin-label" class="info-label">ULPIN (Floor ${floorLabel}):</span>
                    <!--<span id="floor-ulpin-value" class="info-value">${floorPniu}</span>-->
                    <span class="info-value" style="cursor: pointer; color: #60a5fa; text-decoration: underline;"
                      title="Download KML file for FLoor ${floorLabel}"
                      onclick="downloadKmlForFloor(${
                        p.BID
                      }, ${ownerFloor})">${floorPniu}
                    </span>
                  </div>
                  <!--<div id="room-ulpin-block"></div>-->
                  <div class="collapsible-ulpin">
                    <div id="room-ulpin-header" onclick="toggleRoomPniuList()">
                      <span id="room-ulpin-arrow">‚ñ∂</span> Room ULPIN List
                    </div>
                    <div id="room-ulpin-block" style="display: none;"></div>
                  </div>


                  <div class="info-item"><span class="info-label">Floors:</span> <span class="info-value">${
                    p.floors
                  }</span></div>
                  <div class="info-item"><span class="info-label">Floor Height:</span> <span class="info-value">${(
                    p.height / p.floors
                  ).toFixed(1)} m</span></div>
                  <div class="info-item"><span class="info-label">Building Area:</span> <span class="info-value">${(
                    p.parcel_area || 0
                  ).toFixed(1)} m¬≤</span></div>
                  <div class="info-item"><span class="info-label">Building ID:</span> <span class="info-value">B-${p.BID.toString().padStart(
                    3,
                    "0"
                  )}</span></div>
                    <div class="info-item"><span class="info-label">Parcel Type:</span> <span class="info-value">${
                      p.parcel_type
                    }</span></div>
                    <div class="info-item"><span class="info-label">Parcel Sub Type:</span> <span class="info-value">${
                      p.parcel_subtype
                    }</span></div>
                    <div class="info-item"><span class="info-label">Village:</span> <span class="info-value">${
                      p.village
                    }</span></div>
                    <div class="info-item"><span class="info-label">Subdivision:</span> <span class="info-value">${
                      p.subdivision
                    }</span></div>
                    <div class="info-item"><span class="info-label">District:</span> <span class="info-value">${
                      p.district
                    }</span></div>
                    <div class="info-item"><span class="info-label">Perimeter:</span> <span class="info-value">${(
                      p.perimeter || 0
                    ).toFixed(2)} m</span></div>
                      <div style="margin-top: 15px; text-align: center; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                          <button id="view-ownership-btn" onclick="showOwnershipModal('${propertyId}', ${propertyJson})" 
                                  style="display: none; background: #007bff; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          üìã View Ownership Document
                      </button>
                      <button id="enter-owner-btn" onclick="openOwnerEntryModal({propertyId:'${propertyId}', name:'${buildingNameSafe}', floors:${
              p.floors
            }, 
                      village:'${villageSafe}', subdivision:'${subdivisionSafe}', district:'${districtSafe}', ownerFloor:${ownerFloor}})" 
                              style="background: #28a745; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          ‚úèÔ∏è Enter Owner Details (Floor ${floorLabel})
                      </button>
                      <button onclick="openBuildingEditModal(${p.BID})" 
                              style="background: #6f42c1; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                          ‚úèÔ∏è Edit Building Details
                      </button>
                      <button class="info-action-btn" onclick="openCommonFloorDesigner()">üè¢ Edit Building Layout</button>
                      <!--<button onclick="saveCurrentBuilding(${p.BID})" 
                              style="background: #0d6efd; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          üíæ Save Building
                      </button>-->
                      <button onclick="downloadKmlForBuildingFloor(${
                        p.BID
                      }, ${ownerFloor})">‚¨áÔ∏è Download Building KML</button>
                      <!--<button onclick="downloadKmlForFloor(${
                        p.BID
                      }, ${ownerFloor})">‚¨áÔ∏è Download Floor KML</button>-->
                      <button onclick="deleteBuilding(${p.BID})" 
                              style="background: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                          üóëÔ∏è Delete Building
                      </button>
                  </div>
                  <!--<div class="info-item" style="text-align:center; margin-top:8px;">
                    <button class="info-action-btn" onclick="openCommonFloorDesigner()">üè¢ Edit Building Layout</button>
                    <button class="info-action-btn secondary" onclick="openFloorLayoutDesigner()">üé® Edit Floor Layout</button>
                  </div>-->
                    `;
            renderRoomULPINInfo(BID);
            updateFloorPniuDisplay(BID);
            // Clear any existing highlighting when switching buildings
            if (selectedBuildingId !== BID) {
              clearFloorHighlighting();
            }

            selectedBuildingId = BID;
            currentFloor = clickedFloor;
            // then the rest of your existing logic (highlighting, load layout, etc.)
            clearFloorHighlighting(); // if needed or conditionally
            populateFloorSelector(p.floors);
            drawFloorPlan(currentFloor);
            loadAndRenderFloorLayout(BID, currentFloor);
            showFloorUI(true);
            updateOwnerEntryButtonFloorLabel();
            try {
              refreshEnterOwnerButtonLabel();
            } catch (e) {}
            // Update green highlight for the selected floor
            setHighlightedFloor(BID, currentFloor);
            try {
              refreshApartmentControls();
            } catch (e) {}
            try {
              refreshEnterOwnerButtonLabel();
            } catch (e) {}
          });

          map.on("click", "actual-floor-separators", (e) => {
            const p = e.features[0].properties;
            const BID = p.BID;
            selectedBuildingId = BID;
            const meta = actualBuildingsIndex[BID];
            const totalFloors = meta
              ? Math.max(1, parseInt(meta.floors || 1, 10))
              : Math.max(1, parseInt(p.floor || 1, 10));
            // Separator band at level i is between floor i and i+1. Select i+1, clamped to totalFloors.
            currentFloor = Math.min(
              totalFloors,
              (parseInt(p.floor, 10) || 1) + 1
            );
            currentPropertyId = (meta && meta.original_id) || "";
            populateFloorSelector(totalFloors);
            drawFloorPlan(currentFloor);
            updateFloorPniuDisplay(BID);
            renderRoomULPINInfo(BID);
            loadAndRenderFloorLayout(BID, currentFloor);
            showFloorUI(true);
            const heading = document.querySelector(".info-panel h3");
            if (heading) heading.textContent = "Building Information";
            try {
              refreshEnterOwnerButtonLabel();
            } catch (e) {}
            setHighlightedFloor(BID, currentFloor);
            try {
              refreshApartmentControls();
            } catch (e) {}
          });
          map.on("click", "actual-floor-labels", (e) => {
            const p = e.features[0].properties;
            const BID = p.BID;
            selectedBuildingId = BID;
            currentFloor = p.floor;
            const meta = actualBuildingsIndex[BID];
            currentPropertyId = (meta && meta.original_id) || "";
            populateFloorSelector(meta ? meta.floors : p.floor);
            drawFloorPlan(currentFloor);
            updateFloorPniuDisplay(BID);
            renderRoomULPINInfo(BID);
            loadAndRenderFloorLayout(BID, currentFloor);
            showFloorUI(true);
            updateOwnerEntryButtonFloorLabel();
            try {
              refreshEnterOwnerButtonLabel();
            } catch (e) {}
            setHighlightedFloor(BID, currentFloor);
            try {
              refreshApartmentControls();
            } catch (e) {}
          });

          // Add click handler for floor layers
          map.on("click", "actual-floor-layers", (e) => {
            const p = e.features[0].properties;
            const BID = p.BID;
            selectedBuildingId = BID;
            currentFloor = p.floor;
            const meta = actualBuildingsIndex[BID];
            currentPropertyId = (meta && meta.original_id) || "";
            populateFloorSelector(meta ? meta.floors : p.floor);
            drawFloorPlan(currentFloor);
            updateFloorPniuDisplay(BID);
            renderRoomULPINInfo(BID);
            showFloorUI(true);
            updateOwnerEntryButtonFloorLabel();
            try {
              refreshEnterOwnerButtonLabel();
            } catch (e) {}
            setHighlightedFloor(BID, currentFloor);
            try {
              refreshApartmentControls();
            } catch (e) {}
          });
          ensureActualBuildingsSourcesAndLayers._handlersBound = true;
        }
      }

      async function loadPersistedBuildings() {
        try {
          const res = await fetch("/api/buildings");
          if (!res.ok) return;
          const fc = await res.json();
          if (!fc || !Array.isArray(fc.features)) return;
          userBuildings.features = fc.features;
          rebuildUserBuildingsDerived();
        } catch (e) {
          // ignore
        }
      }

      function rebuildUserBuildingsDerived() {
        userFloorSeparators.features = [];
        userFloorLabels.features = [];
        userFloorLayers.features = [];
        actualBuildingsIndex = {};
        let maxBid = nextBuildingId;
        for (const feat of userBuildings.features) {
          const props = feat.properties || {};
          const BID = props.BID;
          const floors = Math.max(1, parseInt(props.floors || 1, 10));
          const heightVal = parseFloat(props.height || floors * 3);
          const floorH = heightVal / floors;
          const centroid = turf.centroid({
            type: "Feature",
            geometry: feat.geometry,
            properties: {},
          }).geometry.coordinates;
          const bandThickness = Math.max(0.3, floorH * 0.08);

          const apartmentCounts =
            props.apartmentCounts && typeof props.apartmentCounts === "object"
              ? props.apartmentCounts
              : {};

          // Create individual floor layers for this building
          for (let i = 1; i <= floors; i++) {
            const level = floorH * i;
            const base = floorH * (i - 1);
            const top = level;

            // Create floor layer feature
            const floorFeature = {
              type: "Feature",
              geometry: feat.geometry,
              properties: {
                BID,
                floor: i,
                base,
                top,
                height: floorH,
                buildingName: props.NAME,
                buildingType: props.building_type,
                apartmentCount: Math.max(
                  1,
                  parseInt(apartmentCounts[i] || 1, 10)
                ),
              },
            };

            // Add to floor layers collection
            if (!userFloorLayers.features) userFloorLayers.features = [];
            userFloorLayers.features.push(floorFeature);
          }

          for (let i = 1; i < floors; i++) {
            const level = floorH * i;
            const base = Math.max(0, level - bandThickness / 2);
            const top = Math.min(heightVal, level + bandThickness / 2);
            userFloorSeparators.features.push({
              type: "Feature",
              geometry: feat.geometry,
              properties: { BID, floor: i, base, top },
            });
          }
          for (let i = 1; i <= floors; i++) {
            const level = floorH * i;
            userFloorLabels.features.push({
              type: "Feature",
              geometry: { type: "Point", coordinates: centroid },
              properties: { BID, floor: i, height: level },
            });
          }
          actualBuildingsIndex[BID] = {
            center: centroid,
            height: heightVal,
            floors,
            name: props.NAME,
            type: props.building_type,
            original_id: props.original_id,
            apartmentCounts: apartmentCounts,
          };
          if (BID != null && Number(BID) >= maxBid) maxBid = Number(BID) + 1;
        }
        nextBuildingId = Math.max(nextBuildingId, maxBid);
        ensureActualBuildingsSourcesAndLayers();
        if (map.getSource("actual-buildings"))
          map.getSource("actual-buildings").setData(userBuildings);
        if (map.getSource("actual-floor-separators"))
          map.getSource("actual-floor-separators").setData(userFloorSeparators);
        if (map.getSource("actual-floor-labels"))
          map.getSource("actual-floor-labels").setData(userFloorLabels);
        // Clear highlight if any after rebuild to avoid stale geometry
        if (map.getSource("actual-floor-highlight"))
          map
            .getSource("actual-floor-highlight")
            .setData({ type: "FeatureCollection", features: [] });

        // Update floor layers source - restore all floors initially
        if (map.getSource("actual-floor-layers"))
          map.getSource("actual-floor-layers").setData(userFloorLayers);

        // Update building properties to reflect current floor selection state
        if (selectedBuildingId && currentFloor) {
          updateBuildingFloorSelection(selectedBuildingId, currentFloor);
        }
      }

      // Set the green highlight for a specific building's floor by extruding that slice
      function setHighlightedFloor(BID, floor) {
        const src = map.getSource("actual-floor-highlight");
        if (!src) return;
        const meta = actualBuildingsIndex[BID];
        if (!meta || !floor || floor < 1) {
          src.setData({ type: "FeatureCollection", features: [] });
          return;
        }
        const floorCount = Math.max(1, parseInt(meta.floors || 1, 10));
        const totalHeight = Math.max(
          1,
          parseFloat(meta.height || floorCount * 3)
        );
        const floorHeight = totalHeight / floorCount;
        const base = floorHeight * (floor - 1);
        const top = floorHeight * floor;
        const feat = (userBuildings.features || []).find(
          (f) => (f.properties && f.properties.BID) == BID
        );
        if (!feat) {
          src.setData({ type: "FeatureCollection", features: [] });
          return;
        }
        const highlight = {
          type: "Feature",
          geometry: feat.geometry,
          properties: { BID, floor, base, top },
        };
        src.setData({ type: "FeatureCollection", features: [highlight] });

        // Update floor layers to hide the selected floor (so green highlight shows clearly)
        updateBuildingFloorSelection(BID, floor);
      }

      // Function to update building properties when floor selection changes
      function updateBuildingFloorSelection(BID, selectedFloor) {
        // Filter floor layers to exclude the selected floor (so green highlight shows clearly)
        if (map.getSource("actual-floor-layers")) {
          const filteredFloors = userFloorLayers.features.filter((f) => {
            const props = f.properties || {};
            // Show all floors except the selected one for the selected building
            return !(props.BID == BID && props.floor == selectedFloor);
          });

          const filteredData = {
            type: "FeatureCollection",
            features: filteredFloors,
          };

          map.getSource("actual-floor-layers").setData(filteredData);
        }
      }

      // Function to clear floor highlighting and restore all floor layers
      function clearFloorHighlighting() {
        // Clear the green highlight
        if (map.getSource("actual-floor-highlight")) {
          map.getSource("actual-floor-highlight").setData({
            type: "FeatureCollection",
            features: [],
          });
        }
        // Restore all floor layers
        if (map.getSource("actual-floor-layers")) {
          map.getSource("actual-floor-layers").setData(userFloorLayers);
        }
      }

      async function updatePersistedBuilding(bid, partialProps, newGeometry) {
        try {
          await fetch(`/api/buildings/${encodeURIComponent(bid)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              properties: partialProps || {},
              geometry: newGeometry || undefined,
            }),
          });
        } catch (e) {
          /* ignore */
        }
      }

      async function saveCurrentBuilding(BID) {
        // find feature in memory and send to backend POST (if new) or PUT (if exists)
        const feat = (userBuildings.features || []).find(
          (f) => (f.properties && f.properties.BID) == BID
        );
        if (!feat) {
          alert("Building not found in memory.");
          return;
        }
        // ensure plot id is present for placement
        if (!feat.properties) feat.properties = {};
        if (!feat.properties.original_id && selectedParcelId)
          feat.properties.original_id = selectedParcelId;
        if (!feat.properties.plot_id)
          feat.properties.plot_id =
            feat.properties.original_id || selectedParcelId || "";
        // Try PUT first (update), fallback to POST if 404; treat 409 as success (already saved)
        try {
          const putRes = await fetch(
            `/api/buildings/${encodeURIComponent(BID)}`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                properties: feat.properties,
                geometry: feat.geometry,
              }),
            }
          );
          if (putRes.ok) {
            alert("Building saved.");
            return;
          }
          if (putRes.status !== 404) {
            const t = await putRes.text().catch(() => "");
            alert(`Failed to save building (update): ${putRes.status} ${t}`);
            return;
          }
          // fallback to POST on 404
          const postRes = await fetch("/api/buildings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ feature: feat }),
          });
          if (postRes.ok) {
            alert("Building saved.");
            return;
          }
          if (postRes.status === 409) {
            alert("Building already saved.");
            return;
          }
          const t = await postRes.text().catch(() => "");
          alert(`Failed to save building (create): ${postRes.status} ${t}`);
        } catch (e) {
          alert("Failed to save building (network).");
        }
      }

      async function deleteBuilding(BID) {
        if (!confirm("Delete this building? This action cannot be undone."))
          return;
        // remove from memory
        const before = userBuildings.features.length;
        userBuildings.features = (userBuildings.features || []).filter(
          (f) => String(f.properties && f.properties.BID) !== String(BID)
        );
        if (before === userBuildings.features.length) {
          alert("Building not found.");
          return;
        }
        rebuildUserBuildingsDerived();
        try {
          const res = await fetch(`/api/buildings/${encodeURIComponent(BID)}`, {
            method: "DELETE",
          });
          if (!res.ok) console.warn("Failed to delete on server");
        } catch (e) {
          /* ignore */
        }
        alert("Building deleted.");
      }

      function openBuildingEditModal(BID) {
        const modal = document.getElementById("buildingEditModal");
        if (!modal) return;
        // find feature
        const feat = (userBuildings.features || []).find(
          (f) => (f.properties && f.properties.BID) == BID
        );
        if (!feat) return;
        const p = feat.properties || {};
        document.getElementById("be-bid").value = p.BID;
        document.getElementById("be-building-name").value = p.NAME || "";
        const typeSel = document.getElementById("be-building-type");
        if (typeSel) typeSel.value = p.building_type || "Standard";
        const floors = parseInt(p.floors || 1, 10);
        const totalHeight = parseFloat(p.height || floors * 3);
        const floorH = Math.max(1, totalHeight / Math.max(1, floors));
        document.getElementById("be-floors").value = floors;
        document.getElementById("be-floor-height").value = floorH.toFixed(1);
        modal.style.display = "block";
      }

      function closeBuildingEditModal() {
        const m = document.getElementById("buildingEditModal");
        if (m) m.style.display = "none";
      }
      async function saveBuildingEdits() {
        const bid = document.getElementById("be-bid").value;
        const name =
          document.getElementById("be-building-name").value ||
          "Custom Building";
        const type =
          document.getElementById("be-building-type").value || "Standard";
        const floors = Math.max(
          1,
          parseInt(document.getElementById("be-floors").value || "1", 10)
        );
        const floorH = Math.max(
          1,
          parseFloat(document.getElementById("be-floor-height").value || "3")
        );
        const totalH = floors * floorH;
        // update local feature
        const idx = (userBuildings.features || []).findIndex(
          (f) => (f.properties && String(f.properties.BID)) === String(bid)
        );
        if (idx === -1) return;
        const feat = userBuildings.features[idx];
        feat.properties = Object.assign({}, feat.properties || {}, {
          NAME: name,
          building_type: type,
          floors,
          height: totalH,
        });
        // rebuild derived
        rebuildUserBuildingsDerived();
        // persist
        await updatePersistedBuilding(bid, {
          NAME: name,
          building_type: type,
          floors,
          height: totalH,
        });
        closeBuildingEditModal();
      }

      function startDrawingBuilding() {
        if (!selectedParcelFeature) {
          alert("Please click on a plot first.");
          return;
        }
        drawingMode = true;
        drawCoords = [];
        pendingBuildingGeometry = null;
        const toolbar = document.getElementById("drawToolbar");
        if (toolbar) toolbar.style.display = "flex";
        if (map.doubleClickZoom) map.doubleClickZoom.disable();
        map.getCanvas().style.cursor = "crosshair";
        map.on("click", onMapClickForDrawing);
      }

      function onMapClickForDrawing(e) {
        if (!drawingMode) return;
        drawCoords.push([e.lngLat.lng, e.lngLat.lat]);
        updateDrawingLayers();
      }

      function updateDrawingLayers() {
        const lineFeature = {
          type: "Feature",
          geometry: { type: "LineString", coordinates: drawCoords },
          properties: {},
        };
        const polygonFeature =
          drawCoords.length >= 3
            ? {
                type: "Feature",
                geometry: {
                  type: "Polygon",
                  coordinates: [[...drawCoords, drawCoords[0]]],
                },
                properties: {},
              }
            : null;
        if (!map.getSource("draw-line")) {
          map.addSource("draw-line", {
            type: "geojson",
            data: { type: "FeatureCollection", features: [] },
          });
          map.addLayer({
            id: "draw-line-layer",
            type: "line",
            source: "draw-line",
            paint: {
              "line-color": "#ff9900",
              "line-width": 2,
              "line-dasharray": [2, 2],
            },
          });
        }
        if (!map.getSource("draw-polygon")) {
          map.addSource("draw-polygon", {
            type: "geojson",
            data: { type: "FeatureCollection", features: [] },
          });
          map.addLayer({
            id: "draw-polygon-layer",
            type: "fill",
            source: "draw-polygon",
            paint: { "fill-color": "#ff9900", "fill-opacity": 0.3 },
          });
        }
        map.getSource("draw-line").setData({
          type: "FeatureCollection",
          features: drawCoords.length ? [lineFeature] : [],
        });
        map.getSource("draw-polygon").setData({
          type: "FeatureCollection",
          features: polygonFeature ? [polygonFeature] : [],
        });
      }

      function cancelDrawing(clearPending = true) {
        drawingMode = false;
        drawCoords = [];
        if (clearPending) pendingBuildingGeometry = null;
        if (map.getSource("draw-line"))
          map
            .getSource("draw-line")
            .setData({ type: "FeatureCollection", features: [] });
        if (map.getSource("draw-polygon"))
          map
            .getSource("draw-polygon")
            .setData({ type: "FeatureCollection", features: [] });
        const toolbar = document.getElementById("drawToolbar");
        if (toolbar) toolbar.style.display = "none";
        map.getCanvas().style.cursor = "";
        map.off("click", onMapClickForDrawing);
        if (map.doubleClickZoom) map.doubleClickZoom.enable();
      }

      function finishDrawing() {
        if (drawCoords.length < 3) {
          alert("Add at least 3 points to form a polygon.");
          return;
        }
        const polygon = turf.polygon([[...drawCoords, drawCoords[0]]]);
        let clipped = null;
        try {
          clipped = turf.intersect(polygon, selectedParcelFeature);
        } catch (err) {
          clipped = null;
        }
        if (!clipped) {
          alert(
            "The drawn polygon does not overlap the selected plot. Please draw within the plot boundary."
          );
          return;
        }
        if (clipped.geometry && clipped.geometry.type === "MultiPolygon") {
          const flattened = turf.flatten(clipped);
          let best = null,
            bestA = 0;
          for (const g of flattened.features) {
            const a = turf.area(g);
            if (a > bestA) {
              bestA = a;
              best = g;
            }
          }
          if (best) clipped = best;
        }
        pendingBuildingGeometry = clipped.geometry;
        cancelDrawing(false);
        openBuildingCreateModal();
      }

      function openBuildingCreateModal() {
        const modal = document.getElementById("buildingCreateModal");
        if (!modal) return;
        const pid =
          selectedParcelId ||
          (selectedParcelFeature &&
            selectedParcelFeature.properties &&
            selectedParcelFeature.properties.IDS) ||
          "";
        document.getElementById("bc-property-id").value = pid;
        document.getElementById("bc-building-name").value =
          `Custom Building ${pid}`.trim();
        document.getElementById("bc-floors").value = 5;
        document.getElementById("bc-floor-height").value = 3.0;
        modal.style.display = "block";
      }

      function closeBuildingCreateModal() {
        const modal = document.getElementById("buildingCreateModal");
        if (modal) modal.style.display = "none";
      }

      function createBuildingFromDrawn() {
        if (!pendingBuildingGeometry || !selectedParcelFeature) {
          alert("No building geometry available.");
          return;
        }
        const name =
          document.getElementById("bc-building-name").value ||
          "Custom Building";
        const type =
          document.getElementById("bc-building-type").value || "Standard";
        const floors = Math.max(
          1,
          parseInt(document.getElementById("bc-floors").value || "1", 10)
        );
        const floorHeight = Math.max(
          1,
          parseFloat(document.getElementById("bc-floor-height").value || "3")
        );
        const extrudeHeight = floors * floorHeight;
        const area = turf.area({
          type: "Feature",
          geometry: pendingBuildingGeometry,
          properties: {},
        });
        const centroid = turf.centroid({
          type: "Feature",
          geometry: pendingBuildingGeometry,
          properties: {},
        }).geometry.coordinates;
        const BID = nextBuildingId++;
        // Initialize per-floor apartment counts to 1
        const apartmentCounts = {};
        for (let i = 1; i <= floors; i++) apartmentCounts[i] = 1;
        const feature = {
          type: "Feature",
          geometry: pendingBuildingGeometry,
          properties: {
            BID,
            NAME: name,
            height: extrudeHeight,
            parcel_area: area,
            floors,
            building_type: type,
            apartmentCounts: apartmentCounts,
            original_id:
              selectedParcelId ||
              (selectedParcelFeature.properties &&
                selectedParcelFeature.properties.IDS) ||
              "N/A",
            parcel_type:
              (selectedParcelFeature.properties &&
                selectedParcelFeature.properties.TYPE) ||
              "N/A",
            parcel_subtype:
              (selectedParcelFeature.properties &&
                selectedParcelFeature.properties.SUB_TYPE) ||
              "N/A",
            village:
              (selectedParcelFeature.properties &&
                selectedParcelFeature.properties.VILL_NM) ||
              "N/A",
            subdivision:
              (selectedParcelFeature.properties &&
                selectedParcelFeature.properties.SUBDIV_NM) ||
              "N/A",
            district:
              (selectedParcelFeature.properties &&
                selectedParcelFeature.properties.DIST_NM) ||
              "N/A",
            perimeter:
              (selectedParcelFeature.properties &&
                selectedParcelFeature.properties.Shape_Leng) ||
              0,
          },
        };
        userBuildings.features.push(feature);
        const bandThickness = Math.max(0.3, floorHeight * 0.08);
        for (let i = 1; i < floors; i++) {
          const level = floorHeight * i;
          const base = Math.max(0, level - bandThickness / 2);
          const top = Math.min(extrudeHeight, level + bandThickness / 2);
          userFloorSeparators.features.push({
            type: "Feature",
            geometry: pendingBuildingGeometry,
            properties: { BID, floor: i, base, top },
          });
        }
        for (let i = 1; i <= floors; i++) {
          const level = floorHeight * i;
          userFloorLabels.features.push({
            type: "Feature",
            geometry: { type: "Point", coordinates: centroid },
            properties: { BID, floor: i, height: level },
          });
        }
        actualBuildingsIndex[BID] = {
          center: centroid,
          height: extrudeHeight,
          floors,
          name,
          type,
          original_id: selectedParcelId || "N/A",
          apartmentCounts: apartmentCounts,
        };
        ensureActualBuildingsSourcesAndLayers();
        map.getSource("actual-buildings").setData(userBuildings);
        map.getSource("actual-floor-separators").setData(userFloorSeparators);
        map.getSource("actual-floor-labels").setData(userFloorLabels);
        closeBuildingCreateModal();
        map.flyTo({ center: centroid, essential: true });
        // Persist to backend GeoJSON
        fetch("/api/buildings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ feature }),
        }).catch(() => {});
        try {
          refreshApartmentControls();
        } catch (e) {}
      }

      map.on("load", function () {
        // Load the GeoJSON file
        fetch("GeojsonVillage/TilangpurKotla_Village.geojson")
          .then((response) => response.json())
          .then((data) => {
            // Process the data
            const processedData = processGeoJSONData(data);

            // Add land as 2D fill and outline from processed parcels
            addLandLayers(processedData);
            // Load any persisted user-created buildings
            if (typeof loadPersistedBuildings === "function") {
              // delay a tick to ensure sources can be created when needed
              setTimeout(() => {
                try {
                  loadPersistedBuildings();
                } catch (e) {}
              }, 100);
            }
          })
          .catch((error) => {
            console.error("Error loading GeoJSON:", error);
            alert("Error loading building data. Please check the file path.");
          });
      });

      // Function to show ownership modal (with backend data)
      async function showOwnershipModal(propertyId, propertyData) {
        const modal = document.getElementById("ownershipModal");
        const detailsDiv = document.getElementById("ownershipDetails");
        const normalizedFloor = normalizeFloorNumber(currentFloor || 1);
        let entries = await fetchEntries(propertyId, normalizedFloor);
        const floorLabel = formatFloorLabel(normalizedFloor);
        if (!entries.length) {
          detailsDiv.innerHTML = `
                    <div class="ownership-section">
                        <h3>üè† Property Information</h3>
                        <div class="ownership-grid">
                            <div class="ownership-item">
                                <span class="ownership-label">Property ID:</span>
                                <span class="ownership-value">${propertyId}</span>
                            </div>
                            <div class="ownership-item">
                                <span class="ownership-label">Floor:</span>
                                <span class="ownership-value">${floorLabel}</span>
                            </div>
                        </div>
                    </div>
                    <div class="ownership-section">
                        <h3>‚ÑπÔ∏è No details entered</h3>
                        <div class="ownership-value">No owner details have been entered for this property and floor.</div>
                    </div>
                    <div class="ownership-actions">
                        <button class="ownership-btn secondary" onclick="closeOwnershipModal()">‚ùå Close</button>
                    </div>
                `;
          modal.style.display = "block";
          return;
        }
        const entry = entries[entries.length - 1];
        const safe = (v) => (v == null || v === "" ? "N/A" : v);
        const mode = entry.mode === "2b" ? "2b" : "2a";
        const naIf2a = (v) => (mode === "2b" ? "N/A" : safe(v));
        const naIf2b = (v) => (mode === "2a" ? "N/A" : safe(v));

        detailsDiv.innerHTML = `
                <div class="ownership-section">
                    <h3>üìù Form</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item">
                            <span class="ownership-label">Form No.:</span>
                            <span class="ownership-value">${safe(
                              entry.meta.formNo
                            )}</span>
                        </div>
                        <div class="ownership-item">
                            <span class="ownership-label">Date:</span>
                            <span class="ownership-value">${safe(
                              entry.meta.date
                            )}</span>
                        </div>
                        <div class="ownership-item">
                            <span class="ownership-label">Property ID:</span>
                            <span class="ownership-value">${safe(
                              entry.meta.propertyId
                            )}</span>
                        </div>
                        <div class="ownership-item">
                            <span class="ownership-label">Floor:</span>
                            <span class="ownership-value">${safe(
                              formatFloorLabel(entry.meta.ownerFloorNo)
                            )}</span>
                        </div>
                        <div class="ownership-item">
                            <span class="ownership-label">Entry Mode:</span>
                            <span class="ownership-value">${
                              mode === "2a"
                                ? "Individual (2a & 3a)"
                                : "Multi-owner (2b & 3b)"
                            }</span>
                        </div>
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 1: PLOT DETAILS</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item"><span class="ownership-label">State/UT:</span><span class="ownership-value">${safe(
                          entry.section1.state
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">District:</span><span class="ownership-value">${safe(
                          entry.section1.district
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Town/City:</span><span class="ownership-value">${safe(
                          entry.section1.townCity
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Survey No.:</span><span class="ownership-value">${safe(
                          entry.section1.surveyNo
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Ward:</span><span class="ownership-value">${safe(
                          entry.section1.ward
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Year of Ownership:</span><span class="ownership-value">${safe(
                          entry.section1.yearOfOwnership
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Property Type:</span><span class="ownership-value">${safe(
                          entry.section1.propertyType
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Govt Category:</span><span class="ownership-value">${safe(
                          entry.section1.govCategory
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">ULPIN:</span><span class="ownership-value">${safe(
                          entry.section1.ulpin
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Plot ID:</span><span class="ownership-value">${safe(
                          entry.section1.plotId
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Plot Area (sq m):</span><span class="ownership-value">${safe(
                          entry.section1.plotArea
                        )}</span></div>
                        <div class="ownership-item" style="grid-column: span 2;"><span class="ownership-label">Plot Address:</span><span class="ownership-value">${safe(
                          entry.section1.plotAddress
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Owner(s) & Guardian:</span><span class="ownership-value">${safe(
                          entry.section1.plotOwnerName
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Aadhaar:</span><span class="ownership-value">${safe(
                          entry.section1.plotOwnerAadhaar
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Mobile:</span><span class="ownership-value">${safe(
                          entry.section1.plotOwnerMobile
                        )}</span></div>
                        <div class="ownership-item" style="grid-column: span 2;"><span class="ownership-label">Rights:</span><span class="ownership-value">${safe(
                          entry.section1.rights
                        )}</span></div>
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 2(a): INDIVIDUAL BUILDING</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item"><span class="ownership-label">Municipal ID:</span><span class="ownership-value">${naIf2a(
                          entry.section2a.municipalId
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Property Type:</span><span class="ownership-value">${naIf2a(
                          entry.section2a.propertyType
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Usage:</span><span class="ownership-value">${naIf2a(
                          entry.section2a.usage
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Building Name:</span><span class="ownership-value">${naIf2a(
                          entry.section2a.buildingName
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Total Floors:</span><span class="ownership-value">${naIf2a(
                          entry.section2a.totalFloors
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Owner Floor:</span><span class="ownership-value">${naIf2a(
                          entry.section2a.ownersFloorNo
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Owner Name:</span><span class="ownership-value">${naIf2a(
                          entry.section2a.ownerName
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Super Built-up (sq m):</span><span class="ownership-value">${naIf2a(
                          entry.section2a.superBuiltUp
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Parking (sq m):</span><span class="ownership-value">${naIf2a(
                          entry.section2a.parkingArea
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Garage (sq m):</span><span class="ownership-value">${naIf2a(
                          entry.section2a.garageArea
                        )}</span></div>
                        <div class="ownership-item" style="grid-column: span 2;"><span class="ownership-label">Address:</span><span class="ownership-value">${naIf2a(
                          entry.section2a.address
                        )}</span></div>
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 2(b): MULTI-OWNER BUILDING</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item"><span class="ownership-label">Municipal ID:</span><span class="ownership-value">${naIf2b(
                          entry.section2b.municipalId
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Property Type:</span><span class="ownership-value">${naIf2b(
                          entry.section2b.propertyType
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Usage:</span><span class="ownership-value">${naIf2b(
                          entry.section2b.usage
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Apartment:</span><span class="ownership-value">${naIf2b(
                          entry.section2b.apartmentName
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Floor No.:</span><span class="ownership-value">${naIf2b(
                          entry.section2b.floorNo
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Flat No.:</span><span class="ownership-value">${naIf2b(
                          entry.section2b.flatNo
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Owner Name:</span><span class="ownership-value">${naIf2b(
                          entry.section2b.ownerName
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Super Built-up (sq m):</span><span class="ownership-value">${naIf2b(
                          entry.section2b.superBuiltUp
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Parking (sq m):</span><span class="ownership-value">${naIf2b(
                          entry.section2b.parkingArea
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Garage (sq m):</span><span class="ownership-value">${naIf2b(
                          entry.section2b.garageArea
                        )}</span></div>
                        <div class="ownership-item" style="grid-column: span 2;"><span class="ownership-label">Address:</span><span class="ownership-value">${naIf2b(
                          entry.section2b.address
                        )}</span></div>
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 3(a): OWNER (INDIVIDUAL)</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item"><span class="ownership-label">Title Doc No.:</span><span class="ownership-value">${naIf2a(
                          entry.section3a.titleDocNo
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Owner:</span><span class="ownership-value">${naIf2a(
                          entry.section3a.ownerName
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Guardian/Spouse:</span><span class="ownership-value">${naIf2a(
                          entry.section3a.guardianSpouse
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Share:</span><span class="ownership-value">${naIf2a(
                          entry.section3a.ownershipShare
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">ID Document:</span><span class="ownership-value">${naIf2a(
                          entry.section3a.idDocument
                        )}</span></div>
                        <div class="ownership-item" style="grid-column: span 2;"><span class="ownership-label">Communication Address:</span><span class="ownership-value">${naIf2a(
                          entry.section3a.commAddress
                        )}</span></div>
                        ${
                          mode === "2a" && entry.section3a.ownerPhoto
                            ? `<div class="ownership-item" style="grid-column: span 2;"><img src="${entry.section3a.ownerPhoto}" alt="Owner Photo" style="max-width:200px;border-radius:6px;border:1px solid #ddd;"/></div>`
                            : '<div class="ownership-item" style="grid-column: span 2;">N/A</div>'
                        }
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 3(b): OWNER (SINGLE FLAT)</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item"><span class="ownership-label">Title Doc No.:</span><span class="ownership-value">${naIf2b(
                          entry.section3b.titleDocNo
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Owner:</span><span class="ownership-value">${naIf2b(
                          entry.section3b.ownerName
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Guardian/Spouse:</span><span class="ownership-value">${naIf2b(
                          entry.section3b.guardianSpouse
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Share:</span><span class="ownership-value">${naIf2b(
                          entry.section3b.ownershipShare
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">ID Document:</span><span class="ownership-value">${naIf2b(
                          entry.section3b.idDocument
                        )}</span></div>
                        <div class="ownership-item" style="grid-column: span 2;"><span class="ownership-label">Communication Address:</span><span class="ownership-value">${naIf2b(
                          entry.section3b.commAddress
                        )}</span></div>
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 4: MUTATION</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item"><span class="ownership-label">Mutation No.:</span><span class="ownership-value">${safe(
                          entry.section4.mutationNo
                        )}</span></div>
                        <div class="ownership-item"><span class="ownership-label">Mutation Date:</span><span class="ownership-value">${safe(
                          entry.section4.mutationDate
                        )}</span></div>
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 5: ENCUMBRANCES/MORTGAGE/OTHER RIGHTS</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item" style="grid-column: span 2;"><span class="ownership-value">${safe(
                          entry.section5.encumbrances
                        )}</span></div>
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 6: REMARKS</h3>
                    <div class="ownership-grid">
                        <div class="ownership-item" style="grid-column: span 2;"><span class="ownership-value">${safe(
                          entry.section6.remarks
                        )}</span></div>
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 7 & 8: MAPS</h3>
                    <div class="ownership-grid">
                        ${
                          entry.section7.locationMap
                            ? `<div class="ownership-item"><span class="ownership-label">Location Map:</span><img src="${entry.section7.locationMap}" alt="Location Map" style="max-width:220px;border:1px solid #ddd;border-radius:6px;"/></div>`
                            : ""
                        }
                        ${
                          entry.section8.overviewMap
                            ? `<div class="ownership-item"><span class="ownership-label">Overview Map:</span><img src="${entry.section8.overviewMap}" alt="Overview Map" style="max-width:220px;border:1px solid #ddd;border-radius:6px;"/></div>`
                            : ""
                        }
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 9: PHOTO</h3>
                    <div class="ownership-grid">
                        ${
                          entry.section9.buildingPhoto
                            ? `<div class="ownership-item" style="grid-column: span 2;"><img src="${entry.section9.buildingPhoto}" alt="Building/Land Photo" style="max-width:280px;border:1px solid #ddd;border-radius:6px;"/></div>`
                            : '<div class="ownership-item" style="grid-column: span 2;">N/A</div>'
                        }
                    </div>
                </div>
                <div class="ownership-section">
                    <h3>SECTION 10: DIGITAL SIGNATURE</h3>
                    <div class="ownership-grid">
                        ${
                          entry.section10.digitalSignature
                            ? `<div class="ownership-item" style="grid-column: span 2;"><img src="${entry.section10.digitalSignature}" alt="Signature" style="max-width:260px;border:1px solid #ddd;border-radius:6px;"/></div>`
                            : '<div class="ownership-item" style="grid-column: span 2;">N/A</div>'
                        }
                    </div>
                </div>
                <div class="ownership-actions">
                    <button class="ownership-btn" onclick="printUrbanPropertyForm('${propertyId}', ${JSON.stringify(
          entry
        ).replace(/"/g, "&quot;")})">üñ®Ô∏è Print Urban Property Form</button>
                    <button class="ownership-btn secondary" onclick="closeOwnershipModal()">‚ùå Close</button>
                </div>
            `;
        modal.style.display = "block";
      }

      // Function to close ownership modal
      function closeOwnershipModal() {
        const modal = document.getElementById("ownershipModal");
        modal.style.display = "none";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("ownershipModal");
        if (event.target === modal) {
          closeOwnershipModal();
        }
      };

      function applyEntryMode(mode) {
        const sec2a = document.getElementById("section-2a");
        const sec2b = document.getElementById("section-2b");
        const sec3a = document.getElementById("section-3a");
        const sec3b = document.getElementById("section-3b");
        const disableSection = (el, disabled) => {
          if (!el) return;
          el.classList.toggle("section-disabled", disabled);
          const controls = el.querySelectorAll(
            "input, select, textarea, button"
          );
          controls.forEach((c) => (c.disabled = disabled));
        };
        disableSection(sec2a, mode !== "2a");
        disableSection(sec3a, mode !== "2a");
        disableSection(sec2b, mode !== "2b");
        disableSection(sec3b, mode !== "2b");
      }

      // Radio change for entry mode
      document.addEventListener("change", function (e) {
        if (e.target && e.target.name === "oe-mode") {
          applyEntryMode(e.target.value);
        }
      });
      // ===================== PRINT URBAN PROPERTY FORM =====================
      function printUrbanPropertyForm(propertyId, entryData) {
        const safe = (v) => (v == null || v === "" ? "N/A" : v);
        const mode = entryData.mode === "2b" ? "2b" : "2a";
        const naIf2a = (v) => (mode === "2b" ? "N/A" : safe(v));
        const naIf2b = (v) => (mode === "2a" ? "N/A" : safe(v));

        // Minimal printable form using key sections (can be expanded like in BuildingOwnerEntry)
        const formHTML = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Urban Property (UrPro) Card - ${propertyId}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Times New Roman', serif;
                            line-height: 1.6;
                            background-color: white;
                            padding: 20px;
                        }
                        
                        .form-container {
                            max-width: 1200px;
                            margin: 0 auto;
                            background: white;
                            padding: 30px;
                            border: 1px solid #333;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                        }
                        
                        .header-top {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 20px;
                        }
                        
                        .logo-placeholder {
                            width: 100px;
                            height: 80px;
                            border: 2px dashed #ccc;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #666;
                            font-size: 12px;
                        }
                        
                        .main-title {
                            font-size: 16px;
                            font-weight: bold;
                            text-align: center;
                            margin-bottom: 10px;
                        }
                        
                        .subtitle {
                            font-size: 12px;
                            margin-bottom: 15px;
                        }
                        
                        .form-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 20px;
                        }
                        
                        .form-field {
                            margin-bottom: 12px;
                        }
                        
                        .form-field label {
                            font-weight: bold;
                            display: inline-block;
                            min-width: 180px;
                            font-size: 11px;
                        }
                        
                        .form-field input {
                            border: none;
                            border-bottom: 1px solid #333;
                            padding: 4px;
                            min-width: 280px;
                            font-family: inherit;
                            font-size: 11px;
                        }                 

                        input {
                            border: none;
                            background: none;
                            font-size: 9px;
                        }
                        
                        .section {
                            margin-bottom: 25px;
                            padding: 15px;
                        }
                        
                        .section-title {
                            font-size: 14px;
                            font-weight: bold;
                            margin-bottom: 0;
                            background-color: #c5c1c1 !important;
                            padding: 8px;
                            text-align: center;
                            border: 1px solid #333;
                        }
                        
                        .table-container {
                            overflow-x: auto;
                            margin-top: 0;
                            max-width: 100%;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 0;
                            table-layout: fixed;
                        }
                        
                        th, td {
                            border: 1px solid #333;
                            padding: 4px;
                            text-align: left;
                            vertical-align: top;
                            font-size: 9px;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        th {
                            background-color: #f0f0f0 !important;
                            font-weight: bold;
                            text-align: center;
                            font-size: 9px;
                        }
                        
                        /* Specific column widths for Section 2 tables */
                        .building-table th:nth-child(1), .building-table td:nth-child(1) { width: 8%; } /* Municipal ID */
                        .building-table th:nth-child(2), .building-table td:nth-child(2) { width: 10%; } /* Property Type */
                        .building-table th:nth-child(3), .building-table td:nth-child(3) { width: 12%; } /* Building Name/Apartment */
                        .building-table th:nth-child(4), .building-table td:nth-child(4) { width: 8%; } /* Total Floors/Floor No */
                        .building-table th:nth-child(5), .building-table td:nth-child(5) { width: 8%; } /* Owner Floor/Flat No */
                        .building-table th:nth-child(6), .building-table td:nth-child(6) { width: 12%; } /* Owner Name */
                        .building-table th:nth-child(7), .building-table td:nth-child(7) { width: 10%; } /* Super Built-up */
                        .building-table th:nth-child(8), .building-table td:nth-child(8) { width: 8%; } /* Parking */
                        .building-table th:nth-child(9), .building-table td:nth-child(9) { width: 8%; } /* Garage */
                        .building-table th:nth-child(10), .building-table td:nth-child(10) { width: 16%; } /* Property Address */
                        
                        .map-section {
                            text-align: center;
                            margin: 15px 0;
                        }
                        
                        .map-placeholder {
                            width: 100%;
                            height: 250px;
                            border: 2px solid #333;
                            background-color: #f9f9f9;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 12px 0;
                            position: relative;
                        }
                        
                        .compass {
                            position: absolute;
                            top: 8px;
                            right: 8px;
                            width: 50px;
                            height: 50px;
                            border: 2px solid #333;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: white;
                            font-size: 10px;
                        }
                        
                        .photo-placeholder {
                            width: 100%;
                            height: 200px;
                            border: 2px solid #333;
                            background-color: #f9f9f9;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 12px 0;
                        }
                        
                        .digital-signature {
                            text-align: center;
                            margin: 15px 0;
                        }
                        
                        .signature-placeholder {
                            width: 180px;
                            height: 80px;
                            border: 2px solid #333;
                            background-color: #000;
                            margin: 12px auto;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 10px;
                        }
                        
                        .footer-note {
                            text-align: center;
                            color: red;
                            font-weight: bold;
                            margin-top: 15px;
                            padding: 8px;
                            border: 1px solid red;
                            border-radius: 4px;
                            font-size: 11px;
                        }
                        
                        .page-number {
                            text-align: center;
                            margin-top: 15px;
                            font-weight: bold;
                            font-size: 12px;
                        }
                        
                        @media print {
                            body {
                                background: white;
                                padding: 0;
                            }
                            .form-container {
                                border: none;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="form-container">
                        <!-- Header Section -->
                        <div class="header">
                            <div class="header-top" style="display: flex; flex-direction: row;">
                                <div class="logo-placeholder">State Govt logo</div>
                                <div class="main-title">
                                    <img src="data/logo.jpg" alt="LOGO" style="width: 45%; height: 45%;">
                                    <br>Revenue/UD/LSG Department<br>Urban Property (UrPro) Card Number.........
                                </div>
                                <div class="logo-placeholder">Dept. logo</div>
                            </div>
                            <div class="subtitle">(Issued under the rule of ______ of ______ Rules 19**)</div>

                            <div class="form-info">
                                <div class="form-field">
                                    <label>FORM NO:</label><input type="text" style="min-width: 20px;" value="${safe(
                                      entryData.meta.formNo
                                    )}" readonly>
                                </div>
                                <div class="form-field">
                                    <label>Date:</label><input type="text" style="min-width: 20px;" value="${safe(
                                      entryData.meta.date
                                    )}" readonly>
                                </div>
                            </div>
                            <div class="form-field">
                                <label>Owner/s Name:</label>
                                <input type="text" value="${safe(
                                  mode === "2a"
                                    ? entryData.section2a.ownerName
                                    : entryData.section2b.ownerName
                                )}" readonly>
                            </div>
                        </div>

                        <!-- Section 1: Plot Details -->
                        <div class="section">
                            <div class="section-title">1. Plot Details</div>
                            <div class="table-container">
                                <table>
                                    <tr>
                                        <th>State/UT Name</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.state
                                        )}" readonly></td>
                                        <th>ULPIN:</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.ulpin
                                        )}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>District Name</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.district
                                        )}" readonly></td>
                                        <th>Plot ID:</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.plotId
                                        )}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>Town/City Name</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.townCity
                                        )}" readonly></td>
                                        <th>Plot Area (sq. m):</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.plotArea
                                        )}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>City Survey No.</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.surveyNo
                                        )}" readonly></td>
                                        <th rowspan="2">Plot Address with PIN Code:</th>
                                        <td rowspan="2"><input type="text" value="${safe(
                                          entryData.section1.plotAddress
                                        )}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>Ward Name & No.</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.ward
                                        )}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>Year of Commencement of Ownership:</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.yearOfOwnership
                                        )}" readonly></td>
                                        <th>Plot Owner/s Name with Father/Guardian Name:</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.plotOwnerName
                                        )}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>Property Type (Private/Government):</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.propertyType
                                        )}" readonly></td>
                                        <th>Aadhaar No. and Mobile No. of the owner/s:</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.plotOwnerAadhaar
                                        )} / ${safe(
          entryData.section1.plotOwnerMobile
        )}" readonly></td>
                                    </tr>
                                    <tr>
                                        <th>a. Central Govt.<br>b. State Govt.<br>c. Local body<br>d. Govt. Undertaking</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.govCategory
                                        )}" readonly></td>
                                        <th>Ownership/Lease Hold/Other Rights:</th>
                                        <td><input type="text" value="${safe(
                                          entryData.section1.rights
                                        )}" readonly></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Section 2: Building Details -->
                        <div class="section">        
                            <!-- 2(a) Individual Buildings -->
                            <div style="margin-bottom: 30px;">
                                <div class="section-title" style="font-size: 14px;">2. (a) Building Details in respect of individual buildings:</div>
                                <div class="table-container">
                                    <table>
                                        <tr>
                                            <th>Municipal ID</th>
                                            <th>Property Type<br>(Private/Government)</th>
                                            <th colspan="3">Purpose of Usage<br>(Commercial/Residential/Industrial/Institutional/Mixed)</th>
                                        </tr>
                                        <tr>
                                            <td rowspan="3"><input type="text" value="${naIf2a(
                                              entryData.section2a.municipalId
                                            )}" readonly></td>
                                            <td rowspan="3"><input type="text" value="${naIf2a(
                                              entryData.section2a.propertyType
                                            )}" readonly></td>
                                            <td colspan="3"><input type="text" value="${naIf2a(
                                              entryData.section2a.usage
                                            )}" readonly></td>
                                        </tr>
                                        <tr>
                                            <th>Name of the Building</th>
                                            <th>Total No. of Floors</th>
                                            <th>Owner's Floor No.</th>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="${naIf2a(
                                              entryData.section2a.buildingName
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2a(
                                              entryData.section2a.totalFloors
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2a(
                                              entryData.section2a.ownersFloorNo
                                            )}" readonly></td>
                                        </tr>
                                        <tr>
                                            <th>Name of the Owner</th>
                                            <th>Super Built-up Area<br>(sq. m)</th>
                                            <th>Parking Area<br>(sq. m)</th>
                                            <th>Garage Area<br>(sq. m)</th>
                                            <th>Property Address</th>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="${naIf2a(
                                              entryData.section2a.ownerName
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2a(
                                              entryData.section2a.superBuiltUp
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2a(
                                              entryData.section2a.parkingArea
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2a(
                                              entryData.section2a.garageArea
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2a(
                                              entryData.section2a.address
                                            )}" readonly></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 2(b) Multi-ownership Buildings -->
                            <div>
                                <div class="section-title" style="font-size: 14px;">2. (b) Building Details in respect of multi-ownership buildings:</div>
                                <div class="table-container">
                                    <table>
                                        <tr>
                                            <th>Municipal ID</th>
                                            <th>Property Type<br>(Private/Government)</th>
                                            <th colspan="3">Purpose of Usage<br>(Commercial/Residential/Industrial/Institutional/Mixed)</th>
                                        </tr>
                                        <tr>
                                            <td rowspan="3"><input type="text" value="${naIf2b(
                                              entryData.section2b.municipalId
                                            )}" readonly></td>
                                            <td rowspan="3"><input type="text" value="${naIf2b(
                                              entryData.section2b.propertyType
                                            )}" readonly></td>
                                            <td colspan="3"><input type="text" value="${naIf2b(
                                              entryData.section2b.usage
                                            )}" readonly></td>
                                        </tr>
                                        <tr>
                                            <th>Apartment Name/No.</th>
                                            <th>Floor No.</th>
                                            <th>Flat No.</th>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="${naIf2b(
                                              entryData.section2b.apartmentName
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2b(
                                              entryData.section2b.floorNo
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2b(
                                              entryData.section2b.flatNo
                                            )}" readonly></td>
                                        </tr>
                                        <tr>
                                            <th>Name of the Owner</th>
                                            <th>Super Built-up Area<br>(sq. m)</th>
                                            <th>Parking Area<br>(sq. m)</th>
                                            <th>Garage Area<br>(sq. m)</th>
                                            <th>Property Address</th>
                                        </tr>
                                        <tr>
                                            <td><input type="text" value="${naIf2b(
                                              entryData.section2b.ownerName
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2b(
                                              entryData.section2b.superBuiltUp
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2b(
                                              entryData.section2b.parkingArea
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2b(
                                              entryData.section2b.garageArea
                                            )}" readonly></td>
                                            <td><input type="text" value="${naIf2b(
                                              entryData.section2b.address
                                            )}" readonly></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Owner Details -->
                        <div class="section">           
                            <!-- 3(a) Single/Joint Owners -->
                            <div style="margin-bottom: 30px;">
                                <div class="section-title" style="font-size: 14px;">3. (a) Owner details in respect of single/joint owners in individual buildings:</div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th colspan="2">Title document No.</th>
                                                <td colspan="5"><input type="text" value="${naIf2a(
                                                  entryData.section3a.titleDocNo
                                                )}" readonly></td>
                                            </tr>
                                            <tr>
                                                <th>Sl.</th>
                                                <th>Name of the Owner</th>
                                                <th>Guardian/Spouse's Name</th>
                                                <th>Ownership Share</th>
                                                <th>Owner's identity document</th>
                                                <th>Owner's Communication Address</th>
                                                <th>Owner's Photograph</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>1</td>
                                                <td><input type="text" value="${naIf2a(
                                                  entryData.section3a.ownerName
                                                )}" readonly></td>
                                                <td><input type="text" value="${naIf2a(
                                                  entryData.section3a
                                                    .guardianSpouse
                                                )}" readonly></td>
                                                <td><input type="text" value="${naIf2a(
                                                  entryData.section3a
                                                    .ownershipShare
                                                )}" readonly></td>
                                                <td><input type="text" value="${naIf2a(
                                                  entryData.section3a.idDocument
                                                )}" readonly></td>
                                                <td><input type="text" value="${naIf2a(
                                                  entryData.section3a
                                                    .commAddress
                                                )}" readonly></td>
                                                <td>${
                                                  entryData.section3a.ownerPhoto
                                                    ? `<img src="${entryData.section3a.ownerPhoto}" alt="Owner Photo" style="width:60px; height:60px; object-fit:cover; border:1px solid #ddd; border-radius:4px;" />`
                                                    : '<div class="photo-placeholder" style="height: 60px; font-size: 9px;">No Photo</div>'
                                                }</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 3(b) Multi-ownership Group Housing Society -->
                            <div>
                                <div class="section-title" style="font-size: 14px;">3. (b) Owner details in respect of single flat in multi-ownership Group Housing Society:</div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th colspan="2">Title document No.</th>
                                                <td colspan="5"><input type="text" value="${naIf2b(
                                                  entryData.section3b.titleDocNo
                                                )}" readonly></td>
                                            </tr>
                                            <tr>
                                                <th>Sl.</th>
                                                <th>Name of the Owner</th>
                                                <th>Guardian/Spouse's Name</th>
                                                <th>Ownership Share</th>
                                                <th>Owner's identity document</th>
                                                <th>Owner's Communication Address</th>
                                                <th>Owner's Photograph</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>1</td>
                                                <td><input type="text" value="${naIf2b(
                                                  entryData.section3b.ownerName
                                                )}" readonly></td>
                                                <td><input type="text" value="${naIf2b(
                                                  entryData.section3b
                                                    .guardianSpouse
                                                )}" readonly></td>
                                                <td><input type="text" value="${naIf2b(
                                                  entryData.section3b
                                                    .ownershipShare
                                                )}" readonly></td>
                                                <td><input type="text" value="${naIf2b(
                                                  entryData.section3b.idDocument
                                                )}" readonly></td>
                                                <td><input type="text" value="${naIf2b(
                                                  entryData.section3b
                                                    .commAddress
                                                )}" readonly></td>
                                                <td>N/A</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Section 4-6: Additional Details -->
                        <div class="section">
                            <table>
                                <thead>
                                    <tr>
                                        <th>4. Mutation No. with Date of Mutation:</th>
                                        <th>5. Encumbrances/Mortgage/Other rights:</th>
                                        <th>6. Remarks:</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" value="${safe(
                                          entryData.section4.mutationNo
                                        )} - ${safe(
          entryData.section4.mutationDate
        )}" readonly></td>
                                        <td><input type="text" value="${safe(
                                          entryData.section5.encumbrances
                                        )}" readonly></td>
                                        <td><input type="text" value="${safe(
                                          entryData.section6.remarks
                                        )}" readonly></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Section 7 & 8: Location Map & Overview Map -->
                        <div class="section">
                            <table>
                                <thead>
                                    <tr>
                                        <th>7. Location Map</th>
                                        <th>8. Overview Map</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="map-section">
                                                <div class="map-placeholder">
                                                    ${
                                                      entryData.section7
                                                        .locationMap
                                                        ? `<img src="${entryData.section7.locationMap}" alt="Location Map" style="width:100%; height:100%; object-fit:contain; border-radius:4px;" />`
                                                        : `<div style="position: relative; width: 100%; height: 100%;">
                                                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                                                <div style="font-size: 12px; margin-bottom: 8px;">Schematic Location Map</div>
                                                                <div style="font-size: 10px;">Property ID: ${propertyId}</div>
                                                                <div style="font-size: 10px;">Floor: ${safe(
                                                                  entryData.meta
                                                                    .ownerFloorNo
                                                                )}</div>
                                                                <div style="font-size: 10px;">No Map Available</div>
                                                            </div>
                                                            <div class="compass">
                                                                <div style="text-align: center;">
                                                                    <div style="font-size: 10px;">N</div>
                                                                    <div style="display: flex; justify-content: space-between; font-size: 10px;">
                                                                        <span>W</span><span>E</span>
                                                                    </div>
                                                                    <div style="font-size: 10px;">S</div>
                                                                </div>
                                                            </div>
                                                        </div>`
                                                    }
                                                </div>
                                                <div style="margin-top: 10px;">
                                                    <div>Property ID: ${propertyId}</div>
                                                    <div>Land Record Area = ${safe(
                                                      entryData.section1
                                                        .plotArea
                                                    )} sq. m</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="map-section">
                                                <div class="map-placeholder">
                                                    ${
                                                      entryData.section8
                                                        .overviewMap
                                                        ? `<img src="${entryData.section8.overviewMap}" alt="Overview Map" style="width:100%; height:100%; object-fit:contain; border-radius:4px;" />`
                                                        : `<div style="text-align: center; color: #666;">
                                                            <div style="font-size: 14px; margin-bottom: 8px;">Aerial/Satellite Overview</div>
                                                            <div style="font-size: 10px;">No Overview Map Available</div>
                                                            <div style="font-size: 10px;">Red outline indicates subject property</div>
                                                        </div>`
                                                    }
                                                </div>
                                                <div style="text-align: center; font-style: italic; font-size: 10px;">Not to the Scale</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Section 9 & 10: Photo of the Building /If Land then with Neighbouring Structures & Digital Signature -->
                        <div class="section">
                            <table>
                                <thead>
                                    <tr>
                                        <th>9. Photo of the Building /If Land then with Neighbouring Structures</th>
                                        <th>10. Digital Signature</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="photo-placeholder">
                                                ${
                                                  entryData.section9
                                                    .buildingPhoto
                                                    ? `<img src="${entryData.section9.buildingPhoto}" alt="Building Photo" style="width:100%; height:100%; object-fit:cover; border-radius:4px;" />`
                                                    : `<div style="text-align: center; color: #666;">
                                                        <div style="font-size: 14px; margin-bottom: 8px;">Building Photograph</div>
                                                        <div style="font-size: 10px;">No Building Photo Available</div>
                                                    </div>`
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <div class="digital-signature">
                                                <div class="signature-placeholder">
                                                    ${
                                                      entryData.section10
                                                        .digitalSignature
                                                        ? `<img src="${entryData.section10.digitalSignature}" alt="Digital Signature" style="width:100%; height:100%; object-fit:contain; border-radius:4px;" />`
                                                        : "Digital Signature<br>QR Code"
                                                    }
                                                </div>
                                                <div style="margin-top: 15px;">
                                                    <div><strong>Enquiry Officer</strong></div>
                                                    <div>City/District/State</div>
                                                    <div>Generated on date: ${new Date().toLocaleDateString()}</div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Footer Note -->
                        <div class="footer-note">
                            Note: This is a digitally signed document does not require physical signature.
                        </div>

                        <!-- Page Number -->
                        <div class="page-number">1</div>
                    </div>
                </body>
                </html>
            `;
        const w = window.open("", "_blank");
        w.document.write(formHTML);
        w.document.close();
        w.onload = function () {
          w.print();
          w.close();
        };
      }
      // Load and process GeoJSON data
      map.on("load", function () {
        // Load the GeoJSON file
        fetch("GeojsonVillage/TilangpurKotla_Village.geojson")
          .then((response) => response.json())
          .then((data) => {
            // Process the data to add height properties
            const processedData = processGeoJSONData(data);

            // Add the source
            map.addSource("buildings", {
              type: "geojson",
              data: processedData,
            });

            // Add land as 2D fill and outline from processed parcels
            addLandLayers(processedData);
            // also load persisted user buildings (if not already)
            if (typeof loadPersistedBuildings === "function") {
              setTimeout(() => {
                try {
                  loadPersistedBuildings();
                } catch (e) {}
              }, 100);
            }
          })
          .catch((error) => {
            console.error("Error loading GeoJSON:", error);
            alert("Error loading building data. Please check the file path.");
          });
      });

      // Process GeoJSON data
      function processGeoJSONData(data) {
        const features = data.features.map((feature) => {
          const properties = feature.properties;

          return {
            ...feature,
            properties: {
              ...properties,
              // Add color based on parcel type or area
              color: getBuildingColor(properties.TYPE, properties.Shape_Area),
            },
          };
        });

        return {
          type: "FeatureCollection",
          features: features,
        };
      }

      // Get color based on type and area
      function getBuildingColor(type, area) {
        if (type === "WATER BODIES") {
          return "#0066cc"; // Blue for water bodies
        } else if (type === "AGRICULTURE") {
          // Different shades of green based on area
          const normalizedArea = Math.min(area / 5000, 1);
          const green = Math.floor(100 + normalizedArea * 155);
          return `rgb(0, ${green}, 0)`;
        } else {
          return "#8B4513"; // Brown for other types
        }
      }

      // Add land as 2D fill and outline from processed parcels
      function addLandLayers(geojsonData) {
        // Source setup
        if (map.getSource("land")) {
          map.getSource("land").setData(geojsonData);
        } else {
          map.addSource("land", { type: "geojson", data: geojsonData });
        }
        // Land fill
        if (map.getLayer("land-fill")) {
          map.removeLayer("land-fill");
        }
        if (map.getLayer("land-outline")) {
          map.removeLayer("land-outline");
        }
        map.addLayer({
          id: "land-fill",
          type: "fill",
          source: "land",
          paint: {
            "fill-color": ["get", "color"],
            "fill-opacity": 0.45,
          },
        });
        map.addLayer({
          id: "land-outline",
          type: "line",
          source: "land",
          paint: {
            "line-color": "#555",
            "line-width": 0.8,
          },
        });
        // Click info for land parcels
        map.on("click", "land-fill", (e) => {
          if (!e.features || !e.features.length) return;
          const centroid = turf.centroid(e.features[0]).geometry.coordinates;
          const lon = centroid[0];
          const lat = centroid[1];

          const ulpin = ulpinGenerator(lon, lat, 0); // floor = 0 for plots

          const f = e.features[0];
          const p = f.properties || {};
          const infoDiv = document.getElementById("buildingInfo");
          const heading = document.querySelector(".info-panel h3");
          if (heading) heading.textContent = "Plot Information";
          selectedParcelFeature = f;
          window.selectedParcelFeature = f;
          selectedParcelId = p.IDS || p.TYPE || "UNKNOWN";
          currentPropertyId = p.IDS || p.TYPE || "UNKNOWN";
          currentFloor = 1;
          const ownerFloor = currentFloor || 1;
          const propertyId = currentPropertyId;
          const propertyJson = JSON.stringify(p).replace(/\"/g, "&quot;");
          const nameSafe = (p.TYPE || "Parcel").replace(/'/g, "\\'");
          const villageSafe = (p.VILL_NM || "").replace(/'/g, "\\'");
          const subdivisionSafe = (p.SUBDIV_NM || "").replace(/'/g, "\\'");
          const districtSafe = (p.DIST_NM || "").replace(/'/g, "\\'");

          // Clear any building selection and floor highlighting when selecting land
          selectedBuildingId = null;
          clearFloorHighlighting();

          // Hide floor layout when selecting land
          showFloorUI(false);

          infoDiv.innerHTML = `
                    <div class="info-item"><span class="info-label">Khasra ID:</span> <span class="info-value">${
                      p.IDS || "N/A"
                    }</span></div>

                    <div class="info-item">
                      <span class="info-label">ULPIN Number:</span>
                      <!--<span class="info-value">${ulpin}</span>-->
                      <span class="info-value"
                        style="cursor: pointer; color: #60a5fa; text-decoration: underline;"
                        title="Download KML file for Plot"
                        onclick="downloadKMLForPlot()">
                        ${ulpin}
                        <button onclick="downloadKMLForPlot()" 
                                style="background: #6c757d; color: white;margin-left: .8px; padding: 2px 4px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            Download KML
                        </button>
                      </span>
                    </div>

                    <div class="info-item"><span class="info-label">Type:</span> <span class="info-value">${
                      p.TYPE || "N/A"
                    }</span></div>
                    <div class="info-item"><span class="info-label">Sub Type:</span> <span class="info-value">${
                      p.SUB_TYPE || "N/A"
                    }</span></div>
                    <div class="info-item"><span class="info-label">Village:</span> <span class="info-value">${
                      p.VILL_NM || "N/A"
                    }</span></div>
                    <div class="info-item"><span class="info-label">Subdivision:</span> <span class="info-value">${
                      p.SUBDIV_NM || "N/A"
                    }</span></div>
                    <div class="info-item"><span class="info-label">District:</span> <span class="info-value">${
                      p.DIST_NM || "N/A"
                    }</span></div>
                    <div class="info-item"><span class="info-label">Area:</span> <span class="info-value">${(
                      p.Shape_Area || 0
                    ).toFixed(2)} sq m</span></div>
                    <div class="info-item"><span class="info-label">Perimeter:</span> <span class="info-value">${(
                      p.Shape_Leng || 0
                    ).toFixed(2)} m</span></div>
                    <div style="margin-top: 15px; text-align: center; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                        <button id="view-ownership-btn" onclick="showOwnershipModal('${propertyId}', ${propertyJson})" 
                                style="display: none; background: #007bff; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üìã View Ownership Document
                        </button>
                        <button id="enter-owner-btn" onclick="openOwnerEntryModal({propertyId:'${propertyId}', name:'${nameSafe}', floors:1, village:'${villageSafe}', subdivision:'${subdivisionSafe}', district:'${districtSafe}', ownerFloor:${ownerFloor}})" 
                                style="background: #28a745; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ‚úèÔ∏è Enter Owner Details (Floor ${formatFloorLabel(
                              ownerFloor
                            )})
                        </button>
                        <button onclick="startDrawingBuilding()" 
                                style="background: #ff9900; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üìê Draw Building Footprint
                        </button>
                        <!--<button onclick="downloadKMLForPlot()" 
                                style="background: #6c757d; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üì• Download Plot KML
                        </button>-->
                    </div>
                `;

          // Refresh owner button label
          try {
            refreshEnterOwnerButtonLabel();
          } catch (e) {}
        });
        map.on(
          "mouseenter",
          "land-fill",
          () => (map.getCanvas().style.cursor = "pointer")
        );
        map.on(
          "mouseleave",
          "land-fill",
          () => (map.getCanvas().style.cursor = "")
        );
      }

      function showFloorUI(visible) {
        const layout = document.getElementById("floorLayout");
        const indicator = document.getElementById("floor-indicator");
        if (layout) layout.style.display = visible ? "block" : "none";
        if (indicator) indicator.style.display = visible ? "block" : "none";
        if (visible) {
          const cf = document.getElementById("current-floor");
          if (cf) {
            cf.textContent = formatFloorLabel(currentFloor);
          }
          // refresh floor layout button label when floor UI shown
          try {
            refreshFloorLayoutButtonLabel();
          } catch (e) {}
        }
      }

      function populateFloorSelector(floors) {
        const selector = document.getElementById("floor-selector");
        if (!selector) return;
        selector.innerHTML = "";
        for (let i = 1; i <= floors; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = `Floor ${formatFloorLabel(i)}`;
          selector.appendChild(option);
        }
        selector.value = currentFloor;
      }

      // Helper function to get ordinal suffixes
      function getOrdinal(n) {
        if (n >= 11 && n <= 13) return n + "th";
        switch (n % 10) {
          case 1:
            return n + "st";
          case 2:
            return n + "nd";
          case 3:
            return n + "rd";
          default:
            return n + "th";
        }
      }

      // Draw floor plan for the current selection (apartment-aware)
      function drawFloorPlan(floorNumber) {
        const canvas = document.getElementById("floor-plan-canvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const bid = selectedBuildingId;
        if (!bid) return;
        const commonLayout = commonFloorLayoutsByBuilding[bid];
        const showCommonLayout =
          commonLayout &&
          (currentApartment === null ||
            currentApartment === "common" ||
            document.getElementById("apartmentSelectorContainer")?.style
              .display === "none");
        if (showCommonLayout) {
          renderSavedCommonLayoutPreview(commonLayout, canvas);
          return;
        }
        const byBuilding = bid && floorLayoutsByBuilding[bid];
        const byFloor = byBuilding && byBuilding[floorNumber];
        // Support both old shape (layout) and new shape { apartments: { [apt]: layout } }
        let layout = null;
        if (byFloor && byFloor.apartments) {
          const aptKey =
            currentApartment === null || currentApartment === "common"
              ? "1"
              : String(currentApartment);
          layout = byFloor.apartments[aptKey] || null;
        } else if (byFloor) {
          layout = byFloor;
        }
        if (!layout || !Array.isArray(layout.rooms) || !layout.rooms.length) {
          // Nothing saved for this floor yet; leave canvas empty (no defaults)
          return;
        }
        // removed unused scaleX/scaleY

        // Draw background grid
        ctx.strokeStyle = "#f0f0f0";
        ctx.lineWidth = 0.5;
        for (let x = 0; x <= canvas.width; x += 20) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.stroke();
        }
        for (let y = 0; y <= canvas.height; y += 20) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        }

        // Fit rooms to entire canvas (compute world bbox and scale to fit)
        const gridW = 100,
          gridH = 80;
        let minX = gridW,
          minY = gridH,
          maxX = 0,
          maxY = 0;
        layout.rooms.forEach((r) => {
          minX = Math.min(minX, r.x);
          minY = Math.min(minY, r.y);
          maxX = Math.max(maxX, r.x + r.width);
          maxY = Math.max(maxY, r.y + r.height);
        });
        const pad = 2;
        minX = Math.max(0, minX - pad);
        minY = Math.max(0, minY - pad);
        maxX = Math.min(gridW, maxX + pad);
        maxY = Math.min(gridH, maxY + pad);
        const worldW = Math.max(1, maxX - minX);
        const worldH = Math.max(1, maxY - minY);
        const s = Math.min(canvas.width / worldW, canvas.height / worldH);
        const offX = (canvas.width - worldW * s) / 2;
        const offY = (canvas.height - worldH * s) / 2;

        layout.rooms.forEach((room) => {
          const typeColor =
            (roomTypeColors && roomTypeColors[room.type]) || "#4a4a4a";
          const x = offX + (room.x - minX) * s;
          const y = offY + (room.y - minY) * s;
          const w = room.width * s;
          const h = room.height * s;
          // fill
          ctx.fillStyle = typeColor;
          ctx.globalAlpha = 0.9;
          ctx.fillRect(x, y, w, h);
          ctx.globalAlpha = 1;
          // outline
          ctx.strokeStyle = "#1f2937";
          ctx.lineWidth = Math.max(1, 2);
          ctx.strokeRect(x, y, w, h);
          // label (white with dark halo)
          ctx.font = "10px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillStyle = "#ffffff";
          ctx.strokeStyle = "rgba(0,0,0,0.55)";
          ctx.lineWidth = 3;
          const label = room.name || room.type;
          ctx.strokeText(label, x + w / 2, y + h / 2);
          ctx.fillText(label, x + w / 2, y + h / 2);
        });
      }

      // Fetch saved layout for a building+floor and render immediately
      async function loadAndRenderFloorLayout(bid, floor) {
        try {
          if (!bid || !floor) return;
          if (currentApartment === null || currentApartment === "common") {
            return;
          }
          const apartmentValue = String(
            currentApartment === null || currentApartment === "common"
              ? 1
              : currentApartment
          );
          const params = new URLSearchParams({
            apartment: apartmentValue,
          });
          const res = await fetch(
            `${API_BASE}/api/floor-layouts/${encodeURIComponent(
              bid
            )}/${encodeURIComponent(floor)}?${params.toString()}`
          );
          if (!res.ok) return;
          const data = await res.json();
          if (data && data.layout && Array.isArray(data.layout.rooms)) {
            if (!floorLayoutsByBuilding[bid]) floorLayoutsByBuilding[bid] = {};
            if (!floorLayoutsByBuilding[bid][floor])
              floorLayoutsByBuilding[bid][floor] = { apartments: {} };
            if (!floorLayoutsByBuilding[bid][floor].apartments)
              floorLayoutsByBuilding[bid][floor].apartments = {};
            floorLayoutsByBuilding[bid][floor].apartments[apartmentValue] =
              data.layout;
            drawFloorPlan(floor);
            try {
              refreshFloorLayoutButtonLabel();
            } catch (e) {}
          }
        } catch (e) {
          // ignore
        }
      }

      // Floor selector change
      document.addEventListener("change", function (e) {
        if (e.target && e.target.id === "floor-selector") {
          currentFloor = parseInt(e.target.value, 10);

          // Update floor UI, buttons, etc.
          drawFloorPlan(currentFloor);
          showFloorUI(true);

          const indicator = document.getElementById("current-floor");
          if (indicator) {
            indicator.textContent = formatFloorLabel(currentFloor);
          }

          updateOwnerEntryButtonFloorLabel();
          try {
            refreshEnterOwnerButtonLabel();
          } catch (e) {}
          if (selectedBuildingId != null)
            setHighlightedFloor(selectedBuildingId, currentFloor);
          try {
            refreshFloorLayoutButtonLabel();
          } catch (e) {}
          try {
            refreshApartmentControls();
          } catch (e) {}

          updateFloorPniuDisplay(selectedBuildingId);
          renderRoomULPINInfo(selectedBuildingId);
        }
      });

      // Apartment selector change
      document.addEventListener("change", async function (e) {
        if (e.target && e.target.id === "apartment-selector") {
          const value = e.target.value;
          if (value === "common") {
            currentApartment = "common";
            // Ensure common layout is loaded
            if (selectedBuildingId) {
              await loadCommonLayoutForBuilding(selectedBuildingId);
            }
            drawFloorPlan(currentFloor);
            return;
          }
          const parsed = parseInt(value, 10);
          currentApartment = Number.isFinite(parsed) ? parsed : 1;
          drawFloorPlan(currentFloor);
          if (selectedBuildingId != null) {
            loadAndRenderFloorLayout(selectedBuildingId, currentFloor);
          }
        }
      });

      // Pitch and bearing controls
      const pitchInput = document.getElementById("pitchControl");
      const bearingInput = document.getElementById("bearingControl");
      const pitchValue = document.getElementById("pitchValue");
      const bearingValue = document.getElementById("bearingValue");
      pitchInput.addEventListener("input", () => {
        const p = parseInt(pitchInput.value, 10);
        pitchValue.textContent = p + "¬∞";
        map.setPitch(p);
      });
      bearingInput.addEventListener("input", () => {
        const b = parseInt(bearingInput.value, 10);
        bearingValue.textContent = b + "¬∞";
        map.setBearing(b);
      });
      // Sync UI when map is rotated/tilted via mouse
      map.on("move", () => {
        const p = Math.round(map.getPitch());
        const b = Math.round((map.getBearing() + 360) % 360);
        pitchInput.value = p;
        pitchValue.textContent = p + "¬∞";
        bearingInput.value = b;
        bearingValue.textContent = b + "¬∞";
      });

      // Add some keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        switch (e.key) {
          case "r":
            // Reset view
            map.flyTo({
              center: [77.027, 28.651],
              zoom: 16,
              pitch: 60,
              bearing: 0,
            });
            break;
        }
      });

      // ===================== OWNER ENTRY - DATA CAPTURE =====================

      function openOwnerEntryModal(prefill) {
        const modal = document.getElementById("ownerEntryModal");
        const form = document.getElementById("ownerEntryForm");
        const today = new Date();
        const dateStr = today.toISOString().slice(0, 10);
        const formNo = `FORM-${today.getFullYear()}${String(
          today.getMonth() + 1
        ).padStart(2, "0")}${String(today.getDate()).padStart(
          2,
          "0"
        )}-${today.getHours()}${String(today.getMinutes()).padStart(
          2,
          "0"
        )}${String(today.getSeconds()).padStart(2, "0")}`;

        // Reset form
        form.reset();
        document.getElementById("oe-form-no").value = formNo;
        document.getElementById("oe-date").value = dateStr;

        // Prefill building context
        const propertyId = (prefill && prefill.propertyId) || "";
        const buildingName = (prefill && prefill.name) || "";
        const floors = (prefill && prefill.floors) || "";
        const ownerFloor =
          typeof currentFloor === "number"
            ? currentFloor
            : (prefill && prefill.ownerFloor) || 1;
        const address = [
          prefill && prefill.village,
          prefill && prefill.subdivision,
          prefill && prefill.district,
        ]
          .filter(Boolean)
          .join(", ");

        document.getElementById("oe-property-id").value = propertyId;
        document.getElementById("oe-building-name").value = buildingName;
        document.getElementById("oe-total-floors").value = floors;
        document.getElementById("oe-owner-floor-no").value =
          toDisplayFloorNumber(ownerFloor);
        document.getElementById("oe-property-address").value = address;
        document.getElementById("oe-plot-address").value = address;

        // Clear preview fields
        const photoPreview = document.getElementById("oe-photo-preview");
        if (photoPreview) photoPreview.src = "";
        const bldgPhotoPreview = document.getElementById(
          "oe-building-photo-preview"
        );
        if (bldgPhotoPreview) bldgPhotoPreview.src = "";
        const signaturePad = document.getElementById("signature-pad");
        if (signaturePad) {
          const ctx = signaturePad.getContext("2d");
          ctx.clearRect(0, 0, signaturePad.width, signaturePad.height);
        }
        document.getElementById("oe-location-map-img").src = "";
        document.getElementById("oe-overview-map-img").src = "";
        const sigImgPrev = document.getElementById("signature-image-preview");
        if (sigImgPrev) sigImgPrev.src = "";

        // Show modal
        modal.style.display = "block";
      }

      function closeOwnerEntryModal() {
        const modal = document.getElementById("ownerEntryModal");
        modal.style.display = "none";
      }

      async function saveOwnerEntry() {
        const get = (id) => document.getElementById(id).value;
        const propertyId = get("oe-property-id");
        const ownerFloorInput = get("oe-owner-floor-no");
        const ownerFloorNo =
          ownerFloorInput === ""
            ? normalizeFloorNumber(currentFloor || 1)
            : fromDisplayFloorNumber(ownerFloorInput);
        const key = `${propertyId}__F${ownerFloorNo}`;
        const mode = (
          document.querySelector('input[name="oe-mode"]:checked') || {
            value: "2a",
          }
        ).value;

        const ownerPhotoUrl =
          (document.getElementById("oe-photo-preview") || {}).src || "";
        const locationMapUrl =
          (document.getElementById("oe-location-map-img") || {}).src || "";
        const overviewMapUrl =
          (document.getElementById("oe-overview-map-img") || {}).src || "";
        const buildingPhotoUrl =
          (document.getElementById("oe-building-photo-preview") || {}).src ||
          "";
        let signatureUrl = "";
        try {
          signatureUrl = document
            .getElementById("signature-pad")
            .toDataURL("image/png");
        } catch (e) {}

        const entry = {
          meta: {
            formNo: get("oe-form-no"),
            date: get("oe-date"),
            propertyId,
            ownerFloorNo,
          },
          section1: {
            state: get("oe-state"),
            district: get("oe-district"),
            townCity: get("oe-town-city"),
            surveyNo: get("oe-survey-no"),
            ward: get("oe-ward"),
            yearOfOwnership: get("oe-year-ownership"),
            propertyType: get("oe-property-type-1"),
            govCategory: get("oe-gov-category"),
            ulpin: get("oe-ulpin"),
            plotId: get("oe-plot-id"),
            plotArea: get("oe-plot-area"),
            plotAddress: get("oe-plot-address"),
            plotOwnerName: get("oe-plot-owner-name"),
            plotOwnerAadhaar: get("oe-plot-owner-aadhaar"),
            plotOwnerMobile: get("oe-plot-owner-mobile"),
            rights: get("oe-rights"),
          },
          section2a: {
            municipalId: get("oe-municipal-id-a"),
            propertyType: get("oe-property-type-2a"),
            usage: get("oe-usage-2a"),
            buildingName: get("oe-building-name"),
            totalFloors: get("oe-total-floors"),
            ownersFloorNo: get("oe-owner-floor-no"),
            ownerName: get("oe-owner-name-2a"),
            superBuiltUp: get("oe-super-built-2a"),
            parkingArea: get("oe-parking-2a"),
            garageArea: get("oe-garage-2a"),
            address: get("oe-property-address"),
          },
          section2b: {
            municipalId: get("oe-municipal-id-b"),
            propertyType: get("oe-property-type-2b"),
            usage: get("oe-usage-2b"),
            apartmentName: get("oe-apartment-name"),
            floorNo: get("oe-floor-no-b"),
            flatNo: get("oe-flat-no"),
            ownerName: get("oe-owner-name-2b"),
            superBuiltUp: get("oe-super-built-2b"),
            parkingArea: get("oe-parking-2b"),
            garageArea: get("oe-garage-2b"),
            address: get("oe-property-address-b"),
          },
          section3a: {
            titleDocNo: get("oe-title-doc-a"),
            ownerName: get("oe-owner-name-3a"),
            guardianSpouse: get("oe-guardian-3a"),
            ownershipShare: get("oe-share-3a"),
            idDocument: get("oe-id-doc-3a"),
            commAddress: get("oe-comm-address-3a"),
            ownerPhoto: ownerPhotoUrl,
          },
          section3b: {
            titleDocNo: get("oe-title-doc-b"),
            ownerName: get("oe-owner-name-3b"),
            guardianSpouse: get("oe-guardian-3b"),
            ownershipShare: get("oe-share-3b"),
            idDocument: get("oe-id-doc-3b"),
            commAddress: get("oe-comm-address-3b"),
          },
          section4: {
            mutationNo: get("oe-mutation-no"),
            mutationDate: get("oe-mutation-date"),
          },
          section5: { encumbrances: get("oe-encumbrances") },
          section6: { remarks: get("oe-remarks") },
          section7: { locationMap: locationMapUrl },
          section8: { overviewMap: overviewMapUrl },
          section9: { buildingPhoto: buildingPhotoUrl },
          section10: { digitalSignature: signatureUrl },
          mode,
        };

        if (mode === "2a") {
          entry.section2b = {
            municipalId: "",
            propertyType: "",
            usage: "",
            apartmentName: "",
            floorNo: "",
            flatNo: "",
            ownerName: "",
            superBuiltUp: "",
            parkingArea: "",
            garageArea: "",
            address: "",
          };
          entry.section3b = {
            titleDocNo: "",
            ownerName: "",
            guardianSpouse: "",
            ownershipShare: "",
            idDocument: "",
            commAddress: "",
          };
        } else {
          entry.section2a = {
            municipalId: "",
            propertyType: "",
            usage: "",
            buildingName: "",
            totalFloors: "",
            ownersFloorNo: "",
            ownerName: "",
            superBuiltUp: "",
            parkingArea: "",
            garageArea: "",
            address: "",
          };
          entry.section3a = {
            titleDocNo: "",
            ownerName: "",
            guardianSpouse: "",
            ownershipShare: "",
            idDocument: "",
            commAddress: "",
            ownerPhoto: "",
          };
        }

        try {
          const res = await fetch(`${API_BASE}/api/save-entry`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              key,
              propertyId,
              floorNo: ownerFloorNo,
              entry,
            }),
          });
          if (!res.ok) throw new Error("Failed");
          alert("Owner entry saved.");
          closeOwnerEntryModal();
          currentPropertyId = propertyId;
          currentFloor = parseInt(ownerFloorNo, 10) || 1;
          if (typeof refreshEnterOwnerButtonLabel === "function")
            refreshEnterOwnerButtonLabel();
        } catch (e) {
          alert(
            "Failed to save entry to server. Please make sure the backend is running."
          );
        }
      }

      function closeOwnerEntriesModal() {
        const modal = document.getElementById("ownerEntriesModal");
        modal.style.display = "none";
      }

      // Photo upload handler
      function handleOwnerPhotoUpload(input) {
        const file = input.files && input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (evt) {
          const img = document.getElementById("oe-photo-preview");
          if (img) img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      }

      function handleBuildingPhotoUpload(input) {
        const file = input.files && input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (evt) {
          const img = document.getElementById("oe-building-photo-preview");
          if (img) img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      }
      // Signature pad drawing
      function initSignaturePad() {
        const canvas = document.getElementById("signature-pad");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        let drawing = false;
        let rect = canvas.getBoundingClientRect();
        function pos(e) {
          const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
          const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
          return { x, y };
        }
        function start(e) {
          drawing = true;
          ctx.beginPath();
          const p = pos(e);
          ctx.moveTo(p.x, p.y);
          e.preventDefault();
        }
        function move(e) {
          if (!drawing) return;
          const p = pos(e);
          ctx.lineTo(p.x, p.y);
          ctx.strokeStyle = "#000";
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.stroke();
          e.preventDefault();
        }
        function end() {
          drawing = false;
        }
        canvas.addEventListener("mousedown", start);
        canvas.addEventListener("mousemove", move);
        window.addEventListener("mouseup", end);
        canvas.addEventListener("touchstart", start, { passive: false });
        canvas.addEventListener("touchmove", move, { passive: false });
        window.addEventListener("touchend", end);
        window.addEventListener("resize", () => {
          rect = canvas.getBoundingClientRect();
        });
        document
          .getElementById("signature-clear")
          .addEventListener("click", () =>
            ctx.clearRect(0, 0, canvas.width, canvas.height)
          );
      }

      // Map image capture
      function captureCurrentMapTo(imgId) {
        try {
          const dataUrl = map.getCanvas().toDataURL("image/png");
          document.getElementById(imgId).src = dataUrl;
        } catch (e) {
          alert(
            "Unable to capture map image (possibly due to cross-origin tile restrictions)."
          );
        }
      }

      async function captureOverviewMap() {
        const original = {
          center: map.getCenter(),
          zoom: map.getZoom(),
          pitch: map.getPitch(),
          bearing: map.getBearing(),
        };
        // Try a wider zoom for overview
        map.jumpTo({ zoom: Math.max(12, original.zoom - 4), pitch: 0 });
        // Wait a tick to render
        await new Promise((r) => setTimeout(r, 300));
        captureCurrentMapTo("oe-overview-map-img");
        // Restore view
        map.jumpTo(original);
      }

      // Upload an image file to backend and set <img> by id
      async function uploadImageTo(imgId) {
        try {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.addEventListener("change", async function (e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const fd = new FormData();
            fd.append("file", file);
            const res = await fetch(`${API_BASE}/api/upload-image`, {
              method: "POST",
              body: fd,
            });
            if (!res.ok) throw new Error("Upload failed");
            const data = await res.json();
            const url = data.url.startsWith("http")
              ? data.url
              : `${API_BASE}${data.url}`;
            const img = document.getElementById(imgId);
            if (img) img.src = url;
          });
          input.click();
        } catch (e) {
          alert("Could not upload image. Please try again.");
        }
      }

      // Convert any data URL to server URL using backend endpoint

      async function fetchEntries(propertyId, floorNo) {
        try {
          const params = new URLSearchParams({
            propertyId: propertyId || "",
            floor: String(floorNo || 1),
          });
          const res = await fetch(
            `${API_BASE}/api/entries?${params.toString()}`
          );
          if (!res.ok) return [];
          const data = await res.json();
          return Array.isArray(data.entries) ? data.entries : [];
        } catch (e) {
          return [];
        }
      }

      async function refreshEnterOwnerButtonLabel() {
        const btn = document.getElementById("enter-owner-btn");
        const viewBtn = document.getElementById("view-ownership-btn");
        if (!btn) return;
        let has = false;
        try {
          const list = await fetchEntries(
            currentPropertyId || "",
            currentFloor || 1
          );
          has = Array.isArray(list) && list.length > 0;
        } catch (e) {
          has = false;
        }
        const floorLabel = formatFloorLabel(currentFloor);
        btn.textContent = `‚úèÔ∏è ${
          has ? "Update" : "Enter"
        } Owner Details (Floor ${floorLabel})`;
        if (viewBtn) viewBtn.style.display = has ? "inline-block" : "none";
      }

      // Update Floor Layout button label based on layout presence
      function refreshFloorLayoutButtonLabel() {
        const btn = document.getElementById("floor-layout-btn");
        if (!btn) return;
        const bid = selectedBuildingId;
        const layout =
          (bid &&
            floorLayoutsByBuilding[bid] &&
            floorLayoutsByBuilding[bid][currentFloor]) ||
          null;
        const has =
          layout && Array.isArray(layout.rooms) && layout.rooms.length > 0;
        btn.textContent = has
          ? "üé® Update Floor Layout"
          : "üé® Create Floor Layout";
      }

      // ===== Apartments per floor =====
      function getApartmentCount(bid, floor) {
        const feat = (userBuildings.features || []).find(
          (f) => (f.properties && f.properties.BID) == bid
        );
        const counts =
          feat && feat.properties && feat.properties.apartmentCounts;
        const v = counts && counts[floor];
        return Math.max(1, parseInt(v || 1, 10));
      }

      async function setApartmentCount(bid, floor, count) {
        const feat = (userBuildings.features || []).find(
          (f) => (f.properties && f.properties.BID) == bid
        );
        if (!feat) return;
        if (!feat.properties) feat.properties = {};
        if (!feat.properties.apartmentCounts)
          feat.properties.apartmentCounts = {};
        feat.properties.apartmentCounts[floor] = count;
        rebuildUserBuildingsDerived();
        try {
          await updatePersistedBuilding(bid, {
            apartmentCounts: feat.properties.apartmentCounts,
          });
        } catch (e) {}
        // Also ensure layout slots exist/are pruned to match count (local only; backend is created on save)
        if (!floorLayoutsByBuilding[bid]) floorLayoutsByBuilding[bid] = {};
        if (!floorLayoutsByBuilding[bid][floor])
          floorLayoutsByBuilding[bid][floor] = { apartments: {} };
        if (!floorLayoutsByBuilding[bid][floor].apartments)
          floorLayoutsByBuilding[bid][floor].apartments = {};
        const aparts = floorLayoutsByBuilding[bid][floor].apartments;
        // remove extras
        Object.keys(aparts)
          .map((k) => parseInt(k, 10))
          .filter((k) => k > count)
          .forEach((k) => delete aparts[String(k)]);
        // ensure keys 1..count exist
        for (let i = 1; i <= count; i++) {
          if (!aparts[String(i)])
            aparts[String(i)] = { grid: { cols: 10, rows: 10 }, rooms: [] };
        }
      }

      function refreshApartmentControls() {
        const container = document.getElementById("apartmentSelectorContainer");
        const sel = document.getElementById("apartment-selector");
        if (!container || !sel) return;
        if (!selectedBuildingId || !currentFloor) {
          container.style.display = "none";
          return;
        }
        const cnt = getApartmentCount(selectedBuildingId, currentFloor);
        if (cnt <= 1) {
          container.style.display = "none";
          currentApartment = null;
          sel.innerHTML = "";
          return;
        }
        const previousValue = sel.value;
        sel.innerHTML = "";
        const commonOpt = document.createElement("option");
        commonOpt.value = "common";
        commonOpt.textContent = "Common Layout";
        sel.appendChild(commonOpt);
        for (let i = 1; i <= cnt; i++) {
          const opt = document.createElement("option");
          opt.value = String(i);
          opt.textContent = `Apartment ${i}`;
          sel.appendChild(opt);
        }
        const shouldRestore =
          previousValue &&
          sel.querySelector(`option[value="${previousValue}"]`);
        if (shouldRestore) {
          sel.value = previousValue;
          currentApartment =
            previousValue === "common" ? "common" : parseInt(previousValue, 10);
        } else {
          sel.value = "common";
          currentApartment = "common";
        }
        container.style.display = "block";
        // load layout for apartment 1 by default, or common layout if common is selected
        if (selectedBuildingId != null) {
          if (currentApartment === "common") {
            loadCommonLayoutForBuilding(selectedBuildingId).then(() => {
              drawFloorPlan(currentFloor);
            });
          } else {
            loadAndRenderFloorLayout(selectedBuildingId, currentFloor);
            drawFloorPlan(currentFloor);
          }
        }
      }

      function updateApartmentCount() {
        if (!selectedBuildingId || !currentFloor) {
          alert("Select a building and floor first.");
          return;
        }
        const current = getApartmentCount(selectedBuildingId, currentFloor);
        const input = prompt(
          "Enter number of apartments for this floor:",
          String(current)
        );
        if (input == null) return;
        const val = parseInt(input, 10);
        if (!Number.isInteger(val) || val < 1) {
          alert("Please enter an integer greater than or equal to 1.");
          return;
        }
        setApartmentCount(selectedBuildingId, currentFloor, val).then(() => {
          refreshApartmentControls();
        });
      }

      document.addEventListener("DOMContentLoaded", initSignaturePad);

      // Toggle sections for entry mode
      document.addEventListener("change", function (e) {
        if (e.target && e.target.name === "oe-mode") {
          const mode = e.target.value;
          const sec2a = document.getElementById("section-2a-details");
          const sec2b = document.getElementById("section-2b-details");
          const sec3a = document.getElementById("section-3a-details");
          const sec3b = document.getElementById("section-3b-details");
          const toggle = (el, on) => {
            if (!el) return;
            el.classList.toggle("section-disabled", !on);
            el.querySelectorAll("input,select,textarea,button").forEach(
              (c) => (c.disabled = !on)
            );
          };
          toggle(sec2a, mode === "2a");
          toggle(sec3a, mode === "2a");
          toggle(sec2b, mode === "2b");
          toggle(sec3b, mode === "2b");
        }
      });

      function updateOwnerEntryButtonFloorLabel() {
        const label = formatFloorLabel(currentFloor);
        document.querySelectorAll(".owner-entry-floor-label").forEach((el) => {
          el.textContent = label;
        });
      }

      // ===================== FLOOR LAYOUT DESIGNER =====================

      // Global variables for floor layout designer
      let floorDesignerState = {
        gridCols: 10,
        gridRows: 10,
        cellSize: 40,
        selectedTool: "select",
        selectedRoomType: "office",
        selectedCells: [],
        rooms: [],
        selectedRoom: null,
        isDragging: false,
        dragStart: null,
        undoStack: [],
        redoStack: [],
        currentFloor: 1,
      };

      // Room type colors mapping
      const roomTypeColors = {
        office: "#4a90e2",
        meeting: "#e74c3c",
        lobby: "#27ae60",
        reception: "#16a085",
        elevator: "#f39c12",
        stairs: "#9b59b6",
        bathroom: "#34495e",
        kitchen: "#e67e22",
        waiting: "#95a5a6",
        security: "#c0392b",
        storage: "#7f8c8d",
        breakroom: "#f1c40f",
        utility: "#8e44ad",
        pantry: "#d35400",
        gym: "#e91e63",
        lounge: "#00bcd4",
        shower: "#607d8b",
        executive: "#9c27b0",
        boardroom: "#ff5722",
        penthouse: "#ff9800",
        bedroom: "#795548",
        dining: "#4caf50",
        terrace: "#8bc34a",
        custom: "#6c757d",
      };

      async function openFloorLayoutDesigner() {
        if (!selectedBuildingId) {
          alert("Select a building first.");
          return;
        }
        const modal = document.getElementById("floorLayoutDesignerModal");
        if (!modal) return;

        // Initialize with current floor
        floorDesignerState.currentFloor = currentFloor;

        // Show modal first
        setInfoPanelOverlay(true);
        modal.style.display = "block";

        // Load existing layout if available
        await loadExistingLayout();

        // Initialize grid
        updateGrid();

        // Initialize event listeners
        initializeFloorDesignerEvents();
      }

      function closeFloorLayoutDesigner() {
        const modal = document.getElementById("floorLayoutDesignerModal");
        if (modal) modal.style.display = "none";
        setInfoPanelOverlay(false);
      }

      async function loadExistingLayout() {
        // First try to load from local floorLayouts using currentApartment
        const bid = selectedBuildingId;
        const floorNo = floorDesignerState.currentFloor;
        const aptKey =
          currentApartment === null || currentApartment === "common"
            ? "1"
            : String(currentApartment);
        const byBuilding = bid && floorLayoutsByBuilding[bid];
        const byFloor = byBuilding && byBuilding[floorNo];
        let localLayout = null;
        if (byFloor && byFloor.apartments) {
          localLayout = byFloor.apartments[aptKey] || null;
        } else if (byFloor) {
          // backward-compat single layout for the whole floor
          localLayout = byFloor;
        }
        if (localLayout && localLayout.rooms) {
          floorDesignerState.rooms = JSON.parse(
            JSON.stringify(localLayout.rooms)
          );
          if (localLayout.grid) {
            const { cols, rows } = localLayout.grid;
            const gc = document.getElementById("grid-cols");
            const gr = document.getElementById("grid-rows");
            if (gc) gc.value = cols || 10;
            if (gr) gr.value = rows || 10;
          }
        } else {
          floorDesignerState.rooms = [];
        }

        // Also try to load from backend for the selected apartment if we have a building ID
        if (selectedBuildingId) {
          try {
            const params = new URLSearchParams({ apartment: aptKey });
            const response = await fetch(
              `${API_BASE}/api/floor-layouts/${selectedBuildingId}/${floorNo}?${params.toString()}`
            );
            if (response.ok) {
              const data = await response.json();
              if (data.layout && data.layout.rooms) {
                floorDesignerState.rooms = JSON.parse(
                  JSON.stringify(data.layout.rooms)
                );
                if (data.layout.grid) {
                  const { cols, rows } = data.layout.grid;
                  const gc = document.getElementById("grid-cols");
                  const gr = document.getElementById("grid-rows");
                  if (gc) gc.value = cols || 10;
                  if (gr) gr.value = rows || 10;
                }
              }
            }
          } catch (e) {
            console.warn("Error loading floor layout from backend:", e);
          }
        }
      }

      function updateGrid() {
        const canvas = document.getElementById("floorDesignerCanvas");
        if (!canvas) return;

        floorDesignerState.gridCols =
          parseInt(document.getElementById("grid-cols").value) || 10;
        floorDesignerState.gridRows =
          parseInt(document.getElementById("grid-rows").value) || 10;

        // Calculate cell size so grid fills canvas without scrollbars
        const canvasRect = canvas.getBoundingClientRect();
        const cw = Math.max(0, canvasRect.width);
        const ch = Math.max(0, canvasRect.height);
        const cellW = Math.floor(cw / floorDesignerState.gridCols);
        const cellH = Math.floor(ch / floorDesignerState.gridRows);
        floorDesignerState.cellSize = Math.max(8, Math.min(cellW, cellH));

        renderGrid();
        renderRooms();
      }

      function renderGrid() {
        const canvas = document.getElementById("floorDesignerCanvas");
        if (!canvas) return;

        // Clear existing grid cells
        const existingCells = canvas.querySelectorAll(".grid-cell");
        existingCells.forEach((cell) => cell.remove());

        // Create new grid cells
        for (let row = 0; row < floorDesignerState.gridRows; row++) {
          for (let col = 0; col < floorDesignerState.gridCols; col++) {
            const cell = document.createElement("div");
            cell.className = "grid-cell";
            cell.style.left = col * floorDesignerState.cellSize + "px";
            cell.style.top = row * floorDesignerState.cellSize + "px";
            cell.style.width = floorDesignerState.cellSize + "px";
            cell.style.height = floorDesignerState.cellSize + "px";
            cell.dataset.row = row;
            cell.dataset.col = col;

            cell.addEventListener("click", (e) => handleCellClick(e, row, col));
            cell.addEventListener("mousedown", (e) =>
              handleCellMouseDown(e, row, col)
            );
            cell.addEventListener("mouseover", (e) =>
              handleCellMouseOver(e, row, col)
            );

            canvas.appendChild(cell);
          }
        }
      }

      function renderRooms() {
        const canvas = document.getElementById("floorDesignerCanvas");
        if (!canvas) return;

        // Clear existing room blocks
        const existingRooms = canvas.querySelectorAll(".room-block");
        existingRooms.forEach((room) => room.remove());

        // Render each room
        floorDesignerState.rooms.forEach((room, index) => {
          const roomBlock = document.createElement("div");
          roomBlock.className = `room-block ${room.type}`;
          roomBlock.style.left = room.x * floorDesignerState.cellSize + "px";
          roomBlock.style.top = room.y * floorDesignerState.cellSize + "px";
          roomBlock.style.width =
            room.width * floorDesignerState.cellSize + "px";
          roomBlock.style.height =
            room.height * floorDesignerState.cellSize + "px";
          roomBlock.textContent = room.name || room.type;
          roomBlock.dataset.roomIndex = index;

          roomBlock.addEventListener("click", (e) => selectRoom(index, e));
          roomBlock.addEventListener("mousedown", (e) =>
            startRoomDrag(e, index)
          );

          // Add resize handles (east, south, southeast)
          ["e", "s", "se"].forEach((dir) => {
            const h = document.createElement("div");
            h.className = `resize-handle rh-${dir}`;
            h.addEventListener("mousedown", (e) => startResize(e, index, dir));
            roomBlock.appendChild(h);
          });

          canvas.appendChild(roomBlock);
        });
      }

      function startResize(e, roomIndex, dir) {
        e.stopPropagation();
        const start = { mx: e.clientX, my: e.clientY };
        const original = Object.assign({}, floorDesignerState.rooms[roomIndex]);
        const onMove = (ev) => {
          const dx = ev.clientX - start.mx;
          const dy = ev.clientY - start.my;
          const cs = floorDesignerState.cellSize;
          const updated = Object.assign({}, original);
          if (dir.indexOf("e") !== -1) {
            updated.width = Math.max(1, Math.round(original.width + dx / cs));
          }
          if (dir.indexOf("s") !== -1) {
            updated.height = Math.max(1, Math.round(original.height + dy / cs));
          }
          floorDesignerState.rooms[roomIndex] = updated;
          renderRooms();
        };
        const onUp = () => {
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        };
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      }

      function handleCellClick(e, row, col) {
        if (floorDesignerState.selectedTool === "create") {
          createRoomAtCell(row, col);
        } else if (floorDesignerState.selectedTool === "select") {
          selectCell(row, col);
        }
      }

      function handleCellMouseDown(e, row, col) {
        if (floorDesignerState.selectedTool === "create") {
          floorDesignerState.isDragging = true;
          floorDesignerState.dragStart = { row, col };
          floorDesignerState.selectedCells = [{ row, col }];
          updateCellSelection();
        }
      }

      function handleCellMouseOver(e, row, col) {
        if (
          floorDesignerState.isDragging &&
          floorDesignerState.selectedTool === "create"
        ) {
          const start = floorDesignerState.dragStart;
          if (start) {
            const minRow = Math.min(start.row, row);
            const maxRow = Math.max(start.row, row);
            const minCol = Math.min(start.col, col);
            const maxCol = Math.max(start.col, col);

            floorDesignerState.selectedCells = [];
            for (let r = minRow; r <= maxRow; r++) {
              for (let c = minCol; c <= maxCol; c++) {
                floorDesignerState.selectedCells.push({ row: r, col: c });
              }
            }
            updateCellSelection();
          }
        }
      }

      function updateCellSelection() {
        const cells = document.querySelectorAll(".grid-cell");
        cells.forEach((cell) => {
          const row = parseInt(cell.dataset.row);
          const col = parseInt(cell.dataset.col);
          const isSelected = floorDesignerState.selectedCells.some(
            (cell) => cell.row === row && cell.col === col
          );
          cell.classList.toggle("selected", isSelected);
        });
      }

      function selectCell(row, col) {
        floorDesignerState.selectedCells = [{ row, col }];
        updateCellSelection();
      }

      function createRoomAtCell(row, col) {
        const roomName =
          document.getElementById("room-name-input").value ||
          getDefaultRoomName(floorDesignerState.selectedRoomType);
        const customType = document.getElementById("custom-room-type").value;
        const notes = document.getElementById("room-notes").value;

        const room = {
          type: floorDesignerState.selectedRoomType,
          x: col,
          y: row,
          width: 1,
          height: 1,
          name: roomName,
          customType: customType,
          notes: notes,
        };

        // If we have selected cells, create room covering all selected cells
        if (floorDesignerState.selectedCells.length > 1) {
          const minRow = Math.min(
            ...floorDesignerState.selectedCells.map((c) => c.row)
          );
          const maxRow = Math.max(
            ...floorDesignerState.selectedCells.map((c) => c.row)
          );
          const minCol = Math.min(
            ...floorDesignerState.selectedCells.map((c) => c.col)
          );
          const maxCol = Math.max(
            ...floorDesignerState.selectedCells.map((c) => c.col)
          );

          room.x = minCol;
          room.y = minRow;
          room.width = maxCol - minCol + 1;
          room.height = maxRow - minRow + 1;
        }

        // Save to undo stack
        saveToUndoStack();

        floorDesignerState.rooms.push(room);
        renderRooms();

        // Clear selection
        floorDesignerState.selectedCells = [];
        updateCellSelection();
      }

      function getDefaultRoomName(roomType) {
        const typeNames = {
          office: "Office",
          meeting: "Meeting Room",
          lobby: "Main Lobby",
          reception: "Reception",
          elevator: "Elevator",
          stairs: "Stairs",
          bathroom: "Bathroom",
          kitchen: "Kitchen",
          waiting: "Waiting Area",
          security: "Security",
          storage: "Storage",
          breakroom: "Break Room",
          utility: "Utility Room",
          pantry: "Pantry",
          gym: "Gym",
          lounge: "Lounge",
          shower: "Shower Room",
          executive: "Executive Office",
          boardroom: "Board Room",
          penthouse: "Penthouse",
          bedroom: "Bedroom",
          dining: "Dining Room",
          terrace: "Terrace",
          custom: "Custom Room",
        };
        return typeNames[roomType] || "Room";
      }

      function selectRoom(index, e) {
        e.stopPropagation();

        // Deselect previous room
        const rooms = document.querySelectorAll(".room-block");
        rooms.forEach((room) => room.classList.remove("selected"));

        // Select new room
        floorDesignerState.selectedRoom = index;
        if (e.target.classList.contains("room-block")) {
          e.target.classList.add("selected");
        }

        // Update room properties panel
        const room = floorDesignerState.rooms[index];
        if (room) {
          document.getElementById("room-name-input").value = room.name || "";
          document.getElementById("custom-room-type").value =
            room.customType || "";
          document.getElementById("room-notes").value = room.notes || "";
          // update size/position text boxes when a room is selected
          const sw = document.getElementById("room-size-w");
          const sh = document.getElementById("room-size-h");
          const sx = document.getElementById("room-pos-x");
          const sy = document.getElementById("room-pos-y");
          if (sw) sw.value = Number(room.width);
          if (sh) sh.value = Number(room.height);
          if (sx) sx.value = Number(room.x);
          if (sy) sy.value = Number(room.y);
        }
      }

      function selectRoomType(type) {
        floorDesignerState.selectedRoomType = type;

        // Update button selection
        const buttons = document.querySelectorAll(".room-type-btn");
        buttons.forEach((btn) => btn.classList.remove("selected"));
        if (event && event.target) {
          event.target.classList.add("selected");
        }
      }

      function startRoomDrag(e, roomIndex) {
        if (floorDesignerState.selectedTool === "resize") {
          // Handle room resizing
          e.stopPropagation();
          // TODO: Implement room resizing functionality
        }
      }
      function setTool(tool) {
        floorDesignerState.selectedTool = tool;

        // Update tool buttons
        const toolButtons = ["tool-select", "tool-create", "tool-resize"];
        toolButtons.forEach((btnId) => {
          const btn = document.getElementById(btnId);
          if (btn) btn.classList.remove("active");
        });

        const activeBtn = document.getElementById(`tool-${tool}`);
        if (activeBtn) activeBtn.classList.add("active");

        // Update current tool display
        const currentToolSpan = document.getElementById("current-tool");
        if (currentToolSpan) {
          currentToolSpan.textContent =
            tool.charAt(0).toUpperCase() + tool.slice(1);
        }

        // Canvas hint
        const canvas = document.getElementById("floorDesignerCanvas");
        if (canvas) {
          if (tool === "create")
            canvas.title = "Drag across grid to create a room";
          else if (tool === "resize")
            canvas.title = "Use the small handles on a room to resize";
          else canvas.title = "Click a room to select";
        }

        // Clear selection when switching tools
        floorDesignerState.selectedCells = [];
        updateCellSelection();

        // Bind inputs so they update the selected room when edited
        const bind = (id, fn) => {
          const el = document.getElementById(id);
          if (el && !el._bound) {
            el.addEventListener("input", () => {
              const idx = floorDesignerState.selectedRoom;
              if (idx == null) return;
              const room = floorDesignerState.rooms[idx];
              if (!room) return;
              fn(el, room);
              renderRooms();
            });
            el._bound = true;
          }
        };
        bind("room-size-w", (el, room) => {
          const v = Math.max(1, parseInt(el.value || "1", 10));
          room.width = v;
        });
        bind("room-size-h", (el, room) => {
          const v = Math.max(1, parseInt(el.value || "1", 10));
          room.height = v;
        });
        bind("room-pos-x", (el, room) => {
          const v = Math.max(0, parseInt(el.value || "0", 10));
          room.x = v;
        });
        bind("room-pos-y", (el, room) => {
          const v = Math.max(0, parseInt(el.value || "0", 10));
          room.y = v;
        });
      }

      function deleteSelectedRoom() {
        if (floorDesignerState.selectedRoom !== null) {
          saveToUndoStack();
          floorDesignerState.rooms.splice(floorDesignerState.selectedRoom, 1);
          floorDesignerState.selectedRoom = null;
          renderRooms();
        }
      }

      function clearAllRooms() {
        if (confirm("Are you sure you want to clear all rooms?")) {
          saveToUndoStack();
          floorDesignerState.rooms = [];
          floorDesignerState.selectedRoom = null;
          renderRooms();
        }
      }

      function clearGrid() {
        floorDesignerState.selectedCells = [];
        updateCellSelection();
      }

      function saveToUndoStack() {
        floorDesignerState.undoStack.push(
          JSON.stringify(floorDesignerState.rooms)
        );
        floorDesignerState.redoStack = []; // Clear redo stack when new action is performed
      }

      function undoAction() {
        if (floorDesignerState.undoStack.length > 0) {
          const previousState = floorDesignerState.undoStack.pop();
          floorDesignerState.redoStack.push(
            JSON.stringify(floorDesignerState.rooms)
          );
          floorDesignerState.rooms = JSON.parse(previousState);
          renderRooms();
        }
      }

      function redoAction() {
        if (floorDesignerState.redoStack.length > 0) {
          const nextState = floorDesignerState.redoStack.pop();
          floorDesignerState.undoStack.push(
            JSON.stringify(floorDesignerState.rooms)
          );
          floorDesignerState.rooms = JSON.parse(nextState);
          renderRooms();
        }
      }

      async function saveFloorLayout() {
        // Convert rooms to the format expected by the existing system
        const layout = {
          grid: {
            cols: floorDesignerState.gridCols,
            rows: floorDesignerState.gridRows,
          },
          rooms: floorDesignerState.rooms.map((room) => ({
            type: room.type,
            x: room.x,
            y: room.y,
            width: room.width,
            height: room.height,
            name: room.name || getDefaultRoomName(room.type),
          })),
        };

        // Save locally scoped to building
        if (selectedBuildingId) {
          if (!floorLayoutsByBuilding[selectedBuildingId])
            floorLayoutsByBuilding[selectedBuildingId] = {};
          const f = floorDesignerState.currentFloor;
          if (!floorLayoutsByBuilding[selectedBuildingId][f]) {
            floorLayoutsByBuilding[selectedBuildingId][f] = { apartments: {} };
          }
          if (!floorLayoutsByBuilding[selectedBuildingId][f].apartments) {
            floorLayoutsByBuilding[selectedBuildingId][f].apartments = {};
          }
          const aptKey =
            currentApartment === null || currentApartment === "common"
              ? "1"
              : String(currentApartment);
          floorLayoutsByBuilding[selectedBuildingId][f].apartments[aptKey] =
            layout;
        }

        // Update the floor plan display
        drawFloorPlan(floorDesignerState.currentFloor);

        // Save to backend if we have a building ID
        if (selectedBuildingId) {
          try {
            const response = await fetch(`${API_BASE}/api/floor-layouts`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                buildingId: selectedBuildingId,
                floorNumber: floorDesignerState.currentFloor,
                layout: layout,
                apartment:
                  currentApartment === null || currentApartment === "common"
                    ? "1"
                    : String(currentApartment),
              }),
            });

            if (!response.ok) {
              console.warn("Failed to save floor layout to backend");
            }
          } catch (e) {
            console.warn("Error saving floor layout to backend:", e);
          }
        }

        // Close the designer
        closeFloorLayoutDesigner();

        alert("Floor layout saved successfully!");
        try {
          refreshFloorLayoutButtonLabel();
        } catch (e) {}
      }

      function initializeFloorDesignerEvents() {
        // Add global mouse up event to stop dragging
        document.addEventListener("mouseup", () => {
          floorDesignerState.isDragging = false;
          floorDesignerState.dragStart = null;
        });

        // Initialize room type selection
        selectRoomType("office");

        // Add event listeners for room property updates
        document
          .getElementById("room-name-input")
          .addEventListener("input", updateSelectedRoomProperties);
        document
          .getElementById("custom-room-type")
          .addEventListener("input", updateSelectedRoomProperties);
        document
          .getElementById("room-notes")
          .addEventListener("input", updateSelectedRoomProperties);
      }

      function updateSelectedRoomProperties() {
        if (floorDesignerState.selectedRoom !== null) {
          const room =
            floorDesignerState.rooms[floorDesignerState.selectedRoom];
          if (room) {
            room.name = document.getElementById("room-name-input").value;
            room.customType = document.getElementById("custom-room-type").value;
            room.notes = document.getElementById("room-notes").value;

            // Update the room display
            renderRooms();
          }
        }
      }

      // ===================== COMMON FLOOR LAYOUT DESIGNER =====================
      const commonFloorDesignerState = {
        mode: "move",
        rooms: [],
        currentRoomType: "office",
        dragState: null,
        bounds: null,
        buildingBID: null,
        drawingPoints: [], // For polygon drawing
        selectedRoomId: null, // For edit mode
        dragging: null, // For edit mode vertex dragging
      };

      function ensureCommonDesignerSetup() {
        if (ensureCommonDesignerSetup._initialized) return;
        const canvas = document.getElementById("commonFloorCanvas");
        if (!canvas) return;
        canvas.addEventListener("mousedown", handleCommonCanvasMouseDown);
        canvas.addEventListener("dblclick", handleCommonCanvasDoubleClick);
        window.addEventListener("mousemove", handleCommonCanvasMouseMove);
        window.addEventListener("mouseup", handleCommonCanvasMouseUp);
        setCommonCanvasMode("move");
        ensureCommonDesignerSetup._initialized = true;
      }

      function initializeCommonRoomTypeButtons() {
        const selector = document.getElementById("common-room-type-selector");
        if (!selector || selector.childElementCount) return;
        Object.keys(roomTypeColors).forEach((type, index) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = `room-type-btn ${type}`;
          btn.textContent = type.replace(/^\w/, (c) => c.toUpperCase());
          btn.addEventListener("click", () => {
            document
              .querySelectorAll("#common-room-type-selector .room-type-btn")
              .forEach((el) => el.classList.remove("selected"));
            btn.classList.add("selected");
            commonFloorDesignerState.currentRoomType = type;
          });
          if (index === 0) btn.classList.add("selected");
          selector.appendChild(btn);
        });
      }

      function setCommonCanvasMode(mode) {
        commonFloorDesignerState.mode = mode;
        [
          ["commonDrawPolygonBtn", "drawPolygon"],
          ["commonDrawBtn", "draw"],
          ["commonEditBtn", "edit"],
          ["commonMoveBtn", "move"],
          ["commonPniuBtn", "ulpin"],
        ].forEach(([id, key]) => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.classList.toggle("active", key === mode);
          }
        });
        // Show/hide Done Polygon button
        const doneBtn = document.getElementById("commonDonePolygonBtn");
        if (doneBtn) {
          doneBtn.style.display =
            mode === "drawPolygon" ? "inline-block" : "none";
        }
        // Clear drawing points when entering non-draw mode
        if (mode !== "drawPolygon") {
          commonFloorDesignerState.drawingPoints = [];
          renderCommonRooms();
        }
      }

      function handleCommonCanvasMouseDown(e) {
        const canvas = document.getElementById("commonFloorCanvas");
        if (!canvas || !commonFloorDesignerState.bounds) return;
        const roomEl = e.target.closest(".common-room");
        const vertexEl = e.target.closest(".vertex-handle");
        const deleteBtn = e.target.closest(".delete-room-btn");
        const svgPolygon = e.target.closest("polygon");

        // Handle delete button click
        if (deleteBtn) {
          e.preventDefault();
          e.stopPropagation();
          const roomId = deleteBtn.dataset.roomId;
          deleteCommonRoom(roomId);
          return;
        }

        // Handle SVG polygon click
        if (svgPolygon && svgPolygon.hasAttribute("data-room-id")) {
          const roomId = svgPolygon.getAttribute("data-room-id");
          if (commonFloorDesignerState.mode === "ulpin") {
            e.preventDefault();
            setPniuForRoom(roomId, e);
            return;
          }
          if (commonFloorDesignerState.mode === "edit") {
            e.preventDefault();
            commonFloorDesignerState.selectedRoomId = roomId;
            renderCommonRooms();
            return;
          }
          if (commonFloorDesignerState.mode === "move") {
            // For polygon rooms, move mode might need different handling
            // For now, just select it
            e.preventDefault();
            commonFloorDesignerState.selectedRoomId = roomId;
            renderCommonRooms();
            return;
          }
        }

        if (commonFloorDesignerState.mode === "ulpin") {
          if (!roomEl) return;
          e.preventDefault();
          setPniuForRoom(roomEl.dataset.roomId, e);
          return;
        }

        if (commonFloorDesignerState.mode === "edit") {
          // Handle SVG circle (vertex handle) click
          if (
            e.target.tagName === "circle" &&
            e.target.hasAttribute("data-room-id")
          ) {
            e.preventDefault();
            const roomId = e.target.getAttribute("data-room-id");
            const vertexIdx = parseInt(
              e.target.getAttribute("data-vertex-idx")
            );
            const norm = getNormalizedFromCanvasEvent(e);
            commonFloorDesignerState.dragging = {
              type: "vertex",
              roomId,
              vertexIdx,
              start: norm,
            };
            commonFloorDesignerState.selectedRoomId = roomId;
            renderCommonRooms();
            return;
          }
          if (vertexEl) {
            e.preventDefault();
            const roomId = vertexEl.dataset.roomId;
            const vertexIdx = parseInt(vertexEl.dataset.vertexIdx);
            const norm = getNormalizedFromCanvasEvent(e);
            commonFloorDesignerState.dragging = {
              type: "vertex",
              roomId,
              vertexIdx,
              start: norm,
            };
            commonFloorDesignerState.selectedRoomId = roomId;
            renderCommonRooms();
            return;
          }
          // Click on room to select it
          if (roomEl) {
            e.preventDefault();
            commonFloorDesignerState.selectedRoomId = roomEl.dataset.roomId;
            renderCommonRooms();
            return;
          }
          return;
        }

        if (commonFloorDesignerState.mode === "move" && roomEl) {
          e.preventDefault();
          startCommonRoomMove(roomEl.dataset.roomId, e);
          return;
        }

        if (commonFloorDesignerState.mode === "drawPolygon") {
          e.preventDefault();
          const norm = getNormalizedFromCanvasEvent(e);
          commonFloorDesignerState.drawingPoints.push(norm);
          renderCommonRooms();
          return;
        }

        if (commonFloorDesignerState.mode === "draw") {
          e.preventDefault();
          startCommonRoomDraw(e);
        }
      }

      function startCommonRoomMove(roomId, event) {
        const room = findCommonRoom(roomId);
        if (!room) return;
        const canvas = document.getElementById("commonFloorCanvas");
        const rect = canvas.getBoundingClientRect();
        commonFloorDesignerState.dragState = {
          type: "move",
          roomId,
          startX: event.clientX,
          startY: event.clientY,
          rect,
          initialBounds: Object.assign({}, room.bounds),
        };
      }

      function startCommonRoomDraw(event) {
        const norm = getNormalizedFromCanvasEvent(event);
        const room = {
          id: `common-room-${Date.now()}`,
          type: commonFloorDesignerState.currentRoomType,
          name: `Room ${commonFloorDesignerState.rooms.length + 1}`,
          bounds: { x: norm.x, y: norm.y, width: 0.001, height: 0.001 },
          ulpin: null,
        };
        commonFloorDesignerState.rooms.push(room);
        const canvas = document.getElementById("commonFloorCanvas");
        const rect = canvas.getBoundingClientRect();
        commonFloorDesignerState.dragState = {
          type: "draw",
          roomId: room.id,
          start: norm,
          rect,
        };
        renderCommonRooms();
      }

      function handleCommonCanvasMouseMove(event) {
        // Handle edit mode vertex dragging
        if (
          commonFloorDesignerState.dragging &&
          commonFloorDesignerState.dragging.type === "vertex"
        ) {
          const drag = commonFloorDesignerState.dragging;
          const room = findCommonRoom(drag.roomId);
          if (!room || !room.polygon) return;
          const norm = getNormalizedFromCanvasEvent(event);
          room.polygon[drag.vertexIdx] = {
            x: clamp(norm.x, 0, 1),
            y: clamp(norm.y, 0, 1),
          };
          renderCommonRooms();
          return;
        }

        const drag = commonFloorDesignerState.dragState;
        if (!drag) return;
        if (drag.type === "move") {
          const room = findCommonRoom(drag.roomId);
          if (!room) return;
          const dx = drag.rect.width
            ? (event.clientX - drag.startX) / drag.rect.width
            : 0;
          const dy = drag.rect.height
            ? -(event.clientY - drag.startY) / drag.rect.height
            : 0;
          const width = room.bounds.width;
          const height = room.bounds.height;
          room.bounds.x = clamp(drag.initialBounds.x + dx, 0, 1 - width);
          room.bounds.y = clamp(drag.initialBounds.y + dy, 0, 1 - height);
        } else if (drag.type === "draw") {
          const room = findCommonRoom(drag.roomId);
          if (!room) return;
          const current = getNormalizedFromCanvasEvent(event, drag.rect);
          const x = Math.min(current.x, drag.start.x);
          const y = Math.min(current.y, drag.start.y);
          let width = Math.abs(current.x - drag.start.x);
          let height = Math.abs(current.y - drag.start.y);
          width = width < 0.01 ? 0.01 : width;
          height = height < 0.01 ? 0.01 : height;
          room.bounds.x = clamp(x, 0, 1 - width);
          room.bounds.y = clamp(y, 0, 1 - height);
          room.bounds.width = clamp(width, 0.01, 1);
          room.bounds.height = clamp(height, 0.01, 1);
        }
        renderCommonRooms();
      }

      function handleCommonCanvasMouseUp() {
        if (commonFloorDesignerState.dragging) {
          commonFloorDesignerState.dragging = null;
        }
        const drag = commonFloorDesignerState.dragState;
        if (drag && drag.type === "draw") {
          const room = findCommonRoom(drag.roomId);
          if (!room || room.bounds.width < 0.01 || room.bounds.height < 0.01) {
            commonFloorDesignerState.rooms =
              commonFloorDesignerState.rooms.filter(
                (r) => r.id !== drag.roomId
              );
            renderCommonRooms();
          }
        }
        commonFloorDesignerState.dragState = null;
      }

      function handleCommonCanvasDoubleClick(e) {
        if (commonFloorDesignerState.mode === "drawPolygon") {
          e.preventDefault();
          finalizePolygonDrawing();
        }
      }

      function finalizePolygonDrawing() {
        const pts = commonFloorDesignerState.drawingPoints || [];
        if (pts.length < 3) {
          alert("Need at least 3 points to create a polygon room.");
          return;
        }
        const room = {
          id: `common-room-${Date.now()}`,
          type: commonFloorDesignerState.currentRoomType,
          name: `Room ${commonFloorDesignerState.rooms.length + 1}`,
          bounds: null,
          polygon: pts.map((p) => ({
            x: clamp(p.x, 0, 1),
            y: clamp(p.y, 0, 1),
          })),
          ulpin: null,
        };
        commonFloorDesignerState.rooms.push(room);
        commonFloorDesignerState.drawingPoints = [];
        commonFloorDesignerState.selectedRoomId = room.id;
        // Hide Done button and switch to move mode
        const doneBtn = document.getElementById("commonDonePolygonBtn");
        if (doneBtn) {
          doneBtn.style.display = "none";
        }
        setCommonCanvasMode("move");
        renderCommonRooms();
      }

      function deleteCommonRoom(roomId) {
        commonFloorDesignerState.rooms = commonFloorDesignerState.rooms.filter(
          (r) => r.id !== roomId
        );
        if (commonFloorDesignerState.selectedRoomId === roomId) {
          commonFloorDesignerState.selectedRoomId = null;
        }
        renderCommonRooms();
      }

      function clamp(v, a, b) {
        return Math.max(a, Math.min(b, v));
      }

      function findCommonRoom(roomId) {
        return commonFloorDesignerState.rooms.find(
          (room) => room.id === roomId
        );
      }

      function getNormalizedFromCanvasEvent(event, rectOverride) {
        const canvas = document.getElementById("commonFloorCanvas");
        if (!canvas) return { x: 0, y: 0 };
        const rect = rectOverride || canvas.getBoundingClientRect();
        const x =
          rect.width === 0
            ? 0
            : clamp((event.clientX - rect.left) / rect.width, 0, 1);
        const y =
          rect.height === 0
            ? 0
            : clamp(
                (rect.height - (event.clientY - rect.top)) / rect.height,
                0,
                1
              );
        return { x, y };
      }

      function getCommonCanvasSize(canvas) {
        const rect = canvas.getBoundingClientRect();
        return {
          width: rect.width || canvas.clientWidth || 1,
          height: rect.height || canvas.clientHeight || 1,
        };
      }
      function renderCommonRooms() {
        const canvas = document.getElementById("commonFloorCanvas");
        if (!canvas) return;
        // Remove only room-related elements, not the building outline SVG
        canvas
          .querySelectorAll(
            ".common-room, .ulpin-marker, .ulpin-label, .delete-room-btn, .vertex-handle, .polygon-room, .drawing-preview"
          )
          .forEach((el) => el.remove());
        if (!commonFloorDesignerState.bounds) return;
        const { width, height } = getCommonCanvasSize(canvas);
        const layoutSnapshot = {
          bounds: commonFloorDesignerState.bounds,
          rooms: commonFloorDesignerState.rooms,
        };

        // Get or create SVG element for polygon rendering
        // Preserve the building outline polygon if it exists
        let svg = canvas.querySelector("svg");
        let buildingOutlinePolygon = null;
        if (svg) {
          // Find and preserve the building outline polygon
          buildingOutlinePolygon = svg.querySelector(
            "polygon[data-building-outline]"
          );
          if (!buildingOutlinePolygon) {
            // If no building outline marker, check if there's a polygon that might be it
            const polygons = svg.querySelectorAll("polygon");
            if (polygons.length > 0) {
              // Check for building outline by fill color and stroke
              for (let poly of polygons) {
                if (
                  poly.getAttribute("fill") === "#f8fafc" &&
                  poly.getAttribute("stroke") === "#1f2937"
                ) {
                  poly.setAttribute("data-building-outline", "true");
                  buildingOutlinePolygon = poly;
                  break;
                }
              }
            }
          }
        }
        if (!svg) {
          svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("width", "100%");
          svg.setAttribute("height", "100%");
          svg.style.position = "absolute";
          svg.style.top = "0";
          svg.style.left = "0";
          svg.style.pointerEvents = "none";
          canvas.appendChild(svg);
        }
        // Enable pointer events on SVG for interactive elements
        svg.style.pointerEvents = "auto";

        // Clear previous room polygon elements, but preserve building outline
        svg
          .querySelectorAll(
            "polygon:not([data-building-outline]), polyline, circle"
          )
          .forEach((el) => el.remove());

        // Re-add building outline if it was preserved
        if (
          buildingOutlinePolygon &&
          !svg.querySelector("polygon[data-building-outline]")
        ) {
          svg.appendChild(buildingOutlinePolygon);
        }

        commonFloorDesignerState.rooms.forEach((room) => {
          const isSelected =
            commonFloorDesignerState.selectedRoomId === room.id;
          const isPolygon = room.polygon && room.polygon.length >= 3;

          if (isPolygon) {
            // Render polygon room
            const points = room.polygon
              .map((p) => `${p.x * width},${(1 - p.y) * height}`)
              .join(" ");
            const poly = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "polygon"
            );
            poly.setAttribute("points", points);
            poly.setAttribute(
              "fill",
              isSelected ? "#bde4ff" : roomTypeColors[room.type] || "#cbeafe"
            );
            poly.setAttribute("stroke", "#0b1220");
            poly.setAttribute("stroke-width", "2");
            poly.setAttribute("data-room-id", room.id);
            poly.style.pointerEvents = "all";
            poly.style.cursor = "pointer";
            svg.appendChild(poly);

            // Add vertex handles in edit mode
            if (commonFloorDesignerState.mode === "edit" && isSelected) {
              room.polygon.forEach((pt, idx) => {
                const vx = pt.x * width;
                const vy = (1 - pt.y) * height;
                const circle = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "circle"
                );
                circle.setAttribute("cx", vx);
                circle.setAttribute("cy", vy);
                circle.setAttribute("r", "6");
                circle.setAttribute("fill", "#06223a");
                circle.setAttribute("stroke", "#60a5fa");
                circle.setAttribute("stroke-width", "2");
                circle.setAttribute("data-room-id", room.id);
                circle.setAttribute("data-vertex-idx", idx);
                circle.classList.add("vertex-handle");
                circle.style.pointerEvents = "all";
                circle.style.cursor = "move";
                svg.appendChild(circle);
              });
            }

            // Add delete button
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-room-btn";
            deleteBtn.dataset.roomId = room.id;
            deleteBtn.textContent = "√ó";
            deleteBtn.style.position = "absolute";
            deleteBtn.style.left = `${room.polygon[0].x * width - 10}px`;
            deleteBtn.style.top = `${(1 - room.polygon[0].y) * height - 10}px`;
            deleteBtn.style.width = "20px";
            deleteBtn.style.height = "20px";
            deleteBtn.style.borderRadius = "50%";
            deleteBtn.style.background = "#ef4444";
            deleteBtn.style.color = "white";
            deleteBtn.style.border = "none";
            deleteBtn.style.cursor = "pointer";
            deleteBtn.style.fontSize = "14px";
            deleteBtn.style.fontWeight = "bold";
            deleteBtn.style.zIndex = "1000";
            deleteBtn.style.pointerEvents = "all";
            canvas.appendChild(deleteBtn);
          } else {
            // Render bounds-based room
            const bounds = room.bounds || {
              x: 0,
              y: 0,
              width: 0.1,
              height: 0.1,
            };
            const roomEl = document.createElement("div");
            roomEl.className = "common-room";
            roomEl.dataset.roomId = room.id;
            roomEl.style.background = isSelected
              ? "#bde4ff"
              : roomTypeColors[room.type] || "#6b7280";
            roomEl.style.position = "absolute";
            roomEl.style.left = `${bounds.x * width}px`;
            roomEl.style.top = `${(1 - (bounds.y + bounds.height)) * height}px`;
            roomEl.style.width = `${bounds.width * width}px`;
            roomEl.style.height = `${bounds.height * height}px`;
            roomEl.style.border = isSelected
              ? "2px solid #60a5fa"
              : "1px solid #1f2937";
            roomEl.textContent = room.name || room.type;
            roomEl.style.display = "flex";
            roomEl.style.alignItems = "center";
            roomEl.style.justifyContent = "center";
            roomEl.style.fontSize = "11px";
            roomEl.style.color = "#ffffff";
            roomEl.style.textShadow = "0 1px 2px rgba(0,0,0,0.5)";
            canvas.appendChild(roomEl);

            // Add delete button
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-room-btn";
            deleteBtn.dataset.roomId = room.id;
            deleteBtn.textContent = "√ó";
            deleteBtn.style.position = "absolute";
            deleteBtn.style.left = `${bounds.x * width - 10}px`;
            deleteBtn.style.top = `${
              (1 - (bounds.y + bounds.height)) * height - 10
            }px`;
            deleteBtn.style.width = "20px";
            deleteBtn.style.height = "20px";
            deleteBtn.style.borderRadius = "50%";
            deleteBtn.style.background = "#ef4444";
            deleteBtn.style.color = "white";
            deleteBtn.style.border = "none";
            deleteBtn.style.cursor = "pointer";
            deleteBtn.style.fontSize = "14px";
            deleteBtn.style.fontWeight = "bold";
            deleteBtn.style.zIndex = "1000";
            deleteBtn.style.pointerEvents = "all";
            canvas.appendChild(deleteBtn);
          }

          // Add ulpin marker
          if (room.ulpin) {
            const dx = room.ulpin.x * width;
            const dy = (1 - room.ulpin.y) * height;
            const marker = document.createElement("div");
            marker.className = "ulpin-marker";
            marker.style.position = "absolute";
            marker.style.left = `${dx - 6}px`;
            marker.style.top = `${dy - 6}px`;
            marker.style.width = "12px";
            marker.style.height = "12px";
            marker.style.background = "#8b5cf6";
            marker.style.borderRadius = "2px";
            marker.style.zIndex = "999";
            canvas.appendChild(marker);
            const label = document.createElement("div");
            label.className = "ulpin-label";
            label.textContent = computeRoomPniuFromLayout(
              layoutSnapshot,
              room,
              currentFloor || 1
            );
            label.style.position = "absolute";
            label.style.left = `${dx + 8}px`;
            label.style.top = `${dy - 8}px`;
            label.style.fontSize = "10px";
            label.style.color = "#1f2937";
            label.style.background = "rgba(255,255,255,0.9)";
            label.style.padding = "2px 4px";
            label.style.borderRadius = "2px";
            label.style.zIndex = "999";
            canvas.appendChild(label);
          }
        });

        // Render drawing preview for polygon mode
        if (
          commonFloorDesignerState.mode === "drawPolygon" &&
          commonFloorDesignerState.drawingPoints.length > 0
        ) {
          const pts = commonFloorDesignerState.drawingPoints;
          const points = pts
            .map((p) => `${p.x * width},${(1 - p.y) * height}`)
            .join(" ");
          const polyline = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "polyline"
          );
          polyline.setAttribute("points", points);
          polyline.setAttribute("fill", "none");
          polyline.setAttribute("stroke", "#f97316");
          polyline.setAttribute("stroke-width", "2");
          svg.appendChild(polyline);

          // Draw points
          pts.forEach((p) => {
            const circle = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "circle"
            );
            circle.setAttribute("cx", p.x * width);
            circle.setAttribute("cy", (1 - p.y) * height);
            circle.setAttribute("r", "4");
            circle.setAttribute("fill", "#f97316");
            svg.appendChild(circle);
          });
        }
      }

      function fitCanvasToBounds() {
        if (!commonFloorDesignerState.bounds) return;
        const canvas = document.getElementById("commonFloorCanvas");
        if (!canvas) return;
        // Canvas is already sized to container, just ensure rooms are visible
        renderCommonRooms();
      }

      function addCommonRoom() {
        if (!commonFloorDesignerState.bounds) return;
        const room = {
          id: `common-room-${Date.now()}`,
          type: commonFloorDesignerState.currentRoomType,
          name: `Room ${commonFloorDesignerState.rooms.length + 1}`,
          bounds: { x: 0.1, y: 0.1, width: 0.2, height: 0.2 },
          ulpin: null,
        };
        commonFloorDesignerState.rooms.push(room);
        renderCommonRooms();
      }

      function clearCommonFloorPlan() {
        commonFloorDesignerState.rooms = [];
        renderCommonRooms();
      }
      async function openCommonFloorDesigner() {
        if (!selectedBuildingId) {
          alert("Select a building first.");
          return;
        }

        const feat = getBuildingFeatureById(selectedBuildingId);
        if (!feat) {
          alert("Building not found.");
          return;
        }

        commonFloorDesignerState.buildingBID = selectedBuildingId;
        ensureCommonDesignerSetup();

        const modal = document.getElementById("commonFloorDesignerModal");
        if (modal) {
          modal.style.display = "block";
          setInfoPanelOverlay(true);
          await new Promise((resolve) => setTimeout(resolve, 50));
        }
        loadBuildingShapeToCommonCanvas(feat.geometry);

        await loadCommonLayoutForBuilding(selectedBuildingId);

        setCommonCanvasMode("move");
        fitCanvasToBounds();
      }

      function closeCommonFloorDesigner() {
        const modal = document.getElementById("commonFloorDesignerModal");
        if (modal) modal.style.display = "none";
        commonFloorDesignerState.dragState = null;
        setInfoPanelOverlay(false);
      }

      async function loadCommonLayoutForBuilding(bid) {
        // First try in-memory cache
        let saved = commonFloorLayoutsByBuilding[bid];

        // If not in cache, try loading from file
        if (!saved) {
          try {
            const response = await fetch(`data/BuildingCommonFloorLayout.json`);
            if (response.ok) {
              const geojson = await response.json();
              const buildingFeature = geojson.features?.find(
                (f) => f.properties?.BID == bid
              );
              if (buildingFeature) {
                saved = convertGeoJSONToLayout(buildingFeature);
                commonFloorLayoutsByBuilding[bid] = saved;
              }
            }
          } catch (e) {
            console.warn("Failed to load from GeoJSON:", e);
          }
        }

        if (saved && Array.isArray(saved.rooms)) {
          commonFloorDesignerState.rooms = saved.rooms.map((room, index) => ({
            id: room.id || `common-room-${Date.now()}-${index}`,
            type: room.type || "office",
            name: room.name || `Room ${index + 1}`,
            bounds: room.bounds
              ? Object.assign(
                  { x: 0, y: 0, width: 0.1, height: 0.1 },
                  room.bounds
                )
              : null,
            polygon: room.polygon
              ? JSON.parse(JSON.stringify(room.polygon))
              : null,
            ulpin: room.ulpin ? Object.assign({}, room.ulpin) : null,
          }));
        } else {
          commonFloorDesignerState.rooms = [];
        }
        // Always render after loading
        renderCommonRooms();
        // Also update the preview canvas
        if (saved) {
          renderSavedCommonLayoutPreview(saved);
          drawFloorPlan(currentFloor);
        }
      }

      async function uploadCommonShapefile() {
        const fileInput = document.getElementById("commonShapefileUpload");
        if (!fileInput.files.length) {
          alert("Select SHP (.zip) file first");
          return;
        }

        if (!selectedBuildingId) {
          alert("Select a building first");
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("BID", selectedBuildingId);

        try {
          const res = await fetch(`${API_BASE}/api/upload-common-layout`, {
            method: "POST",
            body: formData,
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Upload failed");

          console.log("Uploaded SHP Parsed:", data);
          commonFloorLayoutsByBuilding[selectedBuildingId] = data.layout;

          drawFloorPlan(currentFloor);
          renderRoomULPINInfo(selectedBuildingId);
          updateFloorPniuDisplay(selectedBuildingId);

          alert("Layout imported successfully!");
        } catch (err) {
          console.error(err);
          alert("Error uploading shapefile. Check console.");
        }
      }

      function loadBuildingShapeToCommonCanvas(geometry) {
        const canvas = document.getElementById("commonFloorCanvas");
        if (!canvas) return;
        ensureCommonDesignerSetup();
        const flattened = turf.flatten(geometry);
        if (!flattened.features.length) return;
        const polygon = flattened.features[0];
        const ring = polygon.geometry.coordinates[0];
        const bbox = turf.bbox(flattened);
        const [minLon, minLat, maxLon, maxLat] = bbox;
        commonFloorDesignerState.bounds = {
          minLon,
          minLat,
          maxLon,
          maxLat,
        };
        canvas.innerHTML = "";
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "100%");
        const { width, height } = getCommonCanvasSize(canvas);
        const pointsAttr = ring
          .map(([lon, lat]) => {
            const nx = (lon - minLon) / (maxLon - minLon || Number.EPSILON);
            const ny = (lat - minLat) / (maxLat - minLat || Number.EPSILON);
            const px = nx * width;
            const py = (1 - ny) * height;
            return `${px},${py}`;
          })
          .join(" ");
        const polygonPath = document.createElementNS(svgNS, "polygon");
        polygonPath.setAttribute("points", pointsAttr);
        polygonPath.setAttribute("fill", "#f8fafc");
        polygonPath.setAttribute("stroke", "#1f2937");
        polygonPath.setAttribute("stroke-width", "2");
        polygonPath.setAttribute("data-building-outline", "true");
        svg.appendChild(polygonPath);
        canvas.appendChild(svg);
        commonFloorDesignerState.rooms = [];
        renderCommonRooms();
      }

      function collectCommonLayoutData() {
        if (!selectedBuildingId || !commonFloorDesignerState.bounds)
          return null;
        const layout = {
          BID: selectedBuildingId,
          bounds: Object.assign({}, commonFloorDesignerState.bounds),
          rooms: commonFloorDesignerState.rooms.map((room) => {
            const cloned = {
              id: room.id,
              type: room.type,
              name: room.name,
              bounds: room.bounds ? Object.assign({}, room.bounds) : null,
              polygon: room.polygon
                ? JSON.parse(JSON.stringify(room.polygon))
                : null,
              ulpin: room.ulpin ? Object.assign({}, room.ulpin) : null,
            };
            // Only compute ulpin if it doesn't exist
            if (!cloned.ulpin) {
              cloned.ulpin = computeRoomPniuFromLayout(
                { bounds: commonFloorDesignerState.bounds },
                cloned,
                1
              );
            }
            return cloned;
          }),
        };
        return layout;
      }

      function convertLayoutToGeoJSON(layout) {
        return {
          type: "Feature",
          properties: {
            BID: layout.BID,
            bounds: layout.bounds,
            rooms: layout.rooms.map((room) => ({
              id: room.id,
              type: room.type,
              name: room.name,
              bounds: room.bounds || null,
              polygon: room.polygon || null,
              ulpin: room.ulpin || null,
            })),
          },
          geometry: {
            type: "Polygon",
            coordinates: [[]], // Building outline if needed
          },
        };
      }

      function convertGeoJSONToLayout(feature) {
        const props = feature.properties || {};
        const rooms = [];
        // Extract rooms from feature properties or nested features
        if (props.rooms && Array.isArray(props.rooms)) {
          rooms.push(...props.rooms);
        }
        return {
          BID: props.BID,
          bounds: props.bounds || null,
          rooms: rooms,
        };
      }

      async function saveCommonFloorLayout() {
        if (!selectedBuildingId) {
          alert("Select a building first.");
          return;
        }
        const layout = collectCommonLayoutData();
        if (!layout) {
          alert("No layout available to save.");
          return;
        }
        commonFloorLayoutsByBuilding[selectedBuildingId] = layout;
        const roomCount = Math.max(1, layout.rooms.length || 1);
        await updateApartmentCountFromCommonLayout(
          selectedBuildingId,
          roomCount
        );

        // Save to GeoJSON file via server
        try {
          const geojsonFeature = convertLayoutToGeoJSON(layout);
          // Load existing file or create new
          let geojson = { type: "FeatureCollection", features: [] };
          try {
            const response = await fetch(`data/BuildingCommonFloorLayout.json`);
            if (response.ok) {
              geojson = await response.json();
            }
          } catch (e) {
            // File doesn't exist, create new
          }

          // Update or add feature
          const existingIdx = geojson.features.findIndex(
            (f) => f.properties?.BID == selectedBuildingId
          );
          if (existingIdx >= 0) {
            geojson.features[existingIdx] = geojsonFeature;
          } else {
            geojson.features.push(geojsonFeature);
          }

          // Save to backend using /api/save-layout endpoint
          const saveResponse = await fetch(`${API_BASE}/api/save-layout`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(geojson),
          });

          if (!saveResponse.ok) {
            const errorData = await saveResponse.json().catch(() => ({}));
            console.warn(
              "Failed to save to backend:",
              errorData.error || saveResponse.statusText
            );
            alert(
              "Layout saved in memory, but failed to save to server. Check console."
            );
          } else {
            console.log("Layout saved successfully to server");
          }
        } catch (e) {
          console.warn("Error saving to file:", e);
          alert(
            "Layout saved in memory, but failed to save to file. Check console."
          );
        }

        renderSavedCommonLayoutPreview(layout);
        drawFloorPlan(currentFloor);
        renderRoomULPINInfo(selectedBuildingId);
        updateFloorPniuDisplay(selectedBuildingId);
        closeCommonFloorDesigner();
        alert("Common floor layout saved!");
      }

      function setPniuForRoom(roomId, event) {
        const room = findCommonRoom(roomId);
        if (!room) return;
        const norm = getNormalizedFromCanvasEvent(event);
        room.ulpin = norm;
        renderCommonRooms();
      }

      function renderSavedCommonLayoutPreview(layout, targetCanvas) {
        if (!layout) return;
        const canvas =
          targetCanvas || document.getElementById("floor-plan-canvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw building outline if we have building geometry
        if (selectedBuildingId) {
          const feat = getBuildingFeatureById(selectedBuildingId);
          if (feat && feat.geometry) {
            try {
              const flattened = turf.flatten(feat.geometry);
              if (flattened.features.length > 0) {
                const polygon = flattened.features[0];
                const ring = polygon.geometry.coordinates[0];
                // Use layout bounds if available, otherwise calculate from geometry
                let bounds = layout.bounds;
                if (!bounds) {
                  const bbox = turf.bbox(flattened);
                  bounds = {
                    minLon: bbox[0],
                    minLat: bbox[1],
                    maxLon: bbox[2],
                    maxLat: bbox[3],
                  };
                }
                const { minLon, minLat, maxLon, maxLat } = bounds;
                const lonRange = maxLon - minLon || Number.EPSILON;
                const latRange = maxLat - minLat || Number.EPSILON;

                ctx.strokeStyle = "#1f2937";
                ctx.lineWidth = 2;
                ctx.fillStyle = "#f8fafc";
                ctx.beginPath();
                const firstPoint = ring[0];
                const nx = (firstPoint[0] - minLon) / lonRange;
                const ny = (firstPoint[1] - minLat) / latRange;
                ctx.moveTo(nx * canvas.width, (1 - ny) * canvas.height);
                for (let i = 1; i < ring.length; i++) {
                  const [lon, lat] = ring[i];
                  const nx = (lon - minLon) / lonRange;
                  const ny = (lat - minLat) / latRange;
                  ctx.lineTo(nx * canvas.width, (1 - ny) * canvas.height);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
              }
            } catch (e) {
              console.warn("Error drawing building outline:", e);
            }
          }
        }

        if (!layout.rooms || !layout.rooms.length) return;
        layout.rooms.forEach((room) => {
          const color = roomTypeColors[room.type] || "#6b7280";
          const isPolygon = room.polygon && room.polygon.length >= 3;

          if (isPolygon) {
            // Render polygon room
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.9;
            ctx.beginPath();
            const firstPoint = room.polygon[0];
            ctx.moveTo(
              firstPoint.x * canvas.width,
              (1 - firstPoint.y) * canvas.height
            );
            for (let i = 1; i < room.polygon.length; i++) {
              const pt = room.polygon[i];
              ctx.lineTo(pt.x * canvas.width, (1 - pt.y) * canvas.height);
            }
            ctx.closePath();
            ctx.fill();
            ctx.globalAlpha = 1;
            ctx.strokeStyle = "#1f2937";
            ctx.lineWidth = 2;
            ctx.stroke();

            // Calculate center for label
            let sumX = 0,
              sumY = 0;
            room.polygon.forEach((pt) => {
              sumX += pt.x;
              sumY += pt.y;
            });
            const centerX = (sumX / room.polygon.length) * canvas.width;
            const centerY = (1 - sumY / room.polygon.length) * canvas.height;

            ctx.fillStyle = "#ffffff";
            ctx.strokeStyle = "rgba(0,0,0,0.45)";
            ctx.lineWidth = 3;
            ctx.font = "11px Arial";
            const label = room.name || room.type;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.strokeText(label, centerX, centerY);
            ctx.fillText(label, centerX, centerY);
          } else {
            // Render bounds-based room
            const bounds = room.bounds || {
              x: 0,
              y: 0,
              width: 0.1,
              height: 0.1,
            };
            const x = bounds.x * canvas.width;
            const y = (1 - (bounds.y + bounds.height)) * canvas.height;
            const w = bounds.width * canvas.width;
            const h = bounds.height * canvas.height;
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.9;
            ctx.fillRect(x, y, w, h);
            ctx.globalAlpha = 1;
            ctx.strokeStyle = "#1f2937";
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
            ctx.fillStyle = "#ffffff";
            ctx.strokeStyle = "rgba(0,0,0,0.45)";
            ctx.lineWidth = 3;
            ctx.font = "11px Arial";
            const label = room.name || room.type;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.strokeText(label, x + w / 2, y + h / 2);
            ctx.fillText(label, x + w / 2, y + h / 2);
          }

          // Draw ulpin
          if (room.ulpin) {
            const dx = room.ulpin.x * canvas.width;
            const dy = (1 - room.ulpin.y) * canvas.height;
            ctx.fillStyle = "#dc2626";
            ctx.beginPath();
            ctx.arc(dx, dy, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#111827";
            ctx.font = "10px Arial";
            ctx.textAlign = "left";
            ctx.textBaseline = "bottom";
            const roomPniu = computeRoomPniuFromLayout(
              layout,
              room,
              currentFloor || 1
            );
            ctx.lineWidth = 2;
            ctx.strokeStyle = "white";
            ctx.strokeText(roomPniu, dx + 6, dy - 2);
            ctx.fillText(roomPniu, dx + 6, dy - 2);
          }
        });
      }

      function computeRoomPniuFromLayout(layout, room, floorNumber) {
        if (!layout || !layout.bounds) return "N/A";
        const { minLon, minLat, maxLon, maxLat } = layout.bounds;
        const spanLon = maxLon - minLon || Number.EPSILON;
        const spanLat = maxLat - minLat || Number.EPSILON;
        const bounds = room.bounds || {
          x: 0,
          y: 0,
          width: 0.1,
          height: 0.1,
        };
        const refPoint = room.ulpin || {
          x: bounds.x + bounds.width / 2,
          y: bounds.y + bounds.height / 2,
        };
        const lon = minLon + refPoint.x * spanLon;
        const lat = minLat + refPoint.y * spanLat;
        return (
          ulpinGenerator(
            lon,
            lat,
            ulpinFloorIndex(normalizeFloorNumber(floorNumber))
          ) || "N/A"
        );
      }
      async function updateApartmentCountFromCommonLayout(bid, count) {
        const feat = getBuildingFeatureById(bid);
        if (!feat) return;
        if (!feat.properties) feat.properties = {};
        if (!feat.properties.apartmentCounts)
          feat.properties.apartmentCounts = {};
        const floors = Math.max(1, parseInt(feat.properties.floors || 1, 10));
        const safeCount = Math.max(1, count);
        for (let i = 1; i <= floors; i++) {
          feat.properties.apartmentCounts[i] = safeCount;
        }
        rebuildUserBuildingsDerived();
        try {
          await updatePersistedBuilding(bid, {
            apartmentCounts: feat.properties.apartmentCounts,
          });
        } catch (err) {
          console.warn("Failed to persist apartment counts", err);
        }
        try {
          refreshApartmentControls();
        } catch (err) {
          /* ignore */
        }
      }

      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }
    </script>

    <div class="floor-indicator" id="floor-indicator" style="z-index: 2000">
      <div class="floor-number" id="current-floor">G</div>
      <div class="floor-label">Floor Level</div>
    </div>

    <!-- Ownership Document Modal -->
    <div id="ownershipModal" class="ownership-modal">
      <div class="ownership-content">
        <div class="ownership-header">
          <div class="ownership-title">üìã Ownership Document</div>
          <span class="close-ownership" onclick="closeOwnershipModal()"
            >&times;</span
          >
        </div>
        <div id="ownershipDetails">
          <!-- Ownership details will be populated here -->
        </div>
      </div>
    </div>

    <!-- ===================== OWNER DETAIL ENTRY Modal ===================== -->
    <div
      id="ownerEntryModal"
      class="owner-entry-modal"
      onclick="if(event.target===this) closeOwnerEntryModal();"
    >
      <div class="owner-entry-content">
        <div class="owner-entry-header">
          <div class="owner-entry-title">üìù Owner Entry Form</div>
          <span class="close-owner-entry" onclick="closeOwnerEntryModal()"
            >&times;</span
          >
        </div>
        <form
          id="ownerEntryForm"
          onsubmit="event.preventDefault(); saveOwnerEntry();"
        >
          <div class="entry-grid" style="margin-bottom: 8px">
            <div class="entry-item">
              <label>FORM NO.</label>
              <input id="oe-form-no" type="text" readonly />
            </div>
            <div class="entry-item">
              <label>DATE</label>
              <input id="oe-date" type="date" readonly />
            </div>
          </div>
          <div class="entry-section">
            <h3>SECTION 1: PLOT DETAILS</h3>
            <div class="entry-grid">
              <div class="entry-item">
                <label>STATE/UT NAME</label
                ><input id="oe-state" placeholder="State/UT" />
              </div>
              <div class="entry-item">
                <label>DISTRICT NAME</label
                ><input id="oe-district" placeholder="District" />
              </div>
              <div class="entry-item">
                <label>TOWN/CITY NAME</label
                ><input id="oe-town-city" placeholder="Town/City" />
              </div>
              <div class="entry-item">
                <label>CITY SURVEY NO.</label
                ><input id="oe-survey-no" placeholder="Survey No." />
              </div>
              <div class="entry-item">
                <label>WARD NAME & NO.</label
                ><input id="oe-ward" placeholder="Ward" />
              </div>
              <div class="entry-item">
                <label>YEAR OF COMMENCEMENT OF OWNERSHIP</label
                ><input
                  id="oe-year-ownership"
                  type="number"
                  min="1800"
                  max="2100"
                  placeholder="YYYY"
                />
              </div>
              <div class="entry-item">
                <label>PROPERTY TYPE (PRIVATE/GOVERNMENT)</label
                ><select id="oe-property-type-1">
                  <option>PRIVATE</option>
                  <option>GOVERNMENT</option>
                </select>
              </div>
              <div class="entry-item">
                <label>GOVT CATEGORY (A/B/C/D)</label
                ><select id="oe-gov-category">
                  <option value="">N/A</option>
                  <option>A. CENTRAL GOVT</option>
                  <option>B. STATE GOVT</option>
                  <option>C. LOCAL BODY</option>
                  <option>D. GOVT UNDERTAKING</option>
                </select>
              </div>
              <div class="entry-item">
                <label>ULPIN</label><input id="oe-ulpin" placeholder="ULPIN" />
              </div>
              <div class="entry-item">
                <label>PLOT ID.</label
                ><input id="oe-plot-id" placeholder="Plot ID" />
              </div>
              <div class="entry-item">
                <label>PLOT AREA (SQ. M)</label
                ><input
                  id="oe-plot-area"
                  type="number"
                  step="0.01"
                  placeholder="Area"
                />
              </div>
              <div class="entry-item" style="grid-column: span 2">
                <label>PLOT ADDRESS WITH PIN CODE</label
                ><input id="oe-plot-address" placeholder="Address" />
              </div>
              <div class="entry-item">
                <label>PLOT OWNER/S NAME WITH FATHER/GUARDIAN NAME</label
                ><input id="oe-plot-owner-name" placeholder="Owner Name(s)" />
              </div>
              <div class="entry-item">
                <label>AADHAAR NO.</label
                ><input id="oe-plot-owner-aadhaar" placeholder="Aadhaar" />
              </div>
              <div class="entry-item">
                <label>MOBILE NO.</label
                ><input id="oe-plot-owner-mobile" placeholder="Mobile" />
              </div>
              <div class="entry-item" style="grid-column: span 2">
                <label>OWNERSHIP/ LEASE HOLD/ OTHER RIGHTS</label
                ><input id="oe-rights" placeholder="Rights" />
              </div>
            </div>
          </div>
          <div class="entry-section">
            <h3>Entry Type</h3>
            <div class="entry-row" role="radiogroup" aria-label="Entry Type">
              <label style="display: flex; align-items: center; gap: 6px"
                ><input type="radio" name="oe-mode" value="2a" /> Individual
                Building (Sections 2a & 3a)</label
              >
              <label style="display: flex; align-items: center; gap: 6px"
                ><input type="radio" name="oe-mode" value="2b" /> Multi-owner
                Building (Sections 2b & 3b)</label
              >
            </div>
          </div>
          <div class="entry-section" id="section-2a">
            <h3>SECTION 2(a): INDIVIDUAL BUILDING DETAILS</h3>
            <div class="entry-grid">
              <div class="entry-item">
                <label>MUNICIPAL ID</label
                ><input id="oe-municipal-id-a" placeholder="Municipal ID" />
              </div>
              <div class="entry-item">
                <label>PROPERTY TYPE</label
                ><select id="oe-property-type-2a">
                  <option>PRIVATE</option>
                  <option>GOVERNMENT</option>
                </select>
              </div>
              <div class="entry-item">
                <label>PURPOSE OF USAGE</label
                ><select id="oe-usage-2a">
                  <option>COMMERCIAL</option>
                  <option>RESIDENTIAL</option>
                  <option>INDUSTRIAL</option>
                  <option>INSTITUTIONAL</option>
                  <option>MIXED</option>
                </select>
              </div>
              <div class="entry-item">
                <label>NAME OF THE BUILDING</label
                ><input id="oe-building-name" placeholder="Building Name" />
              </div>
              <div class="entry-item">
                <label>TOTAL NO. OF FLOORS</label
                ><input
                  id="oe-total-floors"
                  type="number"
                  min="1"
                  placeholder="Total Floors"
                />
              </div>
              <div class="entry-item">
                <label>OWNER'S FLOOR NO.</label
                ><input
                  id="oe-owner-floor-no"
                  type="number"
                  min="0"
                  placeholder="Owner Floor (0 = G)"
                />
              </div>
              <div class="entry-item">
                <label>NAME OF THE OWNER</label
                ><input id="oe-owner-name-2a" placeholder="Owner Name" />
              </div>
              <div class="entry-item">
                <label>SUPER BUILT-UP AREA (SQ. M)</label
                ><input id="oe-super-built-2a" type="number" step="0.01" />
              </div>
              <div class="entry-item">
                <label>PARKING AREA (SQ. M)</label
                ><input id="oe-parking-2a" type="number" step="0.01" />
              </div>
              <div class="entry-item">
                <label>GARAGE AREA (SQ. M)</label
                ><input id="oe-garage-2a" type="number" step="0.01" />
              </div>
              <div class="entry-item" style="grid-column: span 2">
                <label>PROPERTY ADDRESS</label
                ><input
                  id="oe-property-address"
                  placeholder="Property Address"
                />
              </div>
              <div class="entry-item">
                <label>PROPERTY ID</label
                ><input id="oe-property-id" placeholder="Original/Parcel ID" />
              </div>
            </div>
          </div>
          <div class="entry-section" id="section-2b">
            <h3>SECTION 2(b): MULTI-OWNER BUILDING DETAILS</h3>
            <div class="entry-grid">
              <div class="entry-item">
                <label>MUNICIPAL ID</label
                ><input id="oe-municipal-id-b" placeholder="Municipal ID" />
              </div>
              <div class="entry-item">
                <label>PROPERTY TYPE</label
                ><select id="oe-property-type-2b">
                  <option>PRIVATE</option>
                  <option>GOVERNMENT</option>
                </select>
              </div>
              <div class="entry-item">
                <label>PURPOSE OF USAGE</label
                ><select id="oe-usage-2b">
                  <option>COMMERCIAL</option>
                  <option>RESIDENTIAL</option>
                  <option>INDUSTRIAL</option>
                  <option>INSTITUTIONAL</option>
                  <option>MIXED</option>
                </select>
              </div>
              <div class="entry-item">
                <label>APARTMENT NAME/NO.</label
                ><input id="oe-apartment-name" placeholder="Apartment" />
              </div>
              <div class="entry-item">
                <label>FLOOR NO.</label
                ><input id="oe-floor-no-b" type="number" min="1" />
              </div>
              <div class="entry-item">
                <label>FLAT NO.</label
                ><input id="oe-flat-no" placeholder="Flat No." />
              </div>
              <div class="entry-item">
                <label>NAME OF THE OWNER</label
                ><input id="oe-owner-name-2b" placeholder="Owner Name" />
              </div>
              <div class="entry-item">
                <label>SUPER BUILT-UP AREA (SQ. M)</label
                ><input id="oe-super-built-2b" type="number" step="0.01" />
              </div>
              <div class="entry-item">
                <label>PARKING AREA (SQ. M)</label
                ><input id="oe-parking-2b" type="number" step="0.01" />
              </div>
              <div class="entry-item">
                <label>GARAGE AREA (SQ. M)</label
                ><input id="oe-garage-2b" type="number" step="0.01" />
              </div>
              <div class="entry-item" style="grid-column: span 2">
                <label>PROPERTY ADDRESS</label
                ><input
                  id="oe-property-address-b"
                  placeholder="Property Address"
                />
              </div>
            </div>
          </div>
          <div class="entry-section" id="section-3a">
            <h3>SECTION 3(a): OWNER DETAILS - INDIVIDUAL BUILDINGS</h3>
            <div class="entry-grid">
              <div class="entry-item">
                <label>TITLE DOCUMENT NO.</label><input id="oe-title-doc-a" />
              </div>
              <div class="entry-item">
                <label>NAME OF THE OWNER</label><input id="oe-owner-name-3a" />
              </div>
              <div class="entry-item">
                <label>GAURDIAN/SPOUSE'S NAME</label
                ><input id="oe-guardian-3a" />
              </div>
              <div class="entry-item">
                <label>OWNERSHIP SHARE</label><input id="oe-share-3a" />
              </div>
              <div class="entry-item">
                <label>OWNER'S IDENTITY DOCUMENT</label
                ><input id="oe-id-doc-3a" placeholder="Type & No." />
              </div>
              <div class="entry-item" style="grid-column: span 2">
                <label>OWNER'S COMMUNICATION ADDRESS</label
                ><input id="oe-comm-address-3a" />
              </div>
              <div class="entry-item" style="grid-column: span 2">
                <label>OWNER'S PHOTOGRAPH</label>
                <div class="entry-row">
                  <input
                    type="file"
                    accept="image/*"
                    onchange="handleOwnerPhotoUpload(this)"
                  />
                  <img
                    id="oe-photo-preview"
                    class="thumb"
                    alt="Owner photo preview"
                  />
                </div>
              </div>
            </div>
          </div>
          <div class="entry-section" id="section-3b">
            <h3>
              SECTION 3(b): OWNER DETAILS - SINGLE FLAT IN MULTI-OWNERSHIP
            </h3>
            <div class="entry-grid">
              <div class="entry-item">
                <label>TITLE DOCUMENT NO.</label><input id="oe-title-doc-b" />
              </div>
              <div class="entry-item">
                <label>NAME OF THE OWNER</label><input id="oe-owner-name-3b" />
              </div>
              <div class="entry-item">
                <label>GAURDIAN/SPOUSE'S NAME</label
                ><input id="oe-guardian-3b" />
              </div>
              <div class="entry-item">
                <label>OWNERSHIP SHARE</label><input id="oe-share-3b" />
              </div>
              <div class="entry-item">
                <label>OWNER'S IDENTITY DOCUMENT</label
                ><input id="oe-id-doc-3b" placeholder="Type & No." />
              </div>
              <div class="entry-item" style="grid-column: span 2">
                <label>OWNER'S COMMUNICATION ADDRESS</label
                ><input id="oe-comm-address-3b" />
              </div>
            </div>
          </div>
          <div class="entry-section">
            <h3>SECTION 4: MUTATION</h3>
            <div class="entry-grid">
              <div class="entry-item">
                <label>MUTATION NO.</label><input id="oe-mutation-no" />
              </div>
              <div class="entry-item">
                <label>DATE OF MUTATION</label
                ><input id="oe-mutation-date" type="date" />
              </div>
            </div>
          </div>
          <div class="entry-section">
            <h3>SECTION 5: ENCUMBRANCES/MORTGAGE/OTHER RIGHTS</h3>
            <div class="entry-item" style="grid-column: span 2">
              <textarea
                id="oe-encumbrances"
                rows="3"
                placeholder="Details..."
              ></textarea>
            </div>
          </div>
          <div class="entry-section">
            <h3>SECTION 6: REMARKS</h3>
            <div class="entry-item" style="grid-column: span 2">
              <textarea
                id="oe-remarks"
                rows="3"
                placeholder="Remarks..."
              ></textarea>
            </div>
          </div>
          <div class="entry-section">
            <h3>SECTION 7 & 8: MAP CAPTURES</h3>
            <div class="entry-grid">
              <div class="entry-item">
                <label>LOCATION MAP</label>
                <div class="entry-row">
                  <button
                    type="button"
                    class="entry-inline-btn"
                    onclick="captureCurrentMapTo('oe-location-map-img')"
                  >
                    üì∑ Capture Current View</button
                  ><button
                    type="button"
                    class="entry-inline-btn"
                    onclick="uploadImageTo('oe-location-map-img')"
                  >
                    üì§ Upload Image
                  </button>
                </div>
                <img
                  id="oe-location-map-img"
                  class="thumb"
                  alt="Location Map"
                />
                <div class="entry-note">
                  If capture fails due to cross-origin tiles: press Win+Shift+S
                  (Windows Snipping Tool), select the map area, save the image,
                  then click "Upload Image" to attach.
                </div>
              </div>
              <div class="entry-item">
                <label>OVERVIEW MAP</label>
                <div class="entry-row">
                  <button
                    type="button"
                    class="entry-inline-btn"
                    onclick="captureOverviewMap()"
                  >
                    üåç Capture Overview</button
                  ><button
                    type="button"
                    class="entry-inline-btn"
                    onclick="uploadImageTo('oe-overview-map-img')"
                  >
                    üì§ Upload Image
                  </button>
                </div>
                <img
                  id="oe-overview-map-img"
                  class="thumb"
                  alt="Overview Map"
                />
              </div>
            </div>
          </div>
          <div class="entry-section">
            <h3>SECTION 9: PHOTO OF THE BUILDING / LAND</h3>
            <div class="entry-item" style="grid-column: span 2">
              <div class="entry-note">
                Upload representative photo (optional if already attached in
                Section 3a).
              </div>
              <div class="entry-row">
                <input
                  type="file"
                  accept="image/*"
                  onchange="handleBuildingPhotoUpload(this)"
                />
              </div>
              <img
                id="oe-building-photo-preview"
                class="thumb"
                alt="Building/Land photo preview"
              />
            </div>
          </div>
          <div class="entry-section">
            <h3>SECTION 10: DIGITAL SIGNATURE</h3>
            <div class="entry-item" style="grid-column: span 2">
              <canvas id="signature-pad" width="420" height="160"></canvas>
              <div class="entry-row" style="margin-top: 6px">
                <button
                  type="button"
                  id="signature-clear"
                  class="entry-inline-btn"
                  style="background: #dc3545"
                >
                  Clear
                </button>
              </div>
              <div class="entry-row" style="margin-top: 6px">
                <input
                  type="file"
                  id="signature-image-input"
                  accept="image/*"
                  onchange="handleSignatureUpload(this)"
                />
                <button
                  type="button"
                  id="signature-image-clear"
                  class="entry-inline-btn"
                  style="background: #6c757d"
                >
                  Clear Image
                </button>
              </div>
              <img
                id="signature-image-preview"
                class="thumb"
                alt="Signature image preview"
              />
            </div>
          </div>
          <div class="entry-actions">
            <button type="submit" class="entry-btn">üíæ Save Entry</button>
            <button
              type="button"
              class="entry-btn secondary"
              onclick="closeOwnerEntryModal()"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Saved Entries Modal -->
    <div
      id="ownerEntriesModal"
      class="owner-entry-modal"
      onclick="if(event.target===this) closeOwnerEntriesModal();"
    >
      <div class="owner-entry-content">
        <div class="owner-entry-header">
          <div class="owner-entry-title">üóÇ Saved Entries</div>
          <span class="close-owner-entry" onclick="closeOwnerEntriesModal()"
            >&times;</span
          >
        </div>
        <div id="ownerEntriesList"></div>
      </div>
    </div>

    <!-- ===================== Create Building Modal ===================== -->
    <div
      id="buildingCreateModal"
      class="owner-entry-modal"
      onclick="if(event.target===this) closeBuildingCreateModal();"
    >
      <div class="owner-entry-content" style="max-width: 520px">
        <div class="owner-entry-header">
          <div class="owner-entry-title">üèóÔ∏è Create Building</div>
          <span class="close-owner-entry" onclick="closeBuildingCreateModal()"
            >&times;</span
          >
        </div>
        <div class="entry-section">
          <div class="entry-grid">
            <div class="entry-item">
              <label>PROPERTY ID</label>
              <input id="bc-property-id" readonly />
            </div>
            <div class="entry-item">
              <label>BUILDING NAME</label>
              <input id="bc-building-name" placeholder="Building Name" />
            </div>
            <div class="entry-item">
              <label>BUILDING TYPE</label>
              <select id="bc-building-type">
                <option>Standard</option>
                <option>Residential</option>
                <option>Commercial</option>
                <option>Office</option>
                <option>Mixed Use</option>
              </select>
            </div>
            <div class="entry-item">
              <label>NO. OF FLOORS</label>
              <input id="bc-floors" type="number" min="1" value="5" />
            </div>
            <div class="entry-item">
              <label>FLOOR HEIGHT (m)</label>
              <input
                id="bc-floor-height"
                type="number"
                min="1"
                step="0.1"
                value="3"
              />
            </div>
          </div>
        </div>
        <div class="entry-actions">
          <button class="entry-btn" onclick="createBuildingFromDrawn()">
            Create
          </button>
          <button
            class="entry-btn secondary"
            onclick="closeBuildingCreateModal()"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- ===================== Edit Building Modal ===================== -->
    <div
      id="buildingEditModal"
      class="owner-entry-modal"
      onclick="if(event.target===this) closeBuildingEditModal();"
    >
      <div class="owner-entry-content" style="max-width: 520px">
        <div class="owner-entry-header">
          <div class="owner-entry-title">‚úèÔ∏è Edit Building</div>
          <span class="close-owner-entry" onclick="closeBuildingEditModal()"
            >&times;</span
          >
        </div>
        <div class="entry-section">
          <div class="entry-grid">
            <div class="entry-item">
              <label>BID</label><input id="be-bid" readonly />
            </div>
            <div class="entry-item">
              <label>BUILDING NAME</label><input id="be-building-name" />
            </div>
            <div class="entry-item">
              <label>BUILDING TYPE</label
              ><select id="be-building-type">
                <option>Standard</option>
                <option>Residential</option>
                <option>Commercial</option>
                <option>Office</option>
                <option>Mixed Use</option>
              </select>
            </div>
            <div class="entry-item">
              <label>NO. OF FLOORS</label
              ><input id="be-floors" type="number" min="1" />
            </div>
            <div class="entry-item">
              <label>FLOOR HEIGHT (m)</label
              ><input id="be-floor-height" type="number" min="1" step="0.1" />
            </div>
          </div>
        </div>
        <div class="entry-actions">
          <button class="entry-btn" onclick="saveBuildingEdits()">Save</button>
          <button
            id="openCommonFloorDesignerBtn"
            onclick="openCommonFloorDesigner()"
            style="
              background: #0d6efd;
              color: white;
              padding: 8px 12px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
            "
          >
            üè¢ Building Floor Design
          </button>
          <button
            class="entry-btn secondary"
            onclick="closeBuildingEditModal()"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
    <!-- ===================== Floor Layout Designer Modal ===================== -->
    <div id="floorLayoutDesignerModal" class="floor-designer-modal">
      <div class="floor-designer-content">
        <div class="floor-designer-header">
          <div class="floor-designer-title">üé® Floor Layout Designer</div>
          <div
            class="close-floor-designer"
            onclick="closeFloorLayoutDesigner()"
          >
            &times;
          </div>
        </div>

        <div class="floor-designer-body">
          <!-- Toolbar -->
          <div class="floor-designer-toolbar">
            <div class="toolbar-section">
              <h4>Grid Settings</h4>
              <div class="grid-controls">
                <input
                  type="number"
                  id="grid-cols"
                  value="10"
                  min="5"
                  max="20"
                  placeholder="Columns"
                />
                <input
                  type="number"
                  id="grid-rows"
                  value="10"
                  min="5"
                  max="20"
                  placeholder="Rows"
                />
              </div>
              <button class="toolbar-btn" onclick="updateGrid()">
                Update Grid
              </button>
              <button class="toolbar-btn secondary" onclick="clearGrid()">
                Clear Grid
              </button>
            </div>

            <div class="toolbar-section">
              <h4>Room Types</h4>
              <div class="room-type-selector">
                <button
                  class="room-type-btn office"
                  onclick="selectRoomType('office')"
                >
                  Office
                </button>
                <button
                  class="room-type-btn meeting"
                  onclick="selectRoomType('meeting')"
                >
                  Meeting
                </button>
                <button
                  class="room-type-btn lobby"
                  onclick="selectRoomType('lobby')"
                >
                  Lobby
                </button>
                <button
                  class="room-type-btn reception"
                  onclick="selectRoomType('reception')"
                >
                  Reception
                </button>
                <button
                  class="room-type-btn elevator"
                  onclick="selectRoomType('elevator')"
                >
                  Elevator
                </button>
                <button
                  class="room-type-btn stairs"
                  onclick="selectRoomType('stairs')"
                >
                  Stairs
                </button>
                <button
                  class="room-type-btn bathroom"
                  onclick="selectRoomType('bathroom')"
                >
                  Bathroom
                </button>
                <button
                  class="room-type-btn kitchen"
                  onclick="selectRoomType('kitchen')"
                >
                  Kitchen
                </button>
                <button
                  class="room-type-btn waiting"
                  onclick="selectRoomType('waiting')"
                >
                  Waiting
                </button>
                <button
                  class="room-type-btn security"
                  onclick="selectRoomType('security')"
                >
                  Security
                </button>
                <button
                  class="room-type-btn storage"
                  onclick="selectRoomType('storage')"
                >
                  Storage
                </button>
                <button
                  class="room-type-btn breakroom"
                  onclick="selectRoomType('breakroom')"
                >
                  Break Room
                </button>
                <button
                  class="room-type-btn utility"
                  onclick="selectRoomType('utility')"
                >
                  Utility
                </button>
                <button
                  class="room-type-btn pantry"
                  onclick="selectRoomType('pantry')"
                >
                  Pantry
                </button>
                <button
                  class="room-type-btn gym"
                  onclick="selectRoomType('gym')"
                >
                  Gym
                </button>
                <button
                  class="room-type-btn lounge"
                  onclick="selectRoomType('lounge')"
                >
                  Lounge
                </button>
                <button
                  class="room-type-btn shower"
                  onclick="selectRoomType('shower')"
                >
                  Shower
                </button>
                <button
                  class="room-type-btn executive"
                  onclick="selectRoomType('executive')"
                >
                  Executive
                </button>
                <button
                  class="room-type-btn boardroom"
                  onclick="selectRoomType('boardroom')"
                >
                  Boardroom
                </button>
                <button
                  class="room-type-btn penthouse"
                  onclick="selectRoomType('penthouse')"
                >
                  Penthouse
                </button>
                <button
                  class="room-type-btn bedroom"
                  onclick="selectRoomType('bedroom')"
                >
                  Bedroom
                </button>
                <button
                  class="room-type-btn dining"
                  onclick="selectRoomType('dining')"
                >
                  Dining
                </button>
                <button
                  class="room-type-btn terrace"
                  onclick="selectRoomType('terrace')"
                >
                  Terrace
                </button>
                <button
                  class="room-type-btn custom"
                  onclick="selectRoomType('custom')"
                >
                  Custom
                </button>
              </div>
            </div>

            <div class="toolbar-section">
              <h4>Tools</h4>
              <button class="toolbar-btn" onclick="setTool('select')">
                Select
              </button>
              <button class="toolbar-btn" onclick="setTool('create')">
                Create Room
              </button>
              <button class="toolbar-btn" onclick="setTool('resize')">
                Resize
              </button>
              <button class="toolbar-btn danger" onclick="deleteSelectedRoom()">
                Delete Room
              </button>
            </div>

            <div class="toolbar-section">
              <h4>Room Properties</h4>
              <div class="room-properties">
                <label>Room Name:</label>
                <input
                  type="text"
                  id="room-name-input"
                  placeholder="Enter room name"
                />
                <label style="margin-top: 6px">Room Size (cells):</label>
                <div class="grid-controls" style="margin-top: 4px">
                  <input
                    id="room-size-w"
                    type="number"
                    min="1"
                    placeholder="Width"
                  />
                  <input
                    id="room-size-h"
                    type="number"
                    min="1"
                    placeholder="Height"
                  />
                </div>
                <label>Room Position (grid):</label>
                <div class="grid-controls" style="margin-top: 4px">
                  <input
                    id="room-pos-x"
                    type="number"
                    min="0"
                    placeholder="X"
                  />
                  <input
                    id="room-pos-y"
                    type="number"
                    min="0"
                    placeholder="Y"
                  />
                </div>

                <label>Custom Type (if Custom selected):</label>
                <input
                  type="text"
                  id="custom-room-type"
                  placeholder="Enter custom type"
                />
                <label>Notes:</label>
                <textarea
                  id="room-notes"
                  rows="3"
                  placeholder="Additional notes..."
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Canvas Container -->
          <div class="floor-designer-canvas-container">
            <div class="canvas-toolbar">
              <h4>Tools</h4>
              <br />
              <button
                id="tool-select"
                class="active"
                onclick="setTool('select')"
              >
                Select
              </button>
              <button id="tool-create" onclick="setTool('create')">
                Create
              </button>
              <button id="tool-resize" onclick="setTool('resize')">
                Resize
              </button>
              <button class="toolbar-btn danger" onclick="deleteSelectedRoom()">
                Delete Room
              </button>
              <button onclick="undoAction()">Undo</button>
              <button onclick="redoAction()">Redo</button>
              <span style="margin-left: auto; font-size: 12px; color: #6c757d">
                Current Tool: <span id="current-tool">Select</span>
              </span>
            </div>

            <div class="floor-designer-canvas" id="floorDesignerCanvas">
              <!-- Grid and rooms will be rendered here -->
            </div>
          </div>
        </div>

        <div class="floor-designer-footer">
          <div>
            <button class="clear-btn" onclick="clearAllRooms()">
              Clear All
            </button>
            <button class="cancel-btn" onclick="closeFloorLayoutDesigner()">
              Cancel
            </button>
          </div>
          <div>
            <button class="save-btn" onclick="saveFloorLayout()">
              Save Layout
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===================== ULPIN Geneator =====================
      function toBase(num, base, pad, replace = true) {
        let str = num.toString(base).toUpperCase().padStart(pad, "0");
        if (replace) {
          str = str.replace(/I/g, "Y").replace(/O/g, "Z");
        }
        return str;
      }

      function ulpinGenerator(longitude, latitude, floor = 0) {
        try {
          let lat = latitude.toString();
          let [latInt, latDec = ""] = lat.split(".");
          latInt = latInt.padStart(3, "0");
          latDec = latDec.padEnd(6, "0");

          let lat1 = parseInt(latInt) + 90;
          let slat1 = toBase(lat1, 14, 2);

          let lat2 = parseInt(latDec.substring(0, 3));
          let slat2 = toBase(lat2, 32, 2);

          let lat3 = parseInt(latDec.substring(3, 6));
          let slat3 = toBase(lat3, 32, 2);

          let lon = longitude.toString();
          let [lonInt, lonDec = ""] = lon.split(".");
          lonInt = lonInt.padStart(3, "0");
          lonDec = lonDec.padEnd(6, "0");

          let lon1 = parseInt(lonInt) + 180;
          let slon1 = toBase(lon1, 19, 2);

          let lon2 = parseInt(lonDec.substring(0, 3));
          let slon2 = toBase(lon2, 32, 2);

          let lon3 = parseInt(lonDec.substring(3, 6));
          let slon3 = toBase(lon3, 32, 2);

          let f1 = floor + 578;
          let f2 = toBase(f1, 34, 2);

          return slat1 + slat2 + slat3 + slon1 + slon2 + slon3 + f2;
        } catch (err) {
          console.error("Error generating ULPIN:", err);
          return null;
        }
      }

      // ===================== KML FILE DOWNLOAD CODE =====================
      function downloadKmlForBuildingFloor(BID, floor) {
        if (!userFloorLayers?.features?.length) {
          alert("No floor layers loaded!");
          return;
        }

        const buildingFloors = userFloorLayers.features
          .filter((f) => f.properties.BID == BID)
          .sort(
            (a, b) => (a.properties.floor ?? 0) - (b.properties.floor ?? 0)
          );

        if (!buildingFloors.length) {
          alert("No floors found for this building!");
          return;
        }

        const building = userBuildings.features.find(
          (f) => f.properties.BID == BID
        );

        if (!building) {
          alert("Building details missing!");
          return;
        }

        const p = building.properties;
        const centroid = turf.centroid(building).geometry.coordinates;
        const lon = centroid[0];
        const lat = centroid[1];

        const selectedFloor =
          buildingFloors.find((f) => f.properties.floor == floor) ||
          buildingFloors[0];
        const selectedPniu = ulpinGenerator(
          lon,
          lat,
          ulpinFloorIndex(selectedFloor.properties.floor)
        );

        const floorPlacemarks = buildingFloors
          .map((floorFeature) => {
            const coords = floorFeature.geometry.coordinates[0] || [];
            const coordText = coords
              .map((c) => `${c[0]},${c[1]},${floorFeature.properties.top || 0}`)
              .join(" ");
            const floorNumber = floorFeature.properties.floor;
            const base = floorFeature.properties.base || 0;
            const top = floorFeature.properties.top || 0;
            const localPniu = ulpinGenerator(
              lon,
              lat,
              ulpinFloorIndex(floorNumber)
            );

            return `
    <Placemark>
      <name>Floor ${floorNumber}</name>
      <ExtendedData>
        <Data name="Floor_Number"><value>${floorNumber}</value></Data>
        <Data name="Base_Elevation"><value>${base}</value></Data>
        <Data name="Top_Elevation"><value>${top}</value></Data>
        <Data name="ULPIN"><value>${localPniu}</value></Data>
      </ExtendedData>
      <Style>
        <PolyStyle>
          <color>${floorNumber == floor ? "ff0077ff" : "7fff0000"}</color>
        </PolyStyle>
        <LineStyle>
          <width>1.5</width>
        </LineStyle>
      </Style>
      <Polygon>
        <extrude>1</extrude>
        <altitudeMode>absolute</altitudeMode>
        <outerBoundaryIs>
          <LinearRing>
            <coordinates>
              ${coordText}
            </coordinates>
          </LinearRing>
        </outerBoundaryIs>
      </Polygon>
    </Placemark>`.trim();
          })
          .join("\n");

        const floorList = buildingFloors
          .map((f) => f.properties.floor)
          .join(", ");

        const kml = `
<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
  <name>Building ${BID} - Floors</name>

  <ExtendedData>
    <Data name="Building_Name"><value>${p.NAME || ""}</value></Data>
    <Data name="Building_Type"><value>${p.building_type || ""}</value></Data>
    <Data name="Floors"><value>${p.floors}</value></Data>
    <Data name="Height"><value>${p.height}</value></Data>
    <Data name="Village"><value>${p.village || ""}</value></Data>
    <Data name="Subdivision"><value>${p.subdivision || ""}</value></Data>
    <Data name="District"><value>${p.district || ""}</value></Data>
    <Data name="Parcel_Type"><value>${p.parcel_type || ""}</value></Data>
    <Data name="Parcel_Sub_Type"><value>${p.parcel_subtype || ""}</value></Data>
    <Data name="Original_ID"><value>${p.original_id || ""}</value></Data>
    <Data name="All_Floors"><value>${floorList}</value></Data>
    <Data name="Selected_Floor"><value>${
      selectedFloor.properties.floor
    }</value></Data>
    <Data name="Selected_ULPIN"><value>${selectedPniu}</value></Data>
  </ExtendedData>

  <Folder>
    <name>Floors</name>
${floorPlacemarks}
  </Folder>

</Document>
</kml>
  `.trim();

        const blob = new Blob([kml], {
          type: "application/vnd.google-earth.kml+xml",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        a.href = url;
        a.download = `${p.NAME}_Building_Floors.kml`;
        a.click();

        URL.revokeObjectURL(url);

        // Open in Google Earth Web directly
        // const earthUrl = `https://earth.google.com/web/?url=${encodeURIComponent(
        //   url
        // )}`;
        // window.open(earthUrl, "_blank");

        // setTimeout(() => URL.revokeObjectURL(url), 5000);
      }

      function getFloorComparable(v) {
        if (v === "G" || v === 0 || v === "0") return 1; // Floor 'G' is stored as 1
        return Number(v);
      }
      function downloadKmlForFloor(BID, floor) {
        const floorComparable = getFloorComparable(floor);
        const floorFeature = userFloorLayers.features.find(
          (f) =>
            f.properties.BID == BID &&
            getFloorComparable(f.properties.floor) === floorComparable
        );

        if (!floorFeature) {
          alert("Floor polygon not found!");
          return;
        }

        const coords = floorFeature.geometry.coordinates[0] || [];
        const base = floorFeature.properties.base || 0;
        const top = floorFeature.properties.top || 0;
        const height = Math.max(0, top - base);
        const roofAltitude = top || base;

        // Get building info
        const building = userBuildings.features.find(
          (f) => f.properties.BID == BID
        );

        if (!building) {
          alert("Building details missing!");
          return;
        }

        const p = building.properties;

        const centroid = turf.centroid(building).geometry.coordinates;
        const lon = centroid[0];
        const lat = centroid[1];

        // Generate ULPIN for this floor
        const ulpin = ulpinGenerator(lon, lat, ulpinFloorIndex(floor));

        if (coords.length < 3) {
          alert("Invalid floor polygon!");
          return;
        }

        const closedCoords = [...coords];
        const first = closedCoords[0];
        const last = closedCoords[closedCoords.length - 1];

        if (first[0] !== last[0] || first[1] !== last[1]) {
          closedCoords.push([...first]);
        }

        const floorRing = closedCoords
          .map((c) => `${c[0]},${c[1]},${roofAltitude}`)
          .join("\n                  ");

        // -----------------------------------------
        // BUILD KML FILE WITH ONLY THE FLOOR
        // -----------------------------------------

        const kml = `
      <?xml version="1.0" encoding="UTF-8"?>
      <kml xmlns="http://www.opengis.net/kml/2.2"
           xmlns:gx="http://www.google.com/kml/ext/2.2">
      <Document>
        <name>Building ${BID} - Floor ${floor}</name>

        <ExtendedData>
          <Data name="Building_Name"><value>${p.NAME || ""}</value></Data>
          <Data name="Building_Type"><value>${
            p.building_type || ""
          }</value></Data>
          <Data name="Floors"><value>${p.floors}</value></Data>
          <Data name="Height"><value>${p.height}</value></Data>
          <Data name="Village"><value>${p.village || ""}</value></Data>
          <Data name="Subdivision"><value>${p.subdivision || ""}</value></Data>
          <Data name="District"><value>${p.district || ""}</value></Data>
          <Data name="Parcel_Type"><value>${p.parcel_type || ""}</value></Data>
          <Data name="Parcel_Sub_Type"><value>${
            p.parcel_subtype || ""
          }</value></Data>
          <Data name="Original_ID"><value>${p.original_id || ""}</value></Data>
          <Data name="ULPIN"><value>${ulpin}</value></Data>
          <Data name="Selected_Floor"><value>${floor}</value></Data>
          <Data name="Base_Elevation"><value>${base}</value></Data>
          <Data name="Top_Elevation"><value>${top}</value></Data>
          <Data name="Floor_Height"><value>${height}</value></Data>
        </ExtendedData>

        <Placemark>
          <name>Floor ${floor}</name>
          <Style>
            <PolyStyle>
              <color>cc00ffff</color>
            </PolyStyle>
            <LineStyle>
              <width>1.5</width>
            </LineStyle>
          </Style>

          <Polygon>
            <extrude>0</extrude>
            <tessellate>0</tessellate>
            <altitudeMode>absolute</altitudeMode>
            <gx:altitudeMode>absolute</gx:altitudeMode>
            <outerBoundaryIs>
              <LinearRing>
                <coordinates>
                  ${floorRing}
                </coordinates>
              </LinearRing>
            </outerBoundaryIs>
          </Polygon>
        </Placemark>

        <Placemark>
          <name>ULPIN: ${ulpin}</name>
          <description>
            <![CDATA[
              <table>
                <tr><td><b>ULPIN:</b></td><td>${ulpin}</td></tr>
                <tr><td><b>Building:</b></td><td>${
                  p.NAME || `Building ${BID}`
                }</td></tr>
                <tr><td><b>Floor:</b></td><td>${floor}</td></tr>
                <tr><td><b>Building ID:</b></td><td>${BID}</td></tr>
              </table>
            ]]>
          </description>
          <Point>
            <altitudeMode>absolute</altitudeMode>
            <gx:altitudeMode>absolute</gx:altitudeMode>
            <coordinates>${lon},${lat},${roofAltitude}</coordinates>
          </Point>
          <Style>
            <IconStyle>
              <Icon>
                <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
              </Icon>
              <scale>1.2</scale>
            </IconStyle>
            <LabelStyle>
              <scale>1.2</scale>
            </LabelStyle>
          </Style>
        </Placemark>

      </Document>
      </kml>
        `.trim();

        // -----------------------------------------
        // DOWNLOAD FUNCTION
        // -----------------------------------------
        const blob = new Blob([kml], {
          type: "application/vnd.google-earth.kml+xml",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        a.href = url;
        a.download = `${p.NAME}_Floor_${floor}.kml`;
        a.click();

        URL.revokeObjectURL(url);
      }

      function downloadKMLForPlot() {
        if (!window.selectedParcelFeature) {
          alert("No plot selected");
          return;
        }
        const geom = selectedParcelFeature.geometry;
        const p = selectedParcelFeature.properties || {};
        const coords = geom.type === "Polygon" ? geom.coordinates[0] : [];
        if (!coords.length) {
          alert("Plot geometry not found!");
          return;
        }
        // KML coordinate string
        const plotRing = coords
          .map((c) => `${c[0]},${c[1]},0`)
          .join("\n                  ");
        // Calculate centroid for placing a marker
        const centroid = turf.centroid(selectedParcelFeature).geometry
          .coordinates;
        const lon = centroid[0],
          lat = centroid[1];
        // KML
        const kml = `
    <?xml version="1.0" encoding="UTF-8"?>
    <kml xmlns="http://www.opengis.net/kml/2.2"
         xmlns:gx="http://www.google.com/kml/ext/2.2">
    <Document>
      <name>Plot ${p.IDS || p.TYPE || ""}</name>
      <ExtendedData>
        <Data name="Khasra_ID"><value>${p.IDS || ""}</value></Data>
        <Data name="Type"><value>${p.TYPE || ""}</value></Data>
        <Data name="Sub_Type"><value>${p.SUB_TYPE || ""}</value></Data>
        <Data name="Village"><value>${p.VILL_NM || ""}</value></Data>
        <Data name="Subdivision"><value>${p.SUBDIV_NM || ""}</value></Data>
        <Data name="District"><value>${p.DIST_NM || ""}</value></Data>
        <Data name="Area"><value>${p.Shape_Area || 0}</value></Data>
        <Data name="Perimeter"><value>${p.Shape_Leng || 0}</value></Data>
        <Data name="ULPIN"><value>${
          window.ulpinGenerator ? ulpinGenerator(lon, lat, 0) : ""
        }</value></Data>
      </ExtendedData>
      <Placemark>
        <name>Plot</name>
        <Polygon>
          <extrude>0</extrude>
          <tessellate>0</tessellate>
          <altitudeMode>relativeToGround</altitudeMode>
          <outerBoundaryIs>
            <LinearRing>
              <coordinates>
                ${plotRing}
              </coordinates>
            </LinearRing>
          </outerBoundaryIs>
        </Polygon>
      </Placemark>
      <Placemark>
        <name>ULPIN</name>
        <description>
          <![CDATA[
            <b>ULPIN:</b> ${
              window.ulpinGenerator ? ulpinGenerator(lon, lat, 0) : ""
            }<br/>
            <b>Khasra:</b> ${p.IDS || ""}
          ]]>
        </description>
        <Point>
          <coordinates>${lon},${lat},0</coordinates>
        </Point>
      </Placemark>
    </Document>
    </kml>
  `.trim();
        const blob = new Blob([kml], {
          type: "application/vnd.google-earth.kml+xml",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${p.IDS || p.TYPE || "plot"}.kml`;
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
